<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WallyTracker">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Wally Dashboard</title>

    <style>
        :root {
            --primary: #000000;
            --bg: #ffffff;
            --card-bg: #f9f9f9;
            --text-main: #000000;
            --text-sub: #8e8e93;
            --safe-top: max(env(safe-area-inset-top), 47px);
            --safe-bottom: env(safe-area-inset-bottom);
            --tab-height: 80px;
            --bay-green: #4cd964;
            --bay-purple: #bf5af2;
            --bay-orange: #ff9500;
            --bay-red: #ff3b30;
        }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            -webkit-font-smoothing: antialiased;
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: calc(var(--safe-top) + 10px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 0 20px;
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 20px);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content.active { display: block; }

        /* --- DASHBOARD HEADER --- */
        .dash-top-bar {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }
        .dash-title { font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
        .dash-subtitle { font-size: 13px; color: var(--text-sub); margin-top: 2px; font-weight: 500; }
        
        /* --- TODAY CARD --- */
        .today-card {
            background: #fff;
            border: 1px solid #e5e5ea;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .today-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .today-title { font-size: 16px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .today-empty { font-size: 13px; color: #999; text-align: center; padding: 10px 0; font-style: italic; }
        
        .focus-list { display: flex; flex-direction: column; gap: 10px; }
        .focus-item { 
            display: flex; align-items: center; gap: 10px; 
            padding-bottom: 10px; border-bottom: 1px solid #f2f2f7; 
        }
        .focus-item:last-child { border-bottom: none; padding-bottom: 0; }
        
        .focus-check { 
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #e5e5ea; 
            display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; flex-shrink: 0;
        }
        .focus-item.done .focus-check { background: #000; border-color: #000; }
        .focus-content { flex-grow: 1; }
        .focus-type { font-size: 11px; font-weight: 800; color: #8e8e93; text-transform: uppercase; }
        .focus-select { 
            width: 100%; border: none; background: transparent; font-size: 15px; font-weight: 600; color: #000; 
            padding: 2px 0; outline: none; -webkit-appearance: none; 
        }
        .focus-custom-input { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 4px; font-size: 14px; margin-top: 2px; display: none; }

        /* --- ACTION ROW (2 Cols) --- */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .action-card {
            background: #f2f2f7; border-radius: 16px; padding: 12px;
            display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.1s; border: 1px solid #e5e5ea;
        }
        .action-card:active { transform: scale(0.96); background: #e5e5ea; }
        .action-card i { font-size: 20px; color: #000; }
        .action-label { font-size: 14px; font-weight: 700; }
        .action-card.primary { background: #000; color: white; border: none; }
        .action-card.primary i { color: white; }
        .action-card.danger { background: #ffe5e5; color: #ff3b30; border-color: #ff3b30; }
        .action-card.danger i { color: #ff3b30; }

        /* --- STATS GRID (TIGHT 2x2) --- */
        .section-header { font-size: 15px; font-weight: 800; margin-bottom: 10px; color: #000; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.6; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .stat-card {
            background: #fff; border: 1px solid #e5e5ea; border-radius: 16px; padding: 12px 15px;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02); cursor: pointer;
        }
        .stat-card:active { transform: scale(0.98); background: #f9f9f9; }
        .stat-label { font-size: 11px; color: #8e8e93; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-size: 28px; font-weight: 900; color: #000; line-height: 1; }

        /* --- BAYS GRID --- */
        .bays-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; }
        .empty-state-text { color: var(--text-sub); font-size: 16px; font-weight: 500; text-align: center; width: 100%; padding: 20px 0; }

        .bay-circle {
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 800; color: #000;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative; box-sizing: border-box;
        }
        .bay-circle:active { transform: scale(0.92); }
        .bay-circle.unavailable { background-color: #8e8e93 !important; opacity: 0.5; color: #666; border: none !important; }
        .bay-circle.unavailable .bay-timer { color: #666; }
        .bay-circle.status-ok { border: 4px solid #34c759; }
        .bay-circle.status-warn { border: 4px solid #ff9500; }
        .bay-circle.status-crit { border: 4px solid #ff3b30; }

        .bay-9 { background-color: var(--bay-green); }
        .bay-10 { background-color: var(--bay-purple); }
        .bay-11 { background-color: var(--bay-orange); }
        .bay-12 { background-color: var(--bay-purple); }
        .bay-13 { background-color: var(--bay-orange); }
        .bay-14 { background-color: var(--bay-orange); }
        .bay-15 { background-color: var(--bay-orange); }
        .bay-16 { background-color: var(--bay-orange); }

        .type-badge {
            position: absolute; bottom: -2px; right: -2px;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: white;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .badge-w, .badge-c { background-color: #000; }
        .bay-timer {
            position: absolute; bottom: -5px; font-size: 9px; font-weight: 700;
            color: #000; background: rgba(255, 255, 255, 0.9);
            padding: 1px 4px; border-radius: 4px; min-width: 20px; text-align: center;
        }

        /* --- COMMON UI --- */
        .header-bar { position: relative; display: flex; justify-content: center; align-items: center; height: 50px; margin: 20px 0 20px 0; }
        .header-bar h1 { font-size: 24px; font-weight: 800; margin: 0; }
        .header-right { position: absolute; right: 0; display: flex; gap: 10px; }
        .filter-icon-btn, .export-icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: background 0.1s; }
        .filter-icon-btn { border: 2px solid #000; background: transparent; color: #000; }
        .export-icon-btn { border: none; background: #f2f2f7; color: #000; }

        /* --- STAFFING --- */
        .staffing-header-card { background: #000; color: #fff; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .staffing-header-title { font-size: 14px; opacity: 0.8; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .staffing-header-val { font-size: 32px; font-weight: 800; }
        .dop-container { margin-bottom: 20px; background: #fff; border: 1px solid #e5e5ea; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .dop-row { display: flex; justify-content: space-between; align-items: center; }
        .dop-label { font-size: 14px; font-weight: 700; color: #000; }
        .dop-select { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; }
        .dop-status { font-size: 13px; font-weight: 600; padding: 8px 12px; border-radius: 8px; text-align: center; }
        .dop-ok { background: #d1fae5; color: #065f46; }
        .dop-warn { background: #fee2e2; color: #991b1b; }
        .dop-over { background: #e0f2fe; color: #0369a1; }
        .staff-card { background: white; border: 1px solid #e5e5ea; border-radius: 18px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); transition: all 0.3s ease; }
        .staff-card.cut { opacity: 0.6; background: #f9f9f9; }
        .staff-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .staff-name { font-size: 17px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 6px; }
        .staff-time { font-size: 13px; color: var(--text-sub); margin-top: 2px; }
        .staff-hours { font-size: 16px; font-weight: 800; color: #000; font-variant-numeric: tabular-nums; }
        .staff-action-btn { background: #ffe5e5; color: #ff3b30; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; }
        .role-select { width: 100%; padding: 8px; background: #f2f2f7; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: #000; margin-top: 4px; outline: none; }
        .breakdown-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        .staff-checkbox-list { max-height: 250px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; background: #f9f9f9; padding: 5px; }
        .staff-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid #e5e5ea; }
        .staff-item-row:last-child { border-bottom: none; }
        .staff-check-label { display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; font-size: 16px; font-weight: 500; }
        .staff-check-label input { width: 20px; height: 20px; accent-color: #000; }
        .staff-role-select { background: #f2f2f7; border: none; padding: 8px; border-radius: 8px; font-size: 13px; font-weight: 600; width: 110px; color: #000; }
        .staff-other-input { background: #fff; border: 1px solid #000; padding: 8px; border-radius: 8px; font-size: 13px; width: 100px; color: #000; margin-left: 5px; display: none; }
        .staff-section-title { font-size: 18px; font-weight: 800; margin: 25px 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .staff-count-badge { background: #e5e5ea; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px; }

        /* Loaned Staff Styling */
        .loaned-card { background: #fff; border: 1px dashed #ccc; border-radius: 18px; padding: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center; }
        .loan-dest-pill { background: #e5e5ea; color: #555; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-left: 6px; }

        /* --- LOGS --- */
        .log-card { background: white; border: 1px solid #e5e5ea; border-radius: 20px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .log-info { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-width: 0; }
        .log-header-row { display: flex; align-items: center; gap: 10px; }
        .log-door-pill { background: #000; color: #fff; font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 8px; cursor: pointer; flex-shrink: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .log-title { font-size: 20px; font-weight: 900; color: #000; line-height: 1; letter-spacing: -0.5px; }
        .log-account { color: #8e8e93; font-weight: 500; font-size: 14px; margin-left: 6px; }
        .log-tags-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .log-tag { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 6px; background: #f2f2f7; color: #000; display: inline-flex; align-items: center; gap: 4px; }
        .tag-black { background: #000; color: white; }
        .tag-red { background: #ff3b30; color: white; }
        .tag-gray { background: #e5e5ea; color: #555; }
        .log-footer-row { display: flex; align-items: center; gap: 15px; color: var(--text-sub); font-size: 13px; font-weight: 500; margin-top: 2px; }
        .log-footer-item { display: flex; align-items: center; gap: 5px; }
        .log-footer-item i { font-size: 16px; color: #000; }
        .log-right-col { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; min-width: 90px; }
        .log-duration { font-size: 24px; font-weight: 900; color: #000; line-height: 1; }
        .log-duration-label { font-size: 10px; text-transform: uppercase; color: #8e8e93; font-weight: 700; margin-top: 2px; }
        .log-actions-row { display: flex; gap: 8px; }
        .log-mini-btn { width: 36px; height: 36px; border-radius: 12px; border: 1px solid #e5e5ea; background: white; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #000; cursor: pointer; transition: all 0.1s; }
        .log-mini-btn:active { background: #f2f2f7; transform: scale(0.95); }
        .stats-collapse-btn { width: 100%; background: #f2f2f7; border: none; border-radius: 16px; padding: 18px; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 700; color: #000; cursor: pointer; margin-bottom: 20px; }
        .stats-content-area { background: white; border: 1px solid #e5e5ea; border-radius: 16px; padding: 20px; margin-bottom: 25px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .stats-table th { text-align: left; color: var(--text-sub); font-weight: 600; padding-bottom: 12px; border-bottom: 1px solid #e5e5ea; }
        .stats-table td { padding: 12px 0; border-bottom: 1px solid #f9f9f9; color: #000; font-weight: 500; }
        .stats-table td:last-child { font-weight: 800; text-align: right; }
        .search-bar { width: 100%; padding: 14px; border: 1px solid #e5e5ea; border-radius: 12px; background: #f9f9f9; font-size: 16px; margin-bottom: 20px; outline: none; }
        .active-filter-display { display: flex; align-items: center; justify-content: space-between; background: #000; color: white; padding: 12px 20px; border-radius: 16px; margin-bottom: 20px; font-weight: 600; }

        /* --- SETTINGS & TOOLS --- */
        .settings-header { font-size: 22px; font-weight: 800; margin: 30px 0 10px 0; color: #000; }
        .settings-group { background: #fff; border-radius: 16px; overflow: hidden; margin-bottom: 20px; border: 1px solid #e5e5ea; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f2f2f7; background: #fff; }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { font-size: 16px; font-weight: 600; color: #000; }
        .settings-input-inline { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 8px; font-size: 16px; width: 100px; text-align: right; }
        .settings-btn-inline { background: #000; color: #fff; border: none; border-radius: 8px; padding: 6px 12px; font-weight: 600; font-size: 14px; }
        .toggle-switch { width: 50px; height: 30px; background: #e5e5ea; border-radius: 15px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle-switch.checked { background: #000; }
        .toggle-switch::after { content: ''; position: absolute; left: 2px; top: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; transition: left 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-switch.checked::after { left: 22px; }
        .settings-note { font-size: 13px; color: #8e8e93; padding: 0 10px; margin-bottom: 20px; line-height: 1.4; }

        /* --- NAV --- */
        .tab-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: white; border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: center; height: 70px; z-index: 1000; padding-bottom: 0; }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 11px; font-weight: 600; width: 60px; cursor: pointer; gap: 4px; position: relative; }
        .tab-btn i { font-size: 26px; }
        .tab-btn.active { color: #000; }
        .tab-badge { position: absolute; top: -4px; right: 0; background: #ff3b30; color: white; font-size: 10px; font-weight: 800; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid white; }
        .tab-badge.zero { background: #e5e5ea; color: #8e8e93; }
        .tab-badge.warning { background: #ff9500; }
        .tab-badge.success { background: #34c759; }

        .save-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; z-index: 3000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .save-toast.visible { opacity: 1; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; border-top-left-radius: 28px; border-top-right-radius: 28px; padding: 30px; padding-bottom: max(40px, var(--safe-bottom)); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .z-high { z-index: 3000 !important; }
        .form-input { width: 100%; padding: 18px; background: #f2f2f7; border: none; border-radius: 16px; font-size: 18px; margin-bottom: 15px; box-sizing: border-box; outline: none; appearance: none; color: #000; font-weight: 500; }
        .type-selector { display: flex; background: #f2f2f7; padding: 5px; border-radius: 16px; margin-bottom: 25px; }
        .type-opt { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; font-size: 15px; color: var(--text-sub); cursor: pointer; }
        .type-opt.selected { background: white; color: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-primary { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 17px; font-weight: 800; background: #000; color: white; margin-top: 10px; cursor: pointer; }
        .btn-danger { background: #ff3b30; }
        .btn-history { background: #f2f2f7; color: #000; margin-top: 10px; }
        .btn-cancel { background: transparent; color: var(--text-sub); width: 100%; padding: 15px; border: none; font-size: 16px; font-weight: 600; margin-top: 5px; cursor: pointer; }
        .options-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .option-toggle { flex: 1; position: relative; cursor: pointer; min-width: 80px; }
        .option-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
        .option-toggle span { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; background: #f2f2f7; color: #8e8e93; border-radius: 12px; font-weight: 700; font-size: 14px; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); border: 1px solid transparent; box-sizing: border-box; }
        .option-toggle input:checked ~ span { background: #000; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transform: translateY(-1px); }
        .option-toggle:active span { transform: scale(0.96); }
        
        /* TOOLS GRID */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 0; }
        .tool-card { background: #fff; border-radius: 24px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; aspect-ratio: 1 / 1; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; }
        .tool-card:active { transform: scale(0.96); background: #f9f9f9; }
        .tool-icon-wrapper { width: 50px; height: 50px; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; margin-bottom: 12px; }
        .tool-title { font-size: 16px; font-weight: 700; color: #000; margin-bottom: 4px; }
        .tool-card.add { border: 2px dashed #ccc; background: transparent; box-shadow: none; }
        .tool-card.add .tool-icon-wrapper { background: #e5e5ea; color: #000; }
        
        /* Slider */
        .settings-slider-container { display: flex; flex-direction: column; gap: 15px; padding: 15px 20px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-value { font-size: 16px; font-weight: 700; color: #000; background: #f2f2f7; padding: 4px 10px; border-radius: 8px; min-width: 60px; text-align: center; }
        .slider-wrapper { position: relative; width: 100%; height: 40px; display: flex; align-items: center; }
        .slider-track { position: absolute; width: 100%; height: 6px; background: #e5e5ea; border-radius: 3px; z-index: 1; }
        .slider-fill { position: absolute; height: 6px; background: #000; border-radius: 3px; z-index: 2; transition: width 0.1s; }
        .slider-thumb { position: absolute; width: 30px; height: 30px; background: #000; border-radius: 15px; z-index: 3; transform: translateX(-50%); box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; touch-action: none; }
        .slider-ticks { display: flex; justify-content: space-between; position: absolute; width: 100%; top: 25px; pointer-events: none; }
        .slider-tick { width: 1px; height: 8px; background: #ccc; position: relative; }
        .slider-tick-label { position: absolute; top: 12px; font-size: 11px; color: #8e8e93; transform: translateX(-50%); white-space: nowrap; font-weight: 600; }
        #restore-file-input { display: none; }
        
        /* CHECKLIST IN POST SORT */
        .checklist-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; cursor: pointer; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-box { width: 24px; height: 24px; border: 2px solid #e5e5ea; border-radius: 6px; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s; }
        .checklist-item.checked .checklist-box { background: #000; border-color: #000; }
        .checklist-label { font-size: 16px; font-weight: 600; color: #000; }
    </style>
</head>
<body>

<input type="file" id="restore-file-input" accept=".json" onchange="restoreData(this)">

<div id="save-toast" class="save-toast">
    <i class="ph ph-check-circle" style="color:#4cd964; font-size:16px;"></i>
    <span>Saved</span>
</div>

<div class="app-container">

    <div id="tab-dashboard" class="tab-content active">
        <div class="dash-top-bar">
            <h1 class="dash-title">Wally Dashboard</h1>
            <div class="dash-subtitle">by Fitz Joseph</div>
        </div>

        <div class="today-card">
            <div class="today-header">
                <div class="today-title"><i class="ph ph-check-square-offset"></i> Today's Focus</div>
            </div>
            
            <div id="today-focus-list" class="focus-list">
                <div class="today-empty">Configure in Tools</div>
            </div>
        </div>

        <div class="action-grid">
            <div class="action-card primary" onclick="openStartSortFlow()">
                <i class="ph ph-play-circle"></i>
                <span class="action-label">Start Sort</span>
            </div>
            <div class="action-card danger" onclick="openEndSortFlow()">
                <i class="ph ph-stop-circle"></i>
                <span class="action-label">End Sort</span>
            </div>
        </div>

        <div class="section-header" style="margin-bottom:10px;">Sort Statistics</div>
        <div class="stats-grid">
            <div class="stat-card" onclick="viewStatLogs('Wally')">
                <div class="stat-label">Total Wallies</div>
                <div class="stat-value" id="stat-total-wally">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('CPU')">
                <div class="stat-label">Total CPUs</div>
                <div class="stat-value" id="stat-total-cpu">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('Hour-0')">
                <div class="stat-label">This Hour</div>
                <div class="stat-value" id="stat-hour-wally">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('Hour-1')">
                <div class="stat-label">Last Hour</div>
                <div class="stat-value" id="stat-last-wally">0</div>
            </div>
        </div>

        <div class="section-header">Bay Overview</div>
        <div id="active-trailers-grid" class="bays-grid"></div>
        <div id="open-bays-grid" class="bays-grid"></div>
        <div style="height: 100px;"></div>
    </div>

    <div id="tab-active" class="tab-content">
        <div class="header-bar"><h1>Active Details</h1></div>
        <div id="active-tab-list" class="active-tab-list"></div>
    </div>

    <div id="tab-logs" class="tab-content">
        <div class="header-bar">
            <h1>Logs</h1>
            <div class="header-right">
                <button class="filter-icon-btn" onclick="openFilterModal()"><i class="ph ph-faders"></i></button>
                <button class="export-icon-btn" onclick="openExportModal()"><i class="ph ph-export"></i></button>
            </div>
        </div>

        <input type="text" id="log-search" class="search-bar" placeholder="Search by Wally ID or Trailer...">

        <button class="stats-collapse-btn" onclick="toggleStats('unloader')">
            Unloader Statistics <i class="ph ph-caret-down" id="stats-caret"></i>
        </button>
        <div id="stats-content" class="stats-content-area">
            <table class="stats-table">
                <thead><tr><th>Name</th><th style="text-align:center">Wally</th><th style="text-align:center">CPU</th><th style="text-align:right">Total</th></tr></thead>
                <tbody id="unloader-stats-body"></tbody>
            </table>
        </div>

        <button class="stats-collapse-btn" onclick="toggleStats('hourly')">
            Hourly Breakdown <i class="ph ph-caret-down" id="hourly-caret"></i>
        </button>
        <div id="hourly-content" class="stats-content-area">
            <table class="stats-table">
                <thead><tr><th>Hour</th><th style="text-align:center">Count</th></tr></thead>
                <tbody id="hourly-stats-body"></tbody>
            </table>
        </div>

        <div id="active-filter-display" class="active-filter-display" style="display:none;">
            <span>Filtering: <span id="filter-text-display"></span></span>
            <i class="ph ph-x" style="cursor:pointer" onclick="clearLogFilter()"></i>
        </div>

        <div id="logs-list" class="logs-list"></div>
        <button id="logs-load-more" class="load-more-btn" style="display:none" onclick="loadMoreLogs()">Load More</button>
    </div>

    <div id="tab-staffing" class="tab-content">
        <div class="header-bar">
            <h1>Staffing</h1>
            <div class="header-right">
                <button class="action-btn" style="padding: 10px 16px; border-radius:20px; height:40px; font-size:14px;" onclick="openAddStaffModal()"><i class="ph ph-plus"></i> Add</button>
            </div>
        </div>

        <div class="dop-container">
            <div class="dop-row">
                 <span class="dop-label">Daily Operating Plan</span>
                 <select id="dop-select" class="dop-select" onchange="saveDOP(this.value)">
                    <option value="5-2">5-2</option>
                    <option value="6-2">6-2</option>
                    <option value="7-2">7-2</option>
                    <option value="8-2">8-2</option>
                </select>
            </div>
            <div id="dop-status-bar" class="dop-status">Checking...</div>
        </div>

        <div class="staffing-header-card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><div class="staffing-header-title">Active Staff</div><div class="staffing-header-val" id="staff-active-count">0</div></div>
                <div style="text-align:right;"><div class="staffing-header-title">Unloader Hours</div><div class="staffing-header-val" id="staff-total-hours">0.0</div></div>
            </div>
            <div class="breakdown-row"><span>Belt Hours: <span id="staff-belt-hours">0.0</span></span><span>Sweep Hours: <span id="staff-sweep-hours">0.0</span></span></div>
        </div>

        <div class="staff-section-title">On Clock <span class="staff-count-badge" id="badge-on-clock">0</span></div>
        <div id="staff-list-active"></div>
        <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">Loaned Out <span class="staff-count-badge" id="badge-loaned">0</span></div>
        <div id="staff-list-loaned"></div>
        <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">Off Clock <span class="staff-count-badge" id="badge-off-clock">0</span></div>
        <div id="staff-list-cut"></div>
    </div>

    <div id="tab-tools" class="tab-content" style="background:#f2f2f7;">
        <div style="background:white; padding: 20px 20px 10px 20px; border-bottom:1px solid #e5e5ea; margin: -20px -20px 20px -20px;">
             <div class="header-bar" style="margin:0;"><h1>Tools</h1></div>
        </div>
        <div class="tools-grid">
             <div class="tool-card" onclick="openFocusConfigModal()">
                <div class="tool-icon-wrapper"><i class="ph ph-list-checks"></i></div><div class="tool-title">Plan Daily Focus</div>
            </div>
            <div class="tool-card" onclick="openPPHModal()">
                <div class="tool-icon-wrapper"><i class="ph ph-calculator"></i></div><div class="tool-title">PPH Calculator</div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content" style="background:#f2f2f7; padding:0;">
        <div style="background:white; padding: 20px 20px 10px 20px; border-bottom:1px solid #e5e5ea;">
            <div class="header-bar" style="margin:0;"><h1>Settings</h1></div>
        </div>
        <div style="padding: 20px 20px 120px 20px;">
            <div class="settings-header">Data Management</div>
            <div class="settings-group">
                <div class="settings-row" onclick="backupData('full')" style="cursor:pointer;"><span class="settings-label">Save Full Backup File</span><i class="ph ph-download-simple" style="color:#000; font-size:20px;"></i></div>
                 <div class="settings-row" onclick="backupData('logs')" style="cursor:pointer;"><span class="settings-label">Backup Logs Only</span><i class="ph ph-file-text" style="color:#000; font-size:20px;"></i></div>
                <div class="settings-row" onclick="triggerRestore()" style="cursor:pointer;"><span class="settings-label">Restore from Backup</span><i class="ph ph-upload-simple" style="color:#000; font-size:20px;"></i></div>
            </div>
            <div class="settings-header">Shift Configuration</div>
            <div class="settings-group">
                <div class="settings-row"><span class="settings-label">Shift Start Time</span><input type="time" id="setting-shift-start" class="settings-input-inline" onchange="saveShiftStart(this.value)"></div>
                <div class="settings-slider-container" style="border-top:1px solid #f2f2f7;">
                    <div class="slider-header"><span class="settings-label">Attribution Window</span><span class="slider-value" id="attribution-value">5m</span></div>
                    <div class="slider-wrapper">
                        <div class="slider-track"></div><div class="slider-fill" id="slider-fill"></div><div class="slider-thumb" id="slider-thumb"></div>
                        <div class="slider-ticks"><div class="slider-tick" style="left: 0%"><div class="slider-tick-label">0</div></div><div class="slider-tick" style="left: 50%"><div class="slider-tick-label">5</div></div><div class="slider-tick" style="left: 100%"><div class="slider-tick-label">10</div></div></div>
                    </div>
                    <div class="settings-note" style="margin-top:20px; padding:0;">Allow attributing trailers completed up to <span id="attr-note-val" style="font-weight:700; color:#000;">5</span> minutes after the hour to the previous hour.</div>
                </div>
                <div class="settings-row"><span class="settings-label">Simulate Shift Change</span><div class="toggle-switch" id="switch-sim-window" onclick="toggleSwitch('sim-window')"></div></div>
                 <div class="settings-row"><span class="settings-label">Disable Time Attribution</span><div class="toggle-switch" id="switch-dis-window" onclick="toggleSwitch('dis-window')"></div></div>
            </div>
            <div class="settings-header">Saved Accounts</div>
            <div class="settings-group">
                <div class="settings-row">
                    <input type="text" id="new-account-input" class="form-input" style="margin:0; padding:10px; background:#f2f2f7; width:65%;" placeholder="New Account Number" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()">
                    <button class="settings-btn-inline" onclick="addSavedAccount()">Add</button>
                </div>
                <div id="saved-accounts-list" class="saved-accounts-list"><div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div></div>
            </div>
            <div class="settings-header">Demo</div>
            <div class="settings-group">
                <div class="settings-row"><span class="settings-label">Demo Mode</span><div class="toggle-switch" id="switch-demo-mode" onclick="toggleSwitch('demo-mode')"></div></div>
                <div class="settings-row"><span class="settings-label">Force Attribution (Simulate)</span><div class="toggle-switch" id="switch-sim-window" onclick="toggleSwitch('sim-window')"></div></div>
                <div class="settings-row"><span class="settings-label">Disable hardcoded times</span><div class="toggle-switch" id="switch-disable-times" onclick="toggleSwitch('disable-times')"></div></div>
                <div class="settings-row"><span class="settings-label">Generate Random History</span><div class="toggle-switch" id="switch-demo-random" onclick="toggleSwitch('demo-random')"></div></div>
                <div class="settings-row"><span class="settings-label">Auto-Replenish Bays</span><div class="toggle-switch" id="switch-demo-replenish" onclick="toggleSwitch('demo-replenish')"></div></div>
                <div class="settings-row">
                    <span class="settings-label">Number of Doors</span>
                    <div class="stepper"><button class="stepper-btn" onclick="stepDoor(-1)">âˆ’</button><span class="stepper-val" id="demo-door-val">2</span><button class="stepper-btn" onclick="stepDoor(1)">+</button></div>
                </div>
                <div class="settings-row"><span class="settings-label">Mix Trailer Types</span><div class="toggle-switch" id="switch-mixed-types" onclick="toggleSwitch('mixed-types')"></div></div>
                <div class="settings-row" style="justify-content:center; background:#f9f9f9;">
                    <div class="segment-control"><div class="segment-opt selected" id="seg-wally" onclick="setDemoType('Wally')">Wally</div><div class="segment-opt" id="seg-cpu" onclick="setDemoType('CPU')">CPU</div></div>
                </div>
                <div style="padding:15px;"><button class="btn-primary" style="background:#000; color:#fff;" onclick="startDemo()">Auto-Onboard</button></div>
            </div>
            <div class="settings-header">Changelog</div>
            <div class="settings-group"><div class="settings-row" onclick="viewChangelog()" style="cursor:pointer;"><span class="settings-label">View Version History</span><i class="ph ph-caret-right" style="color:#ccc;"></i></div></div>
            <button class="btn-primary" onclick="resetData()" style="background:#ff3b30; margin-bottom:100px;">Reset All Data</button>
        </div>
    </div>
</div>

<nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard', this)" id="tab-btn-dashboard"><i class="ph ph-chart-pie-slice"></i><span>Home</span></button>
    <button class="tab-btn" onclick="switchTab('active', this)" id="tab-btn-active"><i class="ph ph-truck-trailer"></i><span>Active</span><span class="tab-badge" id="badge-active">0</span></button>
    <button class="tab-btn" onclick="switchTab('logs', this)" id="tab-btn-logs"><i class="ph ph-list-dashes"></i><span>Logs</span></button>
    <button class="tab-btn" onclick="switchTab('staffing', this)" id="tab-btn-staffing"><i class="ph ph-users"></i><span>Staffing</span><span class="tab-badge" id="badge-staffing">0</span></button>
    <button class="tab-btn" onclick="switchTab('tools', this)" id="tab-btn-tools"><i class="ph ph-toolbox"></i><span>Tools</span><span class="tab-badge" id="badge-tools">0</span></button>
    <button class="tab-btn" onclick="switchTab('settings', this)" id="tab-btn-settings"><i class="ph ph-gear"></i><span>Settings</span><span class="tab-badge" id="badge-settings">0</span></button>
</nav>

<div class="modal-overlay" id="focus-config-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Plan Daily Focus</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px;">
             <button class="btn-primary" style="flex:1;" onclick="addFocusItem('SWM')">Add SWM</button>
             <button class="btn-primary" style="flex:1; background:#8e8e93;" onclick="addFocusItem('OJS')">Add OJS</button>
             <button class="btn-primary" style="flex:1; background:#000;" onclick="addFocusItem('OBS')">Add OBS</button>
        </div>
        <div id="focus-config-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button class="btn-cancel" onclick="closeModal('focus-config-modal')">Done</button>
    </div>
</div>

<div class="modal-overlay" id="post-sort-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Post Sort Checklist</h2>
        <div id="post-sort-list"></div>
        <button class="btn-primary" onclick="closeModal('post-sort-modal')">Complete Shift</button>
    </div>
</div>

<div class="modal-overlay" id="start-sort-modal-1"><div class="modal-sheet"><h2 style="text-align:center; margin-bottom:20px;">Start Sort (1/2)</h2><div style="margin-bottom:20px;"><label class="settings-label" style="display:block; margin-bottom:10px;">Shift Start Time</label><input type="time" id="start-sort-time" class="form-input" value="19:55"></div><button class="btn-primary" onclick="nextSortStep()">Next</button><button class="btn-cancel" onclick="closeModal('start-sort-modal-1')">Cancel</button></div></div>
<div class="modal-overlay" id="start-sort-modal-2"><div class="modal-sheet"><h2 style="text-align:center; margin-bottom:20px;">Start Sort (2/2)</h2><div style="margin-bottom:20px;"><label class="settings-label" style="display:block; margin-bottom:10px;">Daily Operating Plan</label><select id="start-sort-dop" class="form-input"><option value="5-2">5-2</option><option value="6-2">6-2</option><option value="7-2">7-2</option><option value="8-2">8-2</option></select></div><button class="btn-primary" onclick="finishStartSort()">Start Shift</button><button class="btn-cancel" onclick="closeModal('start-sort-modal-2')">Back</button></div></div>
<div class="modal-overlay" id="changelog-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Changelog</h2><div id="changelog-content" style="max-height:300px; overflow-y:auto; font-size:14px; line-height:1.5; color:#333; white-space: pre-wrap;"></div><button class="btn-cancel" onclick="closeModal('changelog-modal')" style="margin-top:20px;">Close</button></div></div>
<div class="modal-overlay" id="pph-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">PPH Calculator</h2><div style="background:#f2f2f7; border-radius:16px; padding:20px; margin-bottom:20px; text-align:center;"><div style="font-size:13px; color:#757575; font-weight:700; letter-spacing:0.5px; margin-bottom:5px;">TOTAL UNLOADER HOURS</div><input type="number" id="pph-unloader-hours-input" class="form-input" style="font-size:32px; font-weight:800; color:#000; text-align:center; background:transparent; border:none; width:100%; padding:0; margin:0;" oninput="calculatePPH()" placeholder="0.00"><div style="font-size:12px; color:#757575; margin-top:4px;">Excludes Belt Tenders & Sweeps</div></div><div style="margin-bottom:20px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Total Volume</label><input type="number" id="pph-volume-input" class="form-input" placeholder="Enter package count" oninput="calculatePPH()"></div><div style="text-align:center; margin-bottom:30px;"><div style="font-size:14px; color:var(--text-sub); font-weight:700;">CURRENT PPH</div><div style="font-size:60px; font-weight:900; color:#000; letter-spacing:-2px;" id="pph-result">0</div></div><div style="display:flex; gap:10px;"><button class="btn-primary" onclick="resetPPH()" style="background:#e5e5ea; color:#000; flex:1;">Reset</button><button class="btn-cancel" onclick="closeModal('pph-modal')" style="flex:1; margin-top:0; border: 1px solid #e5e5ea; border-radius:16px; padding:18px;">Close</button></div></div></div>
<div class="modal-overlay" id="add-staff-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Clock In Staff <span id="staff-selection-count" style="font-size:14px; color:#8e8e93; font-weight:500; margin-left:10px;">0 Selected</span></h2><div id="staff-checkbox-list" class="staff-checkbox-list"></div><div style="margin: 20px 0 20px 0; border-top: 1px solid #eee; padding-top:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">Add New Person</label><div class="staff-item-row" style="border:none; padding:0;"><input type="text" id="staff-custom-name" class="form-input" style="margin:0; flex:1; margin-right:10px;" placeholder="Name" autocapitalize="words"><select class="staff-role-select" id="staff-custom-role" onchange="toggleStaffOther(this)"><option value="Unloader">Auto (Unloader)</option><option value="Belt Tender">Belt Tender (Locked)</option><option value="Bulk Sweep">Bulk Sweep (Locked)</option><option value="Other">Other</option></select><input type="text" id="staff-custom-other" class="staff-other-input" placeholder="Area"></div></div><button class="btn-primary" onclick="confirmAddStaff()">Clock In Selected</button><button class="btn-cancel" onclick="closeModal('add-staff-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="edit-staff-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Staff</h2><input type="hidden" id="edit-staff-id"><div style="margin-bottom:15px;"><label class="settings-label">Start Time</label><input type="time" id="edit-staff-time" class="form-input"></div><button class="btn-primary" onclick="saveStaffEdit()">Save Changes</button><button class="btn-cancel" onclick="closeModal('edit-staff-modal')">Discard</button></div></div>
<div class="modal-overlay" id="export-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Export Data</h2><button class="btn-primary" onclick="exportLogsCSV()">Export CSV (Spreadsheet)</button><button class="btn-primary" onclick="exportLogsPDF()" style="margin-top:10px; background:#e5e5ea; color:#000;">Export PDF (Report)</button><button class="btn-cancel" onclick="closeModal('export-modal')">Cancel</button></div></div>
<div class="modal-overlay z-high" id="hour-attribution-modal"><div class="modal-sheet"><h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Attribute Completion</h2><p style="text-align:center; color:#757575; margin-bottom:25px; padding: 0 10px;">This trailer was completed during the shift transition window (<span id="attribution-window-text">00-05</span>).</p><button class="btn-primary" onclick="resolveAttribution('Previous')">Previous Hour</button><button class="btn-primary" onclick="resolveAttribution('Current')" style="background:#f2f2f7; color:#000; margin-top:10px;">Current Hour</button></div></div>
<div class="modal-overlay" id="filter-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Filter Logs</h2><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Date</label><input type="date" id="filter-date-input" class="form-input" style="padding:12px;"></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Door</label><div class="filter-grid" id="filter-grid"></div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Unloader</label><select id="filter-unloader-select" class="form-input"><option value="All">All Unloaders</option></select></div><button class="btn-primary" onclick="applyFilter()">Apply Filters</button><button class="btn-cancel" onclick="closeModal('filter-modal')">Cancel</button></div></div>
<div class="modal-overlay z-high" id="duplicate-wally-modal"><div class="modal-sheet"><h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Duplicate Wally Detected</h2><div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px; font-size:14px; line-height:1.5;"><p style="margin:0 0 10px 0;">Wally <strong id="dup-wally-id"></strong> was already completed.</p><div style="display:flex; justify-content:space-between;"><span style="color:#757575;">Door:</span><strong id="dup-door"></strong></div><div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="color:#757575;">Completed:</span><strong id="dup-time"></strong></div><div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="color:#757575;">Unloader:</span><strong id="dup-unloader"></strong></div></div><button class="btn-primary" onclick="continueWithDuplicate()">Continue Anyway</button><button class="btn-cancel" onclick="closeModal('duplicate-wally-modal')" style="margin-top:10px;">Cancel</button></div></div>
<div class="modal-overlay" id="input-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Onboard Door <span id="modal-door-num"></span></h2><div id="onboard-form-container"><div class="type-selector"><div class="type-opt selected" id="opt-wally" onclick="setType('Wally')">Wally</div><div class="type-opt" id="opt-cpu" onclick="setType('CPU')">CPU</div></div><div id="wally-inputs"><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Wally Number</label><input type="text" id="input-wally-id" class="form-input" placeholder="e.g. 5589" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div></div><div id="cpu-inputs" style="display:none;"><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Trailer Number</label><input type="text" id="input-trailer-id" class="form-input" placeholder="e.g. TRL123" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()"></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account Number</label><input type="text" id="input-account-id" class="form-input" placeholder="e.g. ACCT456" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()" list="saved-accounts-datalist"><datalist id="saved-accounts-datalist"></datalist></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:8px; display:block;">Options</label><div class="options-grid"><label class="option-toggle"><input type="checkbox" id="chk-hott" value="HOTT"><span>HOTT</span></label><label class="option-toggle"><input type="checkbox" id="chk-recycle" value="RECYCLE"><span>RECYCLE</span></label><label class="option-toggle"><input type="checkbox" id="chk-gv" value="GV"><span>GV</span></label></div></div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Assigned Unloader (Optional)</label><select id="select-unloader" class="form-input" onchange="checkCustomUnloader(this)"><option value="" selected>Unassigned</option></select><input type="text" id="input-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words"></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Start Time</label><input type="time" id="input-onboard-time" class="form-input"></div><button class="btn-primary" id="btn-start-unload" onclick="confirmArrival()">Start Unload</button></div><div id="unavailable-msg" style="display:none; text-align:center; padding: 30px 0;"><i class="ph ph-prohibit" style="font-size: 48px; color: #8e8e93; margin-bottom: 10px;"></i><div style="font-size: 18px; font-weight: 700; color: #000;">Bay Unavailable</div><div style="font-size: 14px; color: #8e8e93;">This bay is currently marked for maintenance or offline.</div></div><button class="btn-primary btn-history" onclick="viewDoorLogs(currentDoor)">View History</button><button class="btn-primary" id="btn-toggle-availability" onclick="handleAvailabilityToggle()" style="background:white; border:2px solid #e5e5ea; color:#000; margin-top:10px;">Mark Unavailable</button><button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="add-unloader-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Add New Unloader</h2><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader Name</label><input type="text" id="input-new-unloader-name" class="form-input" placeholder="e.g. John Doe" autocapitalize="words"></div><button class="btn-primary" onclick="confirmAddUnloader()">Add Name</button><button class="btn-cancel" onclick="closeModal('add-unloader-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="active-detail-modal"><div class="modal-sheet"><h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Active Door <span id="detail-door-num"></span></h2><div style="margin-bottom: 20px;"><div class="detail-row"><span class="detail-label">Type</span><span class="detail-value" id="detail-type"></span></div><div class="detail-row"><span class="detail-label">ID #</span><span class="detail-value" id="detail-id"></span></div><div class="detail-row" id="row-account" style="display:none;"><span class="detail-label">Account #</span><span class="detail-value" id="detail-account"></span></div><div class="detail-row" id="row-cpu-opts" style="display:none;"><span class="detail-label">Options</span><span class="detail-value" id="detail-cpu-opts"></span></div><div class="detail-row"><span class="detail-label">Unloader</span><span class="detail-value" id="detail-unloader"></span></div><div class="detail-row" id="row-started-by" style="display:none;"><span class="detail-label">Started By</span><span class="detail-value" id="detail-started-by"></span></div><div class="detail-row"><span class="detail-label">Start Time</span><span class="detail-value" id="detail-time"></span></div><div class="detail-row"><span class="detail-label">Duration</span><span class="detail-value" id="detail-duration">0m</span></div></div><button class="btn-primary btn-danger" onclick="confirmCompleteDoor()">Complete Unload</button><div class="modal-actions-row"><button class="modal-icon-btn" onclick="openEditActiveModalFromDetail()" style="flex:1"><i class="ph ph-pencil-simple"></i></button><button class="modal-icon-btn" onclick="openMoveMenu()" style="flex:1; background:#fff; border:1px solid #e5e5ea;"><i class="ph ph-arrows-left-right"></i></button><button class="btn-primary btn-history" onclick="viewDoorLogs(detailDoor)" style="flex:3; margin:0;">View History</button></div><button class="btn-cancel" onclick="closeModal('active-detail-modal')">Close</button></div></div>
<div class="modal-overlay z-high" id="unloader-required-modal"><div class="modal-sheet"><h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Assign Unloader</h2><p style="text-align:center; color:#757575; margin-bottom:25px; padding: 0 10px;">Who completed this door?</p><select id="req-unloader-select" class="form-input" onchange="checkReqCustom(this)"></select><input type="text" id="req-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words"><button class="btn-primary" onclick="saveRequiredUnloader()">Confirm & Finish</button><button class="btn-cancel" onclick="closeModal('unloader-required-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="move-menu-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Move/Transfer</h2><p style="text-align:center; color:#757575; margin-bottom:20px;">Moving a door ends the current session but does not count towards total completions.</p><select id="move-dest-select" class="form-input" onchange="toggleMoveOther(this)"><option value="Small Sort">Small Sort</option><option value="Bulk Directs">Bulk Directs</option><option value="Metros">Metros</option><option value="PS1">PS1</option><option value="PS3">PS3</option><option value="PS5">PS5</option><option value="PS7">PS7</option><option value="PS11">PS11</option><option value="Other">Other</option></select><input type="text" id="move-custom-other" class="form-input" style="display:none; margin-top:10px;" placeholder="Specify Location"><button class="btn-primary" onclick="confirmMoveDoor()">Confirm Move</button><button class="btn-cancel" onclick="closeModal('move-menu-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="loan-staff-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Loan Employee</h2><p style="text-align:center; color:#757575; margin-bottom:20px;">Where is this employee going?</p><select id="loan-dest-select" class="form-input"><option value="Small Sort">Small Sort</option><option value="Metros">Metros</option><option value="PS3">PS3</option><option value="PS5">PS5</option><option value="PS7">PS7</option><option value="PS11">PS11</option><option value="PS1">PS1</option><option value="Other">Other</option></select><button class="btn-primary" onclick="confirmLoanStaff()">Confirm Loan</button><button class="btn-cancel" onclick="closeModal('loan-staff-modal')">Cancel</button></div></div>
<div class="modal-overlay" id="edit-active-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Active Bay</h2><input type="hidden" id="edit-active-original-door"><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Bay Number</label><select id="edit-active-door-select" class="form-input"></select></div><div class="type-selector"><div class="type-opt selected" id="active-opt-wally" onclick="setEditActiveType('Wally')">Wally</div><div class="type-opt" id="active-opt-cpu" onclick="setEditActiveType('CPU')">CPU</div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label><input type="text" id="edit-active-id" class="form-input" oninput="this.value = this.value.toUpperCase()"></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account # (CPU only)</label><input type="text" id="edit-active-account" class="form-input" oninput="this.value = this.value.toUpperCase()"></div><div id="edit-active-options-container" style="display:none; margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:8px; display:block;">Options</label><div class="options-grid"><label class="option-toggle"><input type="checkbox" id="edit-active-chk-hott" value="HOTT"><span>HOTT</span></label><label class="option-toggle"><input type="checkbox" id="edit-active-chk-recycle" value="RECYCLE"><span>RECYCLE</span></label><label class="option-toggle"><input type="checkbox" id="edit-active-chk-gv" value="GV"><span>GV</span></label></div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label><select id="edit-active-unloader" class="form-input" onchange="checkActiveCustomUnloader(this)"></select><input type="text" id="edit-active-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words"></div><div id="edit-active-assist-option" style="margin-bottom:20px; display:none;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:8px; display:block;">Switch Type</label><div class="segment-control"><div class="segment-opt selected" id="seg-replace" onclick="setSwitchType('Replacement')">Replacement</div><div class="segment-opt" id="seg-assist" onclick="setSwitchType('Assist')">Assist</div></div></div><button class="btn-primary" onclick="saveActiveEdit()">Save Changes</button><button class="btn-cancel" onclick="closeModal('edit-active-modal')">Discard</button></div></div>
<div class="modal-overlay" id="edit-log-modal"><div class="modal-sheet"><h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Log Entry</h2><input type="hidden" id="edit-log-index"><div class="type-selector"><div class="type-opt selected" id="edit-opt-wally" onclick="setEditType('Wally')">Wally</div><div class="type-opt" id="edit-opt-cpu" onclick="setEditType('CPU')">CPU</div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label><input type="text" id="edit-input-id" class="form-input" oninput="this.value = this.value.toUpperCase()"></div><div id="edit-log-options-container" style="display:none; margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:8px; display:block;">Options</label><div class="options-grid"><label class="option-toggle"><input type="checkbox" id="edit-log-chk-hott" value="HOTT"><span>HOTT</span></label><label class="option-toggle"><input type="checkbox" id="edit-log-chk-recycle" value="RECYCLE"><span>RECYCLE</span></label><label class="option-toggle"><input type="checkbox" id="edit-log-chk-gv" value="GV"><span>GV</span></label></div></div><div style="margin-bottom:15px;"><label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label><select id="edit-select-unloader" class="form-input"></select></div><button class="btn-primary" onclick="confirmLogEdit()">Save Changes</button><button class="btn-cancel" onclick="closeModal('edit-log-modal')">Discard</button></div></div>

<script>
    // --- GLOBAL VARIABLES ---
    let demoActive = false;
    let duplicateWallyFlag = false;
    let pendingWallyDuplicate = null;
    let currentDoor = null;
    let currentType = 'Wally';
    let detailDoor = null;
    let currentLogFilter = 'All';
    let activeLogFilter = { door: 'All', unloader: 'All', type: 'All', timeRange: 'All', search: '', date: 'All' };
    let statsVisible = false;
    let hourlyVisible = false;
    let lastSortStartTime = null;
    let isFirstOnboard = false;
    let staffingInterval = null;
    let currentSwitchType = 'Replacement';
    let pendingLoanId = null;

    // --- CONFIG ---
    const APP_VERSION = '3.55';
    const DOORS_START = 9;
    const DOORS_END = 16;
    const DEFAULT_TEAM = ["David F", "Lorena R", "Matt R", "Matt S", "Robert W", "Trevon C", "Victor M", "Russell H", "Fonseca J"];

    // --- HELPER FUNCTIONS ---
    const byId = (id) => document.getElementById(id);
    function dateKeyFromTs(ts) {
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // --- CHANGELOG ---
    const CHANGELOG = `
v3.55:
- Dashboard Overhaul: Added 'Today's Focus' with dynamic tasks.
- Tools: Added 'Plan Daily Focus' to configure tasks.
- Action Buttons: Replaced 'Add Unloader' with 'End Sort'.
- End Sort: Generates shift summary + Checklist.

v3.54:
- Compact Layout: Optimized spacing.
    `;

    // --- STATE ---
    let doors = {};
    let historyLog = [];
    let teamNames = [];
    let savedAccounts = [];
    let staffing = [];
    let currentDOP = '5-2';
    let teamNamesSorted = [];
    
    // Today's Focus
    let focusItems = [
        { id: 1, type: 'SWM', label: 'Safety Methods', assignedTo: null, completed: false },
        { id: 2, type: 'OJS', label: 'On Job Supervision', assignedTo: null, completed: false },
        { id: 3, type: 'OBS', label: 'General Observation', assignedTo: null, completed: false }
    ];

    let config = {
        replenish: false, randomHistory: false, doorCount: 2,
        mixedTypes: false, demoType: 'Wally', disableTimes: false,
        simulateWindow: false, disableWindow: false
    };

    let attributionConfig = { minutes: 5, enabled: true };
    let pendingCompletion = null;

    function getHourText(hour) {
        if(hour===1) return "1st hour"; if(hour===2) return "2nd hour"; if(hour===3) return "3rd hour";
        if(hour===4) return "4th hour"; if(hour===5) return "5th hour"; if(hour===6) return "6th hour";
        if(hour===7) return "7th hour"; if(hour===8) return "8th hour"; if(hour===9) return "9th hour";
        if(hour===10) return "10th hour"; if(hour===11) return "11th hour"; if(hour===12) return "12th hour";
        return `${hour}th hour`;
    }

    // --- INIT ---
    function init() {
        console.log(`Wally Dashboard v${APP_VERSION} initialized`);

        // Event Delegation
        byId('active-trailers-grid').addEventListener('click', (e) => {
            const btn = e.target.closest('.bay-circle');
            if(btn) openActiveDetails(parseInt(btn.dataset.door));
        });
        byId('open-bays-grid').addEventListener('click', (e) => {
             const btn = e.target.closest('.bay-circle');
             if(btn) openArrivalModal(parseInt(btn.dataset.door));
        });

        // Search
        const searchInput = byId('log-search');
        if(searchInput) {
            searchInput.addEventListener('input', debounce(() => renderLogs(), 300));
        }

        // Load Data
        const sAccts = localStorage.getItem('ps9_accounts');
        if (sAccts) savedAccounts = JSON.parse(sAccts);
        initAttributionSettings();
        
        // Load Focus
        const savedFocus = localStorage.getItem('ps9_focus_items');
        if (savedFocus) focusItems = JSON.parse(savedFocus);
        
        // Load Staff
        const sStaff = localStorage.getItem('ps9_staffing');
        if(sStaff) staffing = JSON.parse(sStaff);
        
        // Load Doors
        const sDoors = localStorage.getItem('ps9_doors');
        if (sDoors) doors = JSON.parse(sDoors);
        else {
            for(let i=DOORS_START; i<=DOORS_END; i++) {
                doors[i] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: null, assignments: [] };
            }
        }
        // Migration
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(doors[i].status === 'active' && (!doors[i].assignments || doors[i].assignments.length===0)) {
                doors[i].assignments = [{ name: doors[i].unloader || "Unassigned", start: doors[i].start, end: null }];
            }
        }

        const sHistory = localStorage.getItem('ps9_history');
        if (sHistory) historyLog = JSON.parse(sHistory);

        const sTeam = localStorage.getItem('ps9_team');
        if (sTeam) teamNames = JSON.parse(sTeam); else teamNames = [...DEFAULT_TEAM];
        refreshTeamNamesSorted();
        
        const sDop = localStorage.getItem('ps9_dop');
        if(sDop) currentDOP = sDop;

        renderSavedAccounts();
        updateAccountDatalist();
        populateUnloaderSelect();
        renderDashboard();
        renderFocusCard();
        
        setInterval(updateTabBadges, 2000);
        updateTabBadges();
    }
    
    // --- FOCUS LOGIC ---
    function renderFocusCard() {
        const list = byId('today-focus-list');
        list.innerHTML = '';
        
        if (focusItems.length === 0) {
            list.innerHTML = '<div class="today-empty">No items planned. Configure in Tools.</div>';
            return;
        }
        
        focusItems.forEach((item, index) => {
             const div = document.createElement('div');
             div.className = `focus-item ${item.completed ? 'done' : ''}`;
             
             // Create Employee Select Options
             let options = '<option value="">Assign Staff...</option>';
             teamNamesSorted.forEach(n => {
                 const sel = item.assignedTo === n ? 'selected' : '';
                 options += `<option value="${n}" ${sel}>${n}</option>`;
             });
             options += `<option value="Custom" ${item.assignedTo && !teamNames.includes(item.assignedTo) ? 'selected' : ''}>Custom Name</option>`;
             
             div.innerHTML = `
                <div class="focus-check" onclick="toggleFocusComplete(${index})"><i class="ph ph-check"></i></div>
                <div class="focus-content">
                    <div class="focus-type">${item.type}</div>
                    <select class="focus-select" onchange="updateFocusAssignee(${index}, this)">
                        ${options}
                    </select>
                    <input type="text" class="focus-custom-input" placeholder="Name" 
                           value="${(item.assignedTo && !teamNames.includes(item.assignedTo)) ? item.assignedTo : ''}"
                           style="display: ${item.assignedTo === 'Custom' || (item.assignedTo && !teamNames.includes(item.assignedTo)) ? 'block' : 'none'};"
                           onchange="updateFocusCustomName(${index}, this)">
                </div>
                ${item.completed ? '<i class="ph ph-check-circle" style="color:#000;"></i>' : ''}
             `;
             list.appendChild(div);
        });
    }
    
    function toggleFocusComplete(idx) {
        focusItems[idx].completed = !focusItems[idx].completed;
        saveFocus();
    }
    
    function updateFocusAssignee(idx, select) {
        if (select.value === 'Custom') {
            focusItems[idx].assignedTo = 'Custom'; // Marker
            select.nextElementSibling.style.display = 'block';
            select.nextElementSibling.focus();
        } else {
            focusItems[idx].assignedTo = select.value;
            select.nextElementSibling.style.display = 'none';
        }
        saveFocus();
    }
    
    function updateFocusCustomName(idx, input) {
        focusItems[idx].assignedTo = input.value;
        saveFocus();
    }
    
    function saveFocus() {
        localStorage.setItem('ps9_focus_items', JSON.stringify(focusItems));
        renderFocusCard();
    }
    
    function openFocusConfigModal() {
        renderFocusConfigList();
        byId('focus-config-modal').style.display = 'flex';
    }
    
    function addFocusItem(type) {
        focusItems.push({ id: Date.now(), type: type, label: type, assignedTo: null, completed: false });
        renderFocusConfigList();
        saveFocus();
    }
    
    function removeFocusItem(idx) {
        focusItems.splice(idx, 1);
        renderFocusConfigList();
        saveFocus();
    }
    
    function renderFocusConfigList() {
        const list = byId('focus-config-list');
        list.innerHTML = '';
        focusItems.forEach((item, idx) => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:12px;";
            div.innerHTML = `<strong>${item.type}</strong> <button class="icon-btn" style="color:#ff3b30;" onclick="removeFocusItem(${idx})"><i class="ph ph-trash"></i></button>`;
            list.appendChild(div);
        });
    }

    // --- END SORT FLOW ---
    function openEndSortFlow() {
        const totalW = byId('stat-total-wally').innerText;
        const totalC = byId('stat-total-cpu').innerText;
        const pph = calculatePPHValue(); // Helper
        
        const summary = `
Wally Dashboard - Shift Summary
Date: ${new Date().toLocaleDateString()}
Total Wallies: ${totalW}
Total CPUs: ${totalC}
Est. PPH: ${pph}

[Generated by WallyTracker]
        `;
        
        if (navigator.share) {
            navigator.share({
                title: 'Wally Shift Summary',
                text: summary
            }).then(() => openPostSortChecklist()).catch(() => openPostSortChecklist());
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(summary);
            alert("Summary copied to clipboard!");
            openPostSortChecklist();
        }
    }
    
    function calculatePPHValue() {
        // Basic calculation based on visible stats
        const hrs = calculateUnloaderHours();
        const vol = 0; // Requires volume input actually, return placeholder if unknown
        return "N/A (Input Vol)"; 
    }
    
    function openPostSortChecklist() {
        const list = byId('post-sort-list');
        const items = ["Check Slide", "Check Payroll", "Walk Wall", "Enter Obs/OJS/SWM", "Return Scanner", "Sign Walk-off", "Return Gear", "Add Numbers on Board"];
        list.innerHTML = '';
        items.forEach(i => {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.onclick = function() { this.classList.toggle('checked'); };
            div.innerHTML = `<div class="checklist-box"><i class="ph ph-check"></i></div><div class="checklist-label">${i}</div>`;
            list.appendChild(div);
        });
        byId('post-sort-modal').style.display = 'flex';
    }

    // --- GRANULAR SAVING ---
    function saveDoors() { localStorage.setItem('ps9_doors', JSON.stringify(doors)); }
    function saveHistory() { localStorage.setItem('ps9_history', JSON.stringify(historyLog)); }
    function saveTeam() { localStorage.setItem('ps9_team', JSON.stringify(teamNames)); }
    function saveStaffing() { localStorage.setItem('ps9_staffing', JSON.stringify(staffing)); }
    function saveAccounts() { localStorage.setItem('ps9_accounts', JSON.stringify(savedAccounts)); }
    
    function saveData() { 
        saveDoors(); saveHistory(); saveTeam(); saveStaffing(); saveAccounts();
        localStorage.setItem('ps9_dop', currentDOP);
    }

    function refreshTeamNamesSorted() { teamNamesSorted = [...teamNames].sort((a, b) => a.localeCompare(b)); }

    function resetData() {
        if(confirm("Reset all data? This will preserve saved account numbers.")) {
            const savedAccountsBackup = [...savedAccounts];
            localStorage.clear();
            if (savedAccountsBackup.length > 0) {
                localStorage.setItem('ps9_accounts', JSON.stringify(savedAccountsBackup));
            }
            localStorage.setItem('ps9_shift_start', "19:55");
            location.reload();
        }
    }

    // --- BACKUP & RESTORE ---
    function backupData(mode) {
        const data = {};
        if (mode === 'logs') {
             data['ps9_history'] = localStorage.getItem('ps9_history');
        } else {
             for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('ps9_')) data[key] = localStorage.getItem(key);
            }
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `wally-${mode}-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showSaveToast();
    }

    function triggerRestore() { byId('restore-file-input').click(); }
    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(!data || Object.keys(data).length === 0) throw new Error("Empty file");
                if(confirm("Overwrite current data with backup?")) {
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    alert("Data restored!"); location.reload();
                }
            } catch(err) { alert("Error: " + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    }
    function showSaveToast() {
        const t = byId('save-toast'); t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2000);
    }
    function viewChangelog() {
        byId('changelog-content').textContent = CHANGELOG;
        byId('changelog-modal').style.display = 'flex';
    }

    // --- LOGIC ---
    function openStartSortFlow() {
        byId('start-sort-time').value = localStorage.getItem('ps9_shift_start') || "19:55";
        byId('start-sort-modal-1').style.display = 'flex';
    }
    function nextSortStep() {
        const t = byId('start-sort-time').value;
        if(!t) return alert("Please select a time");
        tempSortStartTime = t;
        byId('start-sort-dop').value = currentDOP;
        closeModal('start-sort-modal-1');
        byId('start-sort-modal-2').style.display = 'flex';
    }
    function finishStartSort() {
        const d = byId('start-sort-dop').value;
        saveShiftStart(tempSortStartTime);
        saveDOP(d);
        lastSortStartTime = tempSortStartTime;
        localStorage.setItem('ps9_last_sort_start', lastSortStartTime);
        isFirstOnboard = true;
        localStorage.setItem('ps9_is_first_onboard', 'true');
        closeModal('start-sort-modal-2');
        showSaveToast();
        renderDashboard();
    }

    function initAttributionSettings() {
        const saved = localStorage.getItem('ps9_attribution_config_v2');
        if (saved) attributionConfig = JSON.parse(saved);
        updateAttributionUI();
    }
    function updateAttributionUI() {
        const val = attributionConfig.minutes;
        byId('attribution-value').textContent = val + "m";
        const note = byId('attr-note-val'); if(note) note.textContent = val;
        byId('slider-fill').style.width = `${(val/10)*100}%`;
        byId('slider-thumb').style.left = `${(val/10)*100}%`;
    }
    function saveAttributionSetting() {
        localStorage.setItem('ps9_attribution_config_v2', JSON.stringify(attributionConfig));
        showSaveToast();
    }
    function setupAttributionSlider() {
        const track = document.querySelector('.slider-track');
        const thumb = byId('slider-thumb');
        if (!track || !thumb) return;
        let isDragging = false, saveTimer = null;
        function updateSlider(clientX, persist) {
            const rect = track.getBoundingClientRect();
            let pct = ((clientX - rect.left) / rect.width) * 100;
            pct = Math.max(0, Math.min(100, pct));
            const minVal = Math.round((pct / 100) * 10);
            if (minVal === attributionConfig.minutes) return;
            attributionConfig.minutes = minVal;
            updateAttributionUI();
            if (persist) saveAttributionSetting();
            else { clearTimeout(saveTimer); saveTimer = setTimeout(saveAttributionSetting, 200); }
        }
        thumb.addEventListener('touchstart', (e)=>{isDragging=true;e.preventDefault();});
        document.addEventListener('touchmove', (e)=>{if(!isDragging)return; updateSlider(e.touches[0].clientX, false);},{passive:false});
        document.addEventListener('touchend', ()=>{if(!isDragging)return; isDragging=false; saveAttributionSetting();});
        thumb.addEventListener('mousedown', (e)=>{isDragging=true;e.preventDefault();});
        document.addEventListener('mousemove', (e)=>{if(!isDragging)return; updateSlider(e.clientX, false);});
        document.addEventListener('mouseup', ()=>{if(!isDragging)return; isDragging=false; saveAttributionSetting();});
        track.addEventListener('click', (e)=>updateSlider(e.clientX, true));
    }

    function updateTabBadges() {
        let activeCount = 0;
        for(let i=DOORS_START; i<=DOORS_END; i++) if(doors[i].status === 'active') activeCount++;
        updateBadge('active', activeCount, 'activeTrailers');
        let staffCount = staffing.filter(s => s.status === 'active' || s.status === 'paused').length;
        updateBadge('staffing', staffCount, 'activeStaff');
        updateBadge('tools', 0, 'default');
        updateBadge('settings', demoActive ? 1 : 0, 'demo');
    }

    function updateBadge(tabId, count, type) {
        const badge = byId(`badge-${tabId}`);
        if (!badge) return;
        if (tabId === 'logs') { badge.style.display = 'none'; return; }
        if (count === 0) {
            badge.textContent = '0'; badge.classList.add('zero');
            badge.classList.remove('warning', 'success'); badge.style.display = 'none';
        } else {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.remove('zero');
            if (type === 'activeTrailers' || type === 'activeStaff') {
                if ((type==='activeTrailers' && count>=6) || (type==='activeStaff' && count>=8)) badge.classList.add('warning');
                else if ((type==='activeTrailers' && count>=3) || (type==='activeStaff' && count>=4)) badge.classList.add('success');
                else badge.classList.remove('warning', 'success');
            } else if (type === 'demo') badge.classList.add('warning');
            else badge.classList.remove('warning', 'success');
            badge.style.display = 'flex';
        }
    }

    function saveDOP(val) { currentDOP = val; localStorage.setItem('ps9_dop', currentDOP); updateStaffingTimers(false); showSaveToast(); }
    
    function toggleStaffOther(selectEl) {
        const input = selectEl.nextElementSibling;
        if(input && input.classList.contains('staff-other-input')) {
            input.style.display = (selectEl.value === 'Other') ? 'block' : 'none';
            if(selectEl.value==='Other') input.focus();
        }
    }
    
    function toggleMoveOther(selectEl) {
        const input = byId('move-custom-other');
        if(input) {
            input.style.display = (selectEl.value === 'Other') ? 'block' : 'none';
            if(selectEl.value==='Other') input.focus();
        }
    }
    
    function updateStaffSelectionCount() {
        const count = document.querySelectorAll('.staff-checkbox:checked').length;
        const el = byId('staff-selection-count');
        if(el) el.innerText = `${count} Selected`;
    }

    function openAddStaffModal() {
        const container = byId('staff-checkbox-list'); container.innerHTML = '';
        teamNamesSorted.forEach(n => {
            const isActive = staffing.find(s => s.name === n && (s.status === 'active' || s.status === 'paused' || s.status === 'loaned'));
            if(!isActive) {
                const item = document.createElement('div');
                item.className = 'staff-item-row';
                item.innerHTML = `
                    <label class="staff-check-label">
                        <input type="checkbox" value="${n}" class="staff-checkbox" onchange="updateStaffSelectionCount()">
                        <span>${n}</span>
                    </label>
                    <select class="staff-role-select" id="role-select-${n.replace(/\s+/g, '')}" onchange="toggleStaffOther(this)">
                        <option value="Unloader">Auto (Unloader)</option>
                        <option value="Belt Tender">Belt Tender (Locked)</option>
                        <option value="Bulk Sweep">Bulk Sweep (Locked)</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="other-input-${n.replace(/\s+/g, '')}" class="staff-other-input" placeholder="Role">
                `;
                container.appendChild(item);
            }
        });
        byId('staff-custom-name').value = ''; 
        byId('staff-custom-role').value = 'Unloader';
        const otherInput = byId('staff-custom-other');
        if(otherInput) otherInput.style.display = 'none';
        
        updateStaffSelectionCount();
        byId('add-staff-modal').style.display = 'flex';
    }

    function confirmAddStaff() {
        const cbs = document.querySelectorAll('.staff-checkbox:checked');
        const customName = byId('staff-custom-name').value.trim();
        const customRoleSelect = byId('staff-custom-role');
        let customRoleVal = customRoleSelect.value;
        if(customRoleVal === 'Other') {
             const customOther = byId('staff-custom-other');
             if(customOther) customRoleVal = customOther.value.trim();
        }
        
        if(cbs.length === 0 && !customName) return alert("Select an employee or enter a name.");
        
        const startTime = Date.now(); 
        const LOAN_ROLES = ['Small Sort', 'Metros', 'PS1', 'PS3', 'PS5', 'PS7', 'PS11'];

        cbs.forEach(cb => {
            const name = cb.value;
            const safeId = name.replace(/\s+/g, '');
            const roleSelect = document.getElementById(`role-select-${safeId}`);
            let roleVal = roleSelect ? roleSelect.value : 'Unloader';
            
            if(roleVal === 'Other') {
                const otherInput = document.getElementById(`other-input-${safeId}`);
                if(otherInput) roleVal = otherInput.value.trim();
            }
            
            if (name === "Robert W" && roleVal === 'Unloader') {
                roleVal = 'Belt Tender';
            }

            let status = 'active';
            let loanDest = null;
            let manualOverride = (roleVal !== 'Unloader');
            
            if (LOAN_ROLES.includes(roleVal)) {
                 status = 'loaned';
                 loanDest = roleVal;
                 roleVal = 'Unloader'; 
                 manualOverride = false;
            }

            if(!staffing.find(s => s.name === name && s.status !== 'cut')) {
                staffing.push({ 
                    id: Date.now() + Math.random(), name: name, 
                    start: startTime, end: (status==='loaned'?startTime:null), 
                    status: status, role: roleVal, accumulated: 0, 
                    manualOverride: manualOverride, loanDest: loanDest 
                });
            }
        });

        if (customName) {
            const fmtName = customName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            let roleVal = customRoleVal;
            
            if (fmtName === "Robert W" && roleVal === 'Unloader') roleVal = 'Belt Tender';
            
            let status = 'active';
            let loanDest = null;
            let manualOverride = (roleVal !== 'Unloader');

             if (LOAN_ROLES.includes(roleVal)) {
                 status = 'loaned';
                 loanDest = roleVal;
                 roleVal = 'Unloader';
                 manualOverride = false;
            }

            if (!teamNames.includes(fmtName)) {
                teamNames.push(fmtName);
                refreshTeamNamesSorted();
                saveTeam();
                populateUnloaderSelect();
            }

            if(!staffing.find(s => s.name === fmtName && s.status !== 'cut')) {
                 staffing.push({ 
                     id: Date.now() + Math.random(), name: fmtName, 
                     start: startTime, end: (status==='loaned'?startTime:null), 
                     status: status, role: roleVal, accumulated: 0, 
                     manualOverride: manualOverride, loanDest: loanDest 
                 });
            }
        }

        saveStaffing();
        closeModal('add-staff-modal');
        renderStaffingView();
        updateTabBadges();
        showSaveToast();
    }

    function cutStaff(id) {
        const s = staffing.find(x => x.id === id);
        if(s) {
            s.status = 'cut'; s.end = Date.now();
            if (s.start !== null) s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
            s.start = null;
            if(s.role === 'Belt Tender' || s.role === 'Bulk Sweep') s.role = 'Unloader';
            saveStaffing(); renderStaffingView(); updateTabBadges(); showSaveToast();
        }
    }
    
    function openLoanModal(id) {
        pendingLoanId = id;
        byId('loan-staff-modal').style.display='flex';
    }
    
    function confirmLoanStaff() {
        const dest = byId('loan-dest-select').value;
        const s = staffing.find(x => x.id === pendingLoanId);
        if(s) {
            s.status = 'loaned';
            s.loanDest = dest;
            s.end = Date.now(); 
            if (s.start !== null) s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
            s.start = null;
            
            if(s.role === 'Belt Tender' || s.role === 'Bulk Sweep') s.role = 'Unloader';
            saveStaffing(); renderStaffingView(); updateTabBadges(); showSaveToast();
        }
        closeModal('loan-staff-modal');
    }

    function removeStaff(id) {
        if(confirm("Delete this employee record?")) {
            staffing = staffing.filter(s => s.id !== id);
            saveStaffing(); renderStaffingView(); updateTabBadges();
        }
    }
    
    function openEditStaffModal(id) {
        const s = staffing.find(x => x.id === id); if(!s) return;
        byId('edit-staff-id').value = id;
        const date = new Date(s.start || Date.now());
        byId('edit-staff-time').value = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        byId('edit-staff-modal').style.display = 'flex';
    }

    function saveStaffEdit() {
        const id = parseFloat(byId('edit-staff-id').value), timeInput = byId('edit-staff-time').value;
        const s = staffing.find(x => x.id === id);
        if(s && timeInput) {
            const [h, m] = timeInput.split(':').map(Number);
            const newDate = new Date(s.start || Date.now());
            newDate.setHours(h, m);
            const diff = newDate.getTime() - (s.start || Date.now());
            if(diff < -43200000) newDate.setDate(newDate.getDate() + 1);
            if(diff > 43200000) newDate.setDate(newDate.getDate() - 1);
            s.start = newDate.getTime();
            saveStaffing(); renderStaffingView(); closeModal('edit-staff-modal'); showSaveToast();
        }
    }

    function pauseStaff(id) {
        const s = staffing.find(x => x.id === id);
        if (s && s.status === 'active') {
            s.status = 'paused';
            s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
            s.start = null;
            saveStaffing(); renderStaffingView(); updateTabBadges();
        }
    }
    function resumeStaff(id) {
        const s = staffing.find(x => x.id === id);
        if (s && s.status === 'paused') {
            s.status = 'active'; s.start = Date.now();
            saveStaffing(); renderStaffingView(); updateTabBadges();
        }
    }

    function calculateTotalHours(s) {
        let totalMs = (s.accumulated || 0);
        if (s.status === 'active' && s.start) totalMs += (Date.now() - s.start);
        return Math.round(totalMs / 60000) / 60;
    }

    function autoAssignRoles() {
        const activeStaff = staffing.filter(s => s.status === 'active' || s.status === 'paused');
        activeStaff.sort((a, b) => calculateTotalHours(b) - calculateTotalHours(a));

        let lockedBeltTenders = 0;
        let lockedSweeps = 0;

        activeStaff.forEach(s => {
            if (s.manualOverride) {
                if (s.role === 'Belt Tender') lockedBeltTenders++;
                if (s.role === 'Bulk Sweep') lockedSweeps++;
            }
        });

        let changed = false;

        activeStaff.forEach(s => {
            if (s.manualOverride) return;

            let newRole = 'Unloader';
            if (lockedBeltTenders < 1) { newRole = 'Belt Tender'; lockedBeltTenders++; } 
            else if (lockedSweeps < 2) { newRole = 'Bulk Sweep'; lockedSweeps++; }

            if (s.role !== newRole) { s.role = newRole; changed = true; }
        });

        if (changed) { saveStaffing(); return true; }
        return false;
    }

    function saveStaffRole(id, value, selectEl) {
        const s = staffing.find(x => x.id === id); 
        if (!s) return;
        
        if (value === 'Auto' || value === 'Unloader') {
            s.manualOverride = false;
        } else { 
            s.manualOverride = true; 
            s.role = value; 
        }
        
        saveStaffing(); renderStaffingView(); updateTabBadges(); showSaveToast();
    }

    function renderStaffingView() {
        autoAssignRoles();
        const activeList = byId('staff-list-active'), cutList = byId('staff-list-cut'), loanList = byId('staff-list-loaned');
        activeList.innerHTML = ''; cutList.innerHTML = ''; loanList.innerHTML = '';
        
        const getRoleScore = (r) => { if(r==='Belt Tender') return 3; if(r==='Bulk Sweep') return 2; return 1; };
        
        const activeStaff = staffing.filter(s => s.status === 'active' || s.status === 'paused')
            .sort((a,b) => {
                const scoreA = getRoleScore(a.role);
                const scoreB = getRoleScore(b.role);
                if(scoreA !== scoreB) return scoreB - scoreA;
                return calculateTotalHours(b) - calculateTotalHours(a);
            });

        activeStaff.forEach(s => {
            const isPaused = s.status === 'paused';
            const isManual = s.manualOverride === true;
            let roleIcon = '';
            if (s.role === 'Belt Tender') roleIcon = 'ðŸ‘‘';
            else if (s.role === 'Bulk Sweep') roleIcon = 'ðŸ§¹';
            
            const roleColor = s.role==='Belt Tender'?'#ff9500':(s.role==='Bulk Sweep'?'#34c759':'#000');
            
            const div = document.createElement('div'); div.className = 'staff-card';
            div.dataset.id = s.id; 
            if(isPaused) div.style.cssText = 'opacity:0.7; border:1px dashed #ccc;';
            
            div.innerHTML = `
                <div style="width:100%">
                    <div class="staff-top-row">
                        <div class="staff-name">${s.name} <span style="margin-left:5px; font-size:18px;">${roleIcon}</span> ${isManual ? '<i class="ph ph-lock-key" style="font-size:14px; color:#555; margin-left:4px;"></i>' : ''} ${isPaused?'<span style="background:#ffcc00; color:#000; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:700; margin-left:5px;">PAUSED</span>':''}</div>
                        <div style="display:flex; gap:8px;">
                             <button class="icon-btn" onclick="openLoanModal(${s.id})" style="width:32px; height:32px; font-size:16px;"><i class="ph ph-export"></i></button>
                            <button class="icon-btn" onclick="${isPaused?'resumeStaff':'pauseStaff'}(${s.id})" style="width:32px; height:32px; font-size:16px; ${isPaused?'background:#e5e5ea; color:#000;':''}"><i class="ph ${isPaused?'ph-play':'ph-pause'}"></i></button>
                            <button class="icon-btn" onclick="openEditStaffModal(${s.id})" style="width:32px; height:32px; font-size:16px;"><i class="ph ph-pencil-simple"></i></button>
                            <button class="staff-action-btn" onclick="cutStaff(${s.id})">CUT</button>
                            <button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30;"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                    <div class="staff-time">${isPaused?'Paused':'Started: '+new Date(s.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                        <div class="staff-hours" id="staff-hours-${s.id}" style="color:${roleColor}">${calculateTotalHours(s).toFixed(2)}h</div>
                        <div style="width:55%">
                             <select class="role-select" onchange="saveStaffRole(${s.id}, this.value, this)" style="background:${isManual ? '#e5e5ea' : '#f2f2f7'}; border:${isManual ? '1px solid #ccc' : 'none'};">
                                <option value="Auto" ${!isManual ? 'selected' : ''}>Auto (Unloader)</option>
                                <option value="Belt Tender" ${s.role==='Belt Tender'?'selected':''}>Belt Tender (Locked)</option>
                                <option value="Bulk Sweep" ${s.role==='Bulk Sweep'?'selected':''}>Bulk Sweep (Locked)</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            activeList.appendChild(div);
        });

        const loanStaffList = staffing.filter(s => s.status === 'loaned');
        loanStaffList.forEach(s => {
             const div = document.createElement('div'); div.className = 'log-card'; 
             div.innerHTML = `
                <div class="log-info">
                     <div class="log-header-row"><span class="log-door-pill" style="background:#000;">${s.name}</span></div>
                     <div class="log-tags-row"><span class="log-tag tag-gray"><i class="ph ph-arrow-right"></i> ${s.loanDest}</span></div>
                </div>
                <div class="log-right-col">
                    <div style="text-align:right;"><div class="log-duration" style="font-size:18px;">${new Date(s.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="log-duration-label">Left At</div></div>
                    <button class="log-mini-btn" style="color:#ff3b30; border-color:#ff3b30;" onclick="removeStaff(${s.id})"><i class="ph ph-trash"></i></button>
                </div>
             `;
             loanList.appendChild(div);
        });

        const cutStaffList = staffing.filter(s => s.status === 'cut').sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));
        cutStaffList.forEach(s => {
            const div = document.createElement('div'); div.className = 'staff-card cut';
            div.innerHTML = `
                <div><div class="staff-name">${s.name} â€¢ ${s.role}</div><div class="staff-time">Ended: ${new Date(s.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>
                <div style="display:flex; align-items:center; gap:10px;"><div class="staff-hours">${calculateTotalHours(s).toFixed(2)}h</div><button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30; background:transparent;"><i class="ph ph-trash"></i></button></div>`;
            cutList.appendChild(div);
        });

        byId('badge-on-clock').innerText = activeStaff.length;
        byId('badge-off-clock').innerText = cutStaffList.length;
        byId('badge-loaned').innerText = loanStaffList.length;
        updateStaffingTimers(false); 
    }

    function updateStaffingTimers(checkRoles = true) {
        if(!byId('tab-staffing').classList.contains('active')) return;
        
        if(checkRoles) { const changed = autoAssignRoles(); if(changed) { renderStaffingView(); return; } }

        const currentOrder = Array.from(document.querySelectorAll('.staff-card:not(.cut)')).map(el => parseFloat(el.dataset.id));
        const getRoleScore = (r) => { if(r==='Belt Tender') return 3; if(r==='Bulk Sweep') return 2; return 1; };
        const newSorted = staffing.filter(s => s.status!=='cut' && s.status!=='loaned' && (s.status==='active'||s.status==='paused'))
                                  .sort((a,b) => {
                                      const scoreA = getRoleScore(a.role);
                                      const scoreB = getRoleScore(b.role);
                                      if(scoreA !== scoreB) return scoreB - scoreA;
                                      return calculateTotalHours(b) - calculateTotalHours(a);
                                  });
        const newOrder = newSorted.map(s => s.id);
        
        if(currentOrder.length !== newOrder.length || JSON.stringify(currentOrder) !== JSON.stringify(newOrder)) {
            renderStaffingView();
            return;
        }

        let onClock=0, uHours=0, bHours=0, sHours=0;
        staffing.forEach(s => {
            let hrs = calculateTotalHours(s);
            if(s.status==='active'||s.status==='paused') {
                onClock++;
                const el = byId(`staff-hours-${s.id}`); if(el) el.innerText = hrs.toFixed(2)+'h';
            }
            if(s.role==='Unloader') uHours+=hrs; else if(s.role==='Belt Tender') bHours+=hrs; else if(s.role==='Bulk Sweep') sHours+=hrs;
        });
        byId('staff-active-count').innerText = onClock;
        byId('staff-total-hours').innerText = uHours.toFixed(2);
        byId('staff-belt-hours').innerText = bHours.toFixed(2);
        byId('staff-sweep-hours').innerText = sHours.toFixed(2);
        
        // DOP STATUS UPDATE - Modified Logic
        const [uStr, sStr] = currentDOP.split('-');
        const targetTotal = parseInt(uStr) + parseInt(sStr);
        // Exclude Belt Tender from 'onClock' count for DOP check
        const dopActiveCount = staffing.filter(s => 
            (s.status === 'active' || s.status === 'paused') && s.role !== 'Belt Tender'
        ).length;
        
        const diff = dopActiveCount - targetTotal;
        const statusBar = byId('dop-status-bar');
        
        if (diff === 0) {
            statusBar.className = 'dop-status dop-ok';
            statusBar.innerText = `DOP Met âœ…`;
        } else if (diff > 0) {
            statusBar.className = 'dop-status dop-over';
            statusBar.innerText = `DOP Over (+${diff})`;
        } else {
            statusBar.className = 'dop-status dop-warn';
            statusBar.innerText = `DOP Under (-${Math.abs(diff)})`;
        }
    }
    
    function toggleMoveOther(selectEl) {
        const input = byId('move-custom-other');
        if(input) {
            input.style.display = (selectEl.value === 'Other') ? 'block' : 'none';
            if(selectEl.value==='Other') input.focus();
        }
    }
    
    function openMoveMenu() { 
        closeModal('active-detail-modal'); 
        byId('move-dest-select').value = 'Small Sort';
        toggleMoveOther(byId('move-dest-select'));
        byId('move-menu-modal').style.display = 'flex'; 
    }
    
    function confirmMoveDoor() {
        let dest = byId('move-dest-select').value;
        if(dest === 'Other') dest = byId('move-custom-other').value.trim();
        if(!dest) return alert("Please specify a destination");
        moveDoor(dest);
    }

    function addSavedAccount() {
        const val = byId('new-account-input').value.trim().toUpperCase();
        if(val && !savedAccounts.includes(val)) {
            savedAccounts.push(val); saveAccounts(); renderSavedAccounts(); updateAccountDatalist();
            byId('new-account-input').value = '';
        }
    }
    function removeAccount(acct) { savedAccounts = savedAccounts.filter(a => a !== acct); saveAccounts(); renderSavedAccounts(); updateAccountDatalist(); }
    function renderSavedAccounts() {
        const list = byId('saved-accounts-list'); list.innerHTML = '';
        if(savedAccounts.length===0) return list.innerHTML = '<div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div>';
        savedAccounts.forEach(acct => {
            const div = document.createElement('div'); div.className = 'saved-acct-item';
            div.innerHTML = `<span>${acct}</span><i class="ph ph-minus-circle delete-acct-btn" onclick="removeAccount('${acct}')"></i>`;
            list.appendChild(div);
        });
    }
    function updateAccountDatalist() {
        const dl = byId('saved-accounts-datalist'); dl.innerHTML = '';
        savedAccounts.forEach(acct => { const opt = document.createElement('option'); opt.value = acct; dl.appendChild(opt); });
    }

    function toggleSwitch(id) {
        const el = byId('switch-'+id); el.classList.toggle('checked');
        const checked = el.classList.contains('checked');
        if(id==='demo-mode') { demoActive = checked; updateTabBadges(); }
        if(id==='demo-replenish') config.replenish = checked;
        if(id==='demo-random') config.randomHistory = checked;
        if(id==='mixed-types') config.mixedTypes = checked;
        if(id==='disable-times') config.disableTimes = checked;
        if(id==='sim-window') config.simulateWindow = checked;
        if(id==='dis-window') { config.disableWindow = checked; attributionConfig.enabled = !checked; }
        renderDashboard();
    }

    function stepDoor(delta) {
        let val = parseInt(byId('demo-door-val').innerText) + delta;
        if(val<1) val=1; if(val>8) val=8;
        byId('demo-door-val').innerText = val; config.doorCount = val;
    }
    function setDemoType(t) { config.demoType = t; byId('seg-wally').classList.toggle('selected', t==='Wally'); byId('seg-cpu').classList.toggle('selected', t==='CPU'); }
    
    function startDemo() {
        demoActive = true;
        for(let i=DOORS_START; i<=DOORS_END; i++) if(doors[i].status==='empty' && (i-DOORS_START)<config.doorCount) randomArrival(i);
        saveDoors(); alert("Demo Started"); switchTab('dashboard'); updateTabBadges();
    }
    
    function randomArrival(doorNum) {
        let type = config.mixedTypes ? (Math.random()>0.5?'Wally':'CPU') : config.demoType;
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        const unloader = teamNames[Math.floor(Math.random() * teamNames.length)];
        doors[doorNum] = { status: 'active', start: Date.now(), id: id.toUpperCase(), account: type==='CPU'?"DEMO"+Math.floor(Math.random()*100):"", type: type, unloader: unloader, unavailable: false, lastCompletionTime: null, cpuOptions: [], assignments: [{ name: unloader, start: Date.now(), end: null }] };
        renderDashboard(); updateTabBadges();
    }

    function getShiftStartTime() { return localStorage.getItem('ps9_shift_start') || "19:55"; }
    function saveShiftStart(val) { localStorage.setItem('ps9_shift_start', val); renderDashboard(); }
    
    function getShiftTimeWindows() {
        if (config.disableTimes) {
             const now = new Date(), start = new Date(now); start.setMinutes(0,0,0);
             return { thisHourStart: start, thisHourEnd: new Date(start.getTime()+3600000), lastHourStart: new Date(start.getTime()-3600000), lastHourEnd: start, shiftStart: new Date(now.setHours(20,0,0,0)) };
        }
        const [h, m] = getShiftStartTime().split(':').map(Number);
        const now = new Date(); let start = new Date(now); start.setHours(h, m, 0, 0);
        if (now < start) start.setDate(start.getDate() - 1);
        const hoursElapsed = Math.floor((now - start) / 3600000);
        const thisHourStart = new Date(start.getTime() + (hoursElapsed * 3600000));
        return { thisHourStart, thisHourEnd: new Date(thisHourStart.getTime() + 3600000), lastHourStart: new Date(thisHourStart.getTime() - 3600000), lastHourEnd: thisHourStart, shiftStart: start };
    }

    function getCompletionHour(ts) {
        const { shiftStart } = getShiftTimeWindows();
        return Math.floor((ts - shiftStart.getTime()) / 3600000) + 1;
    }

    function populateUnloaderSelect() {
        const ids = ['select-unloader', 'edit-select-unloader', 'edit-active-unloader', 'filter-unloader-select', 'req-unloader-select'];
        ids.forEach(id => {
            const el = byId(id); if(!el) return;
            const isFilter = id === 'filter-unloader-select';
            el.innerHTML = isFilter ? '<option value="All">All Unloaders</option>' : '<option value="" selected>Unassigned</option>';
            teamNamesSorted.forEach(name => {
                const opt = document.createElement('option'); opt.value = name; opt.innerText = name; el.appendChild(opt);
            });
            if(!isFilter) el.innerHTML += '<option value="Custom">Custom / Other</option>';
        });
    }

    function openAddUnloaderModal() { byId('input-new-unloader-name').value=''; byId('add-unloader-modal').style.display='flex'; }
    function confirmAddUnloader() {
        const val = byId('input-new-unloader-name').value.trim();
        if(val){
            const cap = val.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            if(!teamNames.includes(cap)){
                teamNames.push(cap); refreshTeamNamesSorted(); saveTeam(); populateUnloaderSelect();
            }
            closeModal('add-unloader-modal');
        }
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
        byId(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
        if(btn) btn.classList.add('active');
        else {
             const icons=document.querySelectorAll('.tab-btn');
             const idx = ['dashboard','active','logs','staffing','tools','settings'].indexOf(tabId);
             if(idx>=0) icons[idx].classList.add('active');
        }
        
        if(tabId==='staffing') {
            renderStaffingView();
            if(!staffingInterval) staffingInterval = setInterval(updateStaffingTimers, 1000);
        } else {
            if(staffingInterval) { clearInterval(staffingInterval); staffingInterval = null; }
        }

        if(tabId==='dashboard') renderDashboard();
        if(tabId==='active') renderActiveTab();
        if(tabId==='logs') { currentVisibleLogs = 50; renderLogs(); }
    }

    function closeModal(id) { const m = byId(id); if(m) m.style.display='none'; window.scrollTo(0,0); }
    function checkDuplicateWally(id) {
        const { shiftStart } = getShiftTimeWindows();
        return historyLog.find(l => l.type === 'Wally' && l.id === id && l.end >= shiftStart.getTime());
    }

    function continueWithDuplicate() {
        closeModal('duplicate-wally-modal');
        if (pendingWallyDuplicate) {
            const { doorNum, wallyId, unloader, startTime } = pendingWallyDuplicate;
            doors[doorNum] = { status: 'active', start: startTime, id: wallyId, account: "", type: 'Wally', unloader: unloader || "Unassigned", isDuplicate: true, unavailable: false, lastCompletionTime: null, cpuOptions: [], assignments: [{ name: unloader||"Unassigned", start: startTime, end: null }] };
            if(isFirstOnboard) { isFirstOnboard = false; localStorage.setItem('ps9_is_first_onboard', 'false'); }
            saveDoors(); closeModal('input-modal'); renderDashboard(); updateTabBadges(); showSaveToast(); pendingWallyDuplicate = null;
        }
    }

    function confirmCompleteDoor() { 
        if(detailDoor) completeDoor(detailDoor); 
    }
    
    function completeDoor(doorNum, force = false) {
        const d = doors[doorNum];
        
        if (!force && (!d.unloader || d.unloader === 'Unassigned')) {
             closeModal('active-detail-modal');
             byId('req-unloader-select').value = "";
             byId('unloader-required-modal').style.display = 'flex';
             return;
        }
        
        const now = new Date(), mins = now.getMinutes();
        const { shiftStart } = getShiftTimeWindows();
        const win = attributionConfig.minutes;
        const shouldCheck = !config.disableWindow && (now - shiftStart > 3600000) && attributionConfig.enabled && win > 0 && (mins <= win || config.simulateWindow);
        if (shouldCheck) {
            byId('attribution-window-text').textContent = `00-${win.toString().padStart(2,'0')}`;
            pendingCompletion = { doorNum, time: now.getTime() };
            byId('hour-attribution-modal').style.display = 'flex';
        } else finalizeCompletion(doorNum, now.getTime(), 0);
    }
    
    function checkReqCustom(s) { byId('req-custom-unloader').style.display = s.value === 'Custom' ? 'block' : 'none'; }
    
    function saveRequiredUnloader() {
        let unl = byId('req-unloader-select').value;
        if(unl === 'Custom') unl = byId('req-custom-unloader').value.trim();
        if(!unl) return alert("Please select an unloader");
        
        if(unl !== "Unassigned" && unl === byId('req-custom-unloader').value.trim()) {
            unl = unl.toLowerCase().split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
        }
        
        const d = doors[detailDoor];
        d.unloader = unl;
        if(d.assignments.length > 0) {
            if (d.assignments[d.assignments.length-1].name === 'Unassigned') {
                 d.assignments[d.assignments.length-1].name = unl;
            } else {
                 d.assignments.push({ name: unl, start: Date.now(), end: null });
            }
        } else {
             d.assignments = [{ name: unl, start: d.start, end: null }];
        }
        saveDoors();
        closeModal('unloader-required-modal');
        completeDoor(detailDoor, true);
    }

    function resolveAttribution(choice) {
        closeModal('hour-attribution-modal');
        if (!pendingCompletion) return;
        let offset = 0;
        if (choice === 'Previous') offset = (new Date(pendingCompletion.time).getMinutes() + 1) * 60000;
        finalizeCompletion(pendingCompletion.doorNum, pendingCompletion.time, offset);
        pendingCompletion = null;
    }

    function openMoveMenu() { closeModal('active-detail-modal'); byId('move-menu-modal').style.display = 'flex'; }
    function moveDoor(destination) {
        closeModal('move-menu-modal');
        const d = doors[detailDoor];
        
        const now = Date.now();
        if(d.assignments && d.assignments.length > 0) {
            const last = d.assignments[d.assignments.length - 1];
            if(!last.end) last.end = now;
        }

        historyLog.unshift({
            door: detailDoor, id: d.id, account: d.account||"", type: d.type, unloader: d.unloader,
            start: d.start, end: now, dateKey: dateKeyFromTs(now), duration: now - d.start,
            durationMinutes: Math.round((now - d.start)/60000), statOffset: 0,
            logId: Date.now().toString(36), duplicate: false,
            completionHour: getCompletionHour(now),
            cpuOptions: d.cpuOptions || [],
            status: 'moved',
            moveDest: destination
        });

        doors[detailDoor] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: now, assignments: [] };
        saveDoors(); saveHistory(); renderDashboard(); renderActiveTab(); updateTabBadges(); showSaveToast();
    }

    function finalizeCompletion(doorNum, endTime, offset) {
        const d = doors[doorNum];
        let start = d.start;
        
        if(d.assignments && d.assignments.length > 0) {
            const last = d.assignments[d.assignments.length - 1];
            if(!last.end) last.end = endTime;
        }

        const durationMap = {};
        
        const realAssignments = (d.assignments || []).filter(a => a.name && a.name !== 'Unassigned');
        let startedBy = (realAssignments.length > 0) ? realAssignments[0].name : null;
        
        if (d.assignments && d.assignments.length > 0) {
            d.assignments.forEach(a => {
                if (a.name === 'Unassigned') return;
                const dur = (a.end || endTime) - a.start;
                if (!durationMap[a.name]) durationMap[a.name] = 0;
                durationMap[a.name] += dur;
            });
        } else {
            if(d.unloader !== 'Unassigned') durationMap[d.unloader] = endTime - start;
        }

        let primaryUnloader = d.unloader;
        let maxDur = -1;
        Object.keys(durationMap).forEach(name => {
            if (durationMap[name] > maxDur) {
                maxDur = durationMap[name];
                primaryUnloader = name;
            }
        });
        
        if (!primaryUnloader || primaryUnloader === 'Unassigned') primaryUnloader = "Unknown";

        const assistants = Object.keys(durationMap).filter(n => n !== primaryUnloader);

        if(config.randomHistory && demoActive) {
             const {shiftStart} = getShiftTimeWindows();
             endTime = Math.floor(Math.random()*(Date.now()-shiftStart.getTime()) + shiftStart.getTime());
             start = endTime - (Math.floor(Math.random()*30+15)*60000); offset=0;
        }

        if (d.type === 'CPU' && d.account && !savedAccounts.includes(d.account.trim().toUpperCase())) {
            savedAccounts.push(d.account.trim().toUpperCase()); saveAccounts(); updateAccountDatalist();
        }

        historyLog.unshift({
            door: doorNum, id: d.id, account: d.account||"", type: d.type, unloader: primaryUnloader,
            startedBy: startedBy, assistants: assistants,
            start: start, end: endTime, dateKey: dateKeyFromTs(endTime), duration: endTime - start,
            durationMinutes: Math.round((endTime - start)/60000), statOffset: offset,
            logId: Date.now().toString(36), duplicate: d.isDuplicate||false,
            completionHour: getCompletionHour(endTime - offset),
            cpuOptions: d.cpuOptions || [],
            status: 'completed'
        });
        
        if (d.type === 'Wally' && navigator.share && !demoActive) {
             navigator.share({ text: `Door ${doorNum} done` }).catch(e=>{});
        }
        closeModal('active-detail-modal');

        doors[doorNum] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: endTime, assignments: [] };
        saveDoors(); saveHistory(); renderDashboard(); renderActiveTab(); updateTabBadges(); showSaveToast();
        if (demoActive && config.replenish) setTimeout(() => { if (doors[doorNum].status === 'empty') randomArrival(doorNum); }, 7000);
    }

    function updateStats() {
        const { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd } = getShiftTimeWindows();
        let tw=0, tc=0, hw=0, lhw=0;
        historyLog.forEach(l => {
            if (l.status && l.status !== 'completed') return; 

            const t = l.end - (l.statOffset || 0); 
            if (l.type === 'Wally') {
                tw++;
                if (t >= thisHourStart.getTime() && t < thisHourEnd.getTime()) hw++;
                else if (t >= lastHourStart.getTime() && t < lastHourEnd.getTime()) lhw++;
            } else tc++;
        });
        byId('stat-total-wally').innerText = tw; byId('stat-total-cpu').innerText = tc;
        byId('stat-hour-wally').innerText = hw; byId('stat-last-wally').innerText = lhw;
    }

    // --- RENDER DASHBOARD ---
    function renderDashboard() {
        updateStats();
        const openGrid = byId('open-bays-grid'), activeGrid = byId('active-trailers-grid');
        openGrid.innerHTML = ''; activeGrid.innerHTML = '';
        let hasOpen = false, hasActive = false;

        for(let i=DOORS_START; i<=DOORS_END; i++) {
            const d = doors[i];
            const btn = document.createElement('div');
            btn.className = `bay-circle bay-${i} ${d.unavailable ? 'unavailable' : ''}`;
            btn.dataset.door = i; 

            if (d.status === 'active') {
                hasActive = true;
                btn.innerHTML = `${i}<div class="type-badge ${d.type==='Wally'?'badge-w':'badge-c'}">${d.type==='Wally'?'W':'C'}</div>`;
                if (d.start > 0) {
                     const min = (Date.now() - d.start) / 60000;
                     if (min > 60) btn.classList.add('status-crit');
                     else if (min > 45) btn.classList.add('status-warn');
                     else btn.classList.add('status-ok');
                }
                activeGrid.appendChild(btn);
            } else {
                hasOpen = true;
                btn.innerText = i;
                if (d.lastCompletionTime && d.status === 'empty' && !d.unavailable) {
                    const idle = Math.floor((Date.now() - d.lastCompletionTime) / 60000);
                    btn.innerHTML += `<div class="bay-timer">${idle}m</div>`;
                }
                openGrid.appendChild(btn);
            }
        }
        if(!hasOpen) openGrid.innerHTML = '<div class="empty-state-text">All bays full.</div>';
        if(!hasActive) activeGrid.innerHTML = '<div class="empty-state-text">No active trailers.</div>';
    }

    function renderActiveTab() {
        const list = byId('active-tab-list'); list.innerHTML = '';
        let hasActive = false;
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(doors[i].status === 'active') {
                hasActive = true;
                const d = doors[i], start = new Date(d.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                list.innerHTML += `<div class="active-card"><div class="active-card-info"><div class="active-card-header"><span class="door-pill">Door ${i}</span><span class="active-card-title">${d.type} ${d.id}</span></div><div class="active-card-details">${d.unloader}${d.account ? ' | '+d.account : ''}</div><div class="active-card-time">Started: ${start}</div></div><div class="active-card-actions"><button class="icon-btn" onclick="openEditActiveModal(${i})"><i class="ph ph-pencil-simple"></i></button><button class="btn-primary" style="width:auto; padding:10px 16px; margin:0;" onclick="completeDoor(${i})">Finish</button></div></div>`;
            }
        }
        if(!hasActive) list.innerHTML = '<div style="text-align:center; color:#999; margin-top:40px;">No active trailers</div>';
    }

    function openActiveDetails(doorNum) {
        detailDoor = doorNum; const d = doors[doorNum];
        byId('detail-door-num').innerText = doorNum;
        byId('detail-type').innerText = d.type;
        byId('detail-id').innerText = d.id;
        byId('detail-unloader').innerText = d.unloader || "Unassigned";
        
        // Show Started By if different (and filter Unassigned)
        const realAssignments = (d.assignments || []).filter(a => a.name && a.name !== 'Unassigned');
        let startedBy = (realAssignments.length > 0) ? realAssignments[0].name : null;

        const startedRow = byId('row-started-by');
        if (startedBy && startedBy !== d.unloader) {
            startedRow.style.display = 'flex';
            byId('detail-started-by').innerText = startedBy;
        } else {
            startedRow.style.display = 'none';
        }

        byId('detail-time').innerText = new Date(d.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        byId('detail-duration').innerText = Math.floor((Date.now() - d.start)/60000) + "m";
        const ar = byId('row-account');
        if (d.account) { ar.style.display = 'flex'; byId('detail-account').innerText = d.account; } else ar.style.display = 'none';
        
        const rowOpts = byId('row-cpu-opts');
        if (d.type === 'CPU' && d.cpuOptions && d.cpuOptions.length > 0) {
            rowOpts.style.display = 'flex';
            byId('detail-cpu-opts').innerText = d.cpuOptions.join(', ');
        } else {
            rowOpts.style.display = 'none';
        }

        byId('active-detail-modal').style.display = 'flex';
    }

    function openEditActiveModalFromDetail() { closeModal('active-detail-modal'); openEditActiveModal(detailDoor); }
    function openEditActiveModal(doorNum) {
        const d = doors[doorNum];
        byId('edit-active-original-door').value = doorNum;
        byId('edit-active-id').value = d.id;
        byId('edit-active-account').value = d.account || "";
        const us = byId('edit-active-unloader'); us.value = d.unloader || "";
        if(us.selectedIndex === -1) { us.value = 'Custom'; checkActiveCustomUnloader(us); byId('edit-active-custom-unloader').value = d.unloader; }
        else checkActiveCustomUnloader(us);
        setEditActiveType(d.type);
        
        const opts = d.cpuOptions || [];
        byId('edit-active-chk-hott').checked = opts.includes('HOTT');
        byId('edit-active-chk-recycle').checked = opts.includes('RECYCLE');
        byId('edit-active-chk-gv').checked = opts.includes('GV');

        const sel = byId('edit-active-door-select'); sel.innerHTML = '';
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(i===doorNum || doors[i].status==='empty') {
                const opt = document.createElement('option'); opt.value = i; opt.innerText = `Bay ${i}`; if(i===doorNum) opt.selected=true; sel.appendChild(opt);
            }
        }
        setSwitchType('Replacement');
        byId('edit-active-modal').style.display = 'flex';
    }

    function setEditActiveType(t) { 
        byId('active-opt-wally').classList.toggle('selected', t==='Wally'); 
        byId('active-opt-cpu').classList.toggle('selected', t==='CPU'); 
        byId('edit-active-modal').dataset.type = t; 
        const optsContainer = byId('edit-active-options-container');
        if(optsContainer) optsContainer.style.display = (t === 'CPU') ? 'block' : 'none';
    }
    
    function setSwitchType(t) {
        currentSwitchType = t;
        byId('seg-replace').classList.toggle('selected', t === 'Replacement');
        byId('seg-assist').classList.toggle('selected', t === 'Assist');
    }

    function checkActiveCustomUnloader(s) { 
        byId('edit-active-custom-unloader').style.display = s.value === 'Custom' ? 'block' : 'none'; 
        byId('edit-active-assist-option').style.display = 'block';
    }

    function saveActiveEdit() {
        const orig = parseInt(byId('edit-active-original-door').value), dest = parseInt(byId('edit-active-door-select').value);
        let unl = byId('edit-active-unloader').value;
        if(unl === 'Custom') unl = byId('edit-active-custom-unloader').value.trim();
        if (!unl) unl = "Unassigned";
        else if (unl !== "Unassigned" && unl === byId('edit-active-custom-unloader').value.trim()) unl = unl.toLowerCase().split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
        
        const type = byId('edit-active-modal').dataset.type;
        let cpuOpts = [];
        if(type === 'CPU') {
            if(byId('edit-active-chk-hott').checked) cpuOpts.push('HOTT');
            if(byId('edit-active-chk-recycle').checked) cpuOpts.push('RECYCLE');
            if(byId('edit-active-chk-gv').checked) cpuOpts.push('GV');
        }

        const d = doors[orig];
        const now = Date.now();
        let newAssignments = [...(d.assignments || [])];
        
        if (d.unloader !== unl) {
            if (newAssignments.length > 0) {
                newAssignments[newAssignments.length - 1].end = now;
            }
            const entryName = (currentSwitchType === 'Assist') ? `${unl} (Assist)` : unl;
            newAssignments.push({ name: entryName, start: now, end: null });
        }

        const data = { 
            status: 'active', start: doors[orig].start, id: byId('edit-active-id').value.trim().toUpperCase(), 
            account: byId('edit-active-account').value.trim().toUpperCase(), type: type, unloader: unl, 
            unavailable: false, lastCompletionTime: doors[orig].lastCompletionTime, cpuOptions: cpuOpts,
            assignments: newAssignments
        };

        if(dest !== orig) { doors[dest] = data; doors[orig] = {status:'empty', start:0, id:'', type:'', unloader:'', unavailable: false, lastCompletionTime: doors[orig].lastCompletionTime, assignments:[]}; }
        else doors[orig] = data;
        saveDoors(); closeModal('edit-active-modal'); renderActiveTab(); renderDashboard(); updateTabBadges(); showSaveToast();
    }

    function checkCustomUnloader(s) { byId('input-custom-unloader').style.display = s.value === 'Custom' ? 'block' : 'none'; }
    function confirmArrival() {
        const idVal = currentType === 'Wally' ? byId('input-wally-id').value : byId('input-trailer-id').value;
        if(!idVal) return alert("Missing ID");
        const fId = idVal.toUpperCase(), fAcc = (currentType==='CPU'?byId('input-account-id').value:'').toUpperCase();
        let unl = byId('select-unloader').value;
        if(unl === 'Custom') { unl = byId('input-custom-unloader').value; if(unl) unl = unl.toLowerCase().split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }
        
        if (currentType === 'Wally') {
            const dup = checkDuplicateWally(fId);
            if (dup) {
                pendingWallyDuplicate = { doorNum: currentDoor, wallyId: fId, unloader: unl||"Unassigned", startTime: Date.now() };
                byId('dup-wally-id').textContent = fId; byId('dup-door').textContent = `Door ${dup.door}`;
                byId('dup-time').textContent = new Date(dup.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); byId('dup-unloader').textContent = dup.unloader;
                byId('duplicate-wally-modal').style.display = 'flex'; 
                return;
            }
        }

        let cpuOpts = [];
        if (currentType === 'CPU') {
            if(byId('chk-hott').checked) cpuOpts.push('HOTT');
            if(byId('chk-recycle').checked) cpuOpts.push('RECYCLE');
            if(byId('chk-gv').checked) cpuOpts.push('GV');
        }

        let startTime = Date.now(), cTime = byId('input-onboard-time').value;
        if (cTime) {
            const now = new Date(), [h, m] = cTime.split(':').map(Number);
            const d = new Date(now); d.setHours(h, m, 0, 0);
            if (d > now) d.setDate(d.getDate() - 1); startTime = d.getTime();
        }
        doors[currentDoor] = { 
            status: 'active', start: startTime, id: fId, account: fAcc, type: currentType, 
            unloader: unl||"Unassigned", isDuplicate: false, unavailable: false, 
            lastCompletionTime: null, cpuOptions: cpuOpts,
            assignments: [{ name: unl||"Unassigned", start: startTime, end: null }]
        };
        if(isFirstOnboard) { isFirstOnboard = false; localStorage.setItem('ps9_is_first_onboard', 'false'); }
        saveDoors(); closeModal('input-modal'); renderDashboard(); updateTabBadges(); showSaveToast();
    }

    function openArrivalModal(specificDoor = null) {
        if (specificDoor) currentDoor = specificDoor;
        else {
             currentDoor = null;
             for(let i=DOORS_START; i<=DOORS_END; i++) if(doors[i].status==='empty'&&!doors[i].unavailable) { currentDoor=i; break; }
        }
        if(!currentDoor) return alert("No bays available!");
        byId('modal-door-num').innerText = currentDoor;
        byId('input-wally-id').value = ''; byId('input-trailer-id').value = ''; byId('input-account-id').value = '';
        byId('select-unloader').value = ""; byId('input-custom-unloader').style.display = 'none';
        
        byId('chk-hott').checked = false;
        byId('chk-recycle').checked = false;
        byId('chk-gv').checked = false;

        const tIn = byId('input-onboard-time');
        if (isFirstOnboard && lastSortStartTime) tIn.value = lastSortStartTime;
        else { const now=new Date(); tIn.value = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }
        
        const form = byId('onboard-form-container'), msg = byId('unavailable-msg'), btn = byId('btn-toggle-availability');
        if (doors[currentDoor].unavailable) { form.style.display='none'; msg.style.display='block'; btn.innerText="Mark Available"; btn.style.background="#34c759"; btn.style.color="white"; btn.style.border="none"; }
        else { form.style.display='block'; msg.style.display='none'; btn.innerText="Mark Unavailable"; btn.style.background="white"; btn.style.color="#ff3b30"; btn.style.border="2px solid #e5e5ea"; }
        setType('Wally'); byId('input-modal').style.display = 'flex';
        if (!doors[currentDoor].unavailable) setTimeout(() => { const f=byId('input-wally-id'); if(f) f.focus(); }, 100);
    }

    function handleAvailabilityToggle() { doors[currentDoor].unavailable = !doors[currentDoor].unavailable; saveDoors(); renderDashboard(); showSaveToast(); closeModal('input-modal'); }
    function setType(t) {
        currentType = t;
        byId('opt-wally').classList.toggle('selected', t==='Wally'); 
        byId('opt-cpu').classList.toggle('selected', t==='CPU'); 
        byId('wally-inputs').style.display = t==='Wally'?'block':'none'; 
        byId('cpu-inputs').style.display = t==='CPU'?'block':'none';
    }

    function viewStatLogs(type) {
        closeModal('input-modal'); closeModal('active-detail-modal');
        activeLogFilter = { door: 'All', type: 'All', timeRange: 'All', unloader: 'All', search: '', date: 'All' };
        if(type==='Wally'||type==='CPU') activeLogFilter.type = type;
        else if(type==='Hour-0') { activeLogFilter.timeRange = 'ThisHour'; activeLogFilter.type = 'Wally'; }
        else if(type==='Hour-1') { activeLogFilter.timeRange = 'LastHour'; activeLogFilter.type = 'Wally'; }
        switchTab('logs');
    }
    function viewDoorLogs(n) { closeModal('input-modal'); closeModal('active-detail-modal'); setLogFilter(n); switchTab('logs'); }
    function openFilterModal() {
        const g = byId('filter-grid'); g.innerHTML = `<div class="filter-btn ${currentLogFilter==='All'?'active':''}" onclick="setLogFilter('All')">All</div>`;
        for(let i=DOORS_START; i<=DOORS_END; i++) g.innerHTML += `<div class="filter-btn ${currentLogFilter==i?'active':''}" onclick="setLogFilter(${i})">Door ${i}</div>`;
        byId('filter-unloader-select').value = activeLogFilter.unloader;
        byId('filter-date-input').value = activeLogFilter.date !== 'All' ? activeLogFilter.date : '';
        byId('filter-modal').style.display='flex';
    }
    function applyFilter() {
        activeLogFilter.unloader = byId('filter-unloader-select').value;
        const d = byId('filter-date-input').value; activeLogFilter.date = d || 'All';
        closeModal('filter-modal'); renderLogs();
    }
    function clearLogFilter() { currentLogFilter='All'; activeLogFilter={door:'All',unloader:'All',type:'All',timeRange:'All',search:'',date:'All'}; byId('log-search').value=''; renderLogs(); }
    function setLogFilter(v) { currentLogFilter = v; activeLogFilter.door = v; renderLogs(); }
    
    function toggleStats(sec) {
        const c = byId(sec==='unloader'?'stats-content':'hourly-content'), i = byId(sec==='unloader'?'stats-caret':'hourly-caret');
        const show = c.style.display!=='block'; c.style.display=show?'block':'none'; i.className=show?'ph ph-caret-up':'ph ph-caret-down';
        if(show) sec==='unloader' ? calculateAndRenderStats() : calculateAndRenderHourlyStats();
    }
    function calculateAndRenderStats() {
         const stats = {};
         historyLog.forEach(l => { 
             if(l.status === 'moved') return;
             const n = l.unloader; if(!stats[n]) stats[n]={w:0,c:0,t:0}; if(l.type==='Wally') stats[n].w++; else stats[n].c++; stats[n].t++; 
         });
         const tb = byId('unloader-stats-body'); tb.innerHTML='';
         Object.entries(stats).sort((a,b)=>b[1].t-a[1].t).forEach(([n,d])=>tb.innerHTML+=`<tr><td>${n}</td><td style="text-align:center">${d.w}</td><td style="text-align:center">${d.c}</td><td style="text-align:right">${d.t}</td></tr>`);
    }
    function calculateAndRenderHourlyStats() {
        const { shiftStart } = getShiftTimeWindows(); const h = {};
        historyLog.forEach(l => { 
            if(l.status === 'moved') return;
            const idx = Math.floor((l.end-(l.statOffset||0)-shiftStart.getTime())/3600000)+1; if(!h[idx]) h[idx]=0; h[idx]++; 
        });
        const tb = byId('hourly-stats-body'); tb.innerHTML='';
        Object.keys(h).sort((a,b)=>a-b).forEach(k=>tb.innerHTML+=`<tr><td>${getHourText(parseInt(k))}</td><td style="text-align:center">${h[k]}</td></tr>`);
    }

    // --- OPTIMIZED RENDER LOGS ---
    let currentVisibleLogs = 50;
    let filteredLogsCache = []; 

    function renderLogs() {
        const list = byId('logs-list'); if(!list) return;
        const filterDisplay = byId('active-filter-display'), filterText = byId('filter-text-display');
        const sVal = byId('log-search').value.trim().toUpperCase(); activeLogFilter.search = sVal;
        
        const { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd } = getShiftTimeWindows();
        filteredLogsCache = historyLog.filter(l => {
            if (activeLogFilter.date !== 'All' && l.dateKey !== activeLogFilter.date) return false;
            if (activeLogFilter.door !== 'All' && l.door != activeLogFilter.door) return false;
            if (activeLogFilter.unloader !== 'All' && l.unloader !== activeLogFilter.unloader) return false;
            if (activeLogFilter.type !== 'All' && l.type !== activeLogFilter.type) return false;
            if (activeLogFilter.search && !l.id.includes(sVal) && !l.account.includes(sVal) && String(l.door)!=sVal) return false;
            if (activeLogFilter.timeRange !== 'All') {
                const t = l.end - (l.statOffset || 0);
                if (activeLogFilter.timeRange === 'ThisHour' && (t < thisHourStart.getTime() || t >= thisHourEnd.getTime())) return false;
                if (activeLogFilter.timeRange === 'LastHour' && (t < lastHourStart.getTime() || t >= lastHourEnd.getTime())) return false;
            }
            return true;
        });

        const isFiltering = Object.values(activeLogFilter).some(v => v !== 'All' && v !== '');
        if (filterDisplay) {
            filterDisplay.style.display = isFiltering ? 'flex' : 'none';
            if (isFiltering) {
                const p = [];
                if(activeLogFilter.date!=='All') p.push(activeLogFilter.date);
                if(activeLogFilter.door!=='All') p.push("Door "+activeLogFilter.door);
                if(activeLogFilter.unloader!=='All') p.push(activeLogFilter.unloader);
                if(activeLogFilter.type!=='All') p.push(activeLogFilter.type);
                if(activeLogFilter.search) p.push(`"${activeLogFilter.search}"`);
                filterText.innerText = p.join(' + ');
            }
        }

        list.innerHTML = '';
        currentVisibleLogs = 50; 
        renderLogBatch();
        
        if(statsVisible) calculateAndRenderStats();
        if(hourlyVisible) calculateAndRenderHourlyStats();
    }

    function renderLogBatch() {
        const list = byId('logs-list');
        const loadMore = byId('logs-load-more');
        
        if (filteredLogsCache.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">No logs found.</div>';
            loadMore.style.display = 'none';
            return;
        }

        const frag = document.createDocumentFragment();
        const batch = filteredLogsCache.slice(list.children.length, currentVisibleLogs);
        
        batch.forEach(l => {
            const card = document.createElement('div'); card.className = 'log-card';
            const dur = Math.round(l.duration/60000);
            
            // Build Type String
            let typeStr = l.type + (l.duplicate ? ' DUP' : '');
            if (l.type === 'CPU' && l.cpuOptions && l.cpuOptions.length > 0) {
                typeStr += ` (${l.cpuOptions.join(', ')})`;
            }
            
            // Handle Moved status
            let statusPill = '';
            if (l.status === 'moved') {
                statusPill = `<span class="log-tag tag-gray"><i class="ph ph-arrows-left-right"></i> ${l.moveDest}</span>`;
            } else {
                statusPill = `<span class="log-tag tag-black">${l.type}</span>`;
                if(l.duplicate) statusPill += ` <span class="log-tag tag-red">DUP</span>`;
                if (l.type === 'CPU' && l.cpuOptions && l.cpuOptions.length > 0) {
                     l.cpuOptions.forEach(opt => { statusPill += ` <span class="log-tag tag-gray">${opt}</span>`; });
                }
            }
            statusPill += `<span class="log-tag" style="background:#fff; border:1px solid #e5e5ea;">${getHourText(l.completionHour)}</span>`;

            // Build User String
            let userStr = l.unloader;
            let startStr = "";
            if (l.startedBy && l.startedBy !== l.unloader && l.startedBy !== 'Unassigned') {
                startStr = ` <span style="font-size:12px; color:#999;">(via ${l.startedBy})</span>`;
            }
            
            const timeRange = `${new Date(l.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${new Date(l.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;

            card.innerHTML = `
                <div class="log-info">
                    <div class="log-header-row">
                        <span class="log-door-pill" onclick="viewDoorLogs(${l.door})">Door ${l.door}</span>
                        <div class="log-title">${l.id}<span class="log-account">${l.account ? l.account : ''}</span></div>
                    </div>
                    <div class="log-tags-row">${statusPill}</div>
                    <div class="log-footer-row">
                        <div class="log-footer-item"><i class="ph ph-user"></i> ${userStr}${startStr}</div>
                        <div class="log-footer-item"><i class="ph ph-clock"></i> ${timeRange}</div>
                    </div>
                </div>
                <div class="log-right-col">
                    <div style="text-align:right;">
                        <div class="log-duration">${dur}<span style="font-size:14px; font-weight:700;">m</span></div>
                        <div class="log-duration-label">Duration</div>
                    </div>
                    <div class="log-actions-row">
                         ${(Date.now()-l.end < 120000 && !demoActive) ? `<button class="log-mini-btn" onclick="revertLog(${historyLog.indexOf(l)})"><i class="ph ph-arrow-u-up-left"></i></button>` : ''}
                        <button class="log-mini-btn" onclick="openEditLogModal(${historyLog.indexOf(l)})"><i class="ph ph-pencil-simple"></i></button>
                    </div>
                </div>
            `;
            frag.appendChild(card);
        });
        
        list.appendChild(frag);
        loadMore.style.display = (currentVisibleLogs < filteredLogsCache.length) ? 'block' : 'none';
    }

    function loadMoreLogs() {
        currentVisibleLogs += 50;
        renderLogBatch();
    }

    function revertLog(i) {
        const l = historyLog[i];
        if(!l || (Date.now()-l.end>120000 && !demoActive) || doors[l.door].status!=='empty') return alert("Cannot revert");
        doors[l.door] = { 
            status:'active', start:l.start, id:l.id, account:l.account, type:l.type, 
            unloader:l.unloader, unavailable:false, lastCompletionTime:null, 
            cpuOptions: l.cpuOptions || [], assignments: [{name: l.unloader, start: l.start, end: null}] 
        };
        historyLog.splice(i, 1); saveDoors(); saveHistory(); renderDashboard(); renderLogs(); updateTabBadges();
    }

    function openEditLogModal(i) {
        const l = historyLog[i]; byId('edit-log-index').value = i; byId('edit-input-id').value = l.id;
        const sel = byId('edit-select-unloader'); sel.innerHTML='<option value="">Unassigned</option>';
        teamNamesSorted.forEach(n => { const o=document.createElement('option'); o.value=n; o.innerText=n; sel.appendChild(o); });
        sel.value = l.unloader;
        setEditType(l.type);
        
        const opts = l.cpuOptions || [];
        byId('edit-log-chk-hott').checked = opts.includes('HOTT');
        byId('edit-log-chk-recycle').checked = opts.includes('RECYCLE');
        byId('edit-log-chk-gv').checked = opts.includes('GV');

        byId('edit-log-modal').style.display='flex';
    }

    function confirmLogEdit() {
        const i = parseInt(byId('edit-log-index').value), id = byId('edit-input-id').value.toUpperCase(), unl = byId('edit-select-unloader').value;
        const type = byId('edit-log-modal').dataset.type;
        
        let cpuOpts = [];
        if(type === 'CPU') {
            if(byId('edit-log-chk-hott').checked) cpuOpts.push('HOTT');
            if(byId('edit-log-chk-recycle').checked) cpuOpts.push('RECYCLE');
            if(byId('edit-log-chk-gv').checked) cpuOpts.push('GV');
        }

        historyLog[i].id = id; historyLog[i].unloader = unl; historyLog[i].type = type; historyLog[i].cpuOptions = cpuOpts;
        saveHistory(); closeModal('edit-log-modal'); renderLogs();
    }

    function openExportModal() { byId('export-modal').style.display = 'flex'; }
    function exportLogsCSV() {
        closeModal('export-modal');
        let csv = "Type,ID,Account,Door,Unloader,StartedBy,Duration(mins),StartTime,EndTime,StartHour,EndHour,Duplicate,Hour,Options,Status\n";
        historyLog.forEach(l => {
            const opts = (l.cpuOptions || []).join(';');
            csv += `${l.type},${l.id},${l.account||''},${l.door},${l.unloader},${l.startedBy||''},${Math.round(l.duration/60000)},${new Date(l.start).toLocaleString()},${new Date(l.end).toLocaleString()},${new Date(l.start).getHours()},${new Date(l.end).getHours()},${l.duplicate?'Yes':'No'},${l.completionHour},${opts},${l.status||'completed'}\n`
        });
        const a = document.createElement('a'); a.href=window.URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download='wally-logs.csv'; a.click();
    }
    
    function exportLogsPDF() {
        closeModal('export-modal');
        if (!window.jspdf) return alert("PDF library loading. Please wait or check connection.");
        const doc = new window.jspdf.jsPDF(), now = new Date();
        doc.setFontSize(18); doc.text(`PS9 Wally Tracker Report - ${now.toLocaleDateString()}`, 14, 20);
        doc.setFontSize(12); doc.text(`Generated: ${now.toLocaleTimeString()}`, 14, 30);
        
        const stats={}; historyLog.forEach(l=>{ 
            if(l.status === 'moved') return;
            const n=l.unloader; if(!stats[n])stats[n]={w:0,c:0,t:0}; if(l.type==='Wally')stats[n].w++; else stats[n].c++; stats[n].t++; 
        });
        doc.autoTable({ startY: 45, head:[['Name','Wally','CPU','Total']], body:Object.entries(stats).sort((a,b)=>b[1].t-a[1].t).map(([n,d])=>[n,d.w,d.c,d.t]) });
        
        const logsBody = historyLog.map(l => {
             let typeStr = l.type + (l.duplicate?' (DUP)':'');
             if(l.status === 'moved') typeStr = `MOVED: ${l.moveDest}`;
             else if(l.type === 'CPU' && l.cpuOptions && l.cpuOptions.length>0) typeStr += `\n${l.cpuOptions.join(',')}`;
             
             let uStr = l.unloader;
             if(l.startedBy && l.startedBy !== l.unloader && l.startedBy !== 'Unassigned') uStr += `\n(Start: ${l.startedBy})`;

             return [new Date(l.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), l.door, typeStr, l.id, uStr, Math.round(l.duration/60000)+"m", getHourText(l.completionHour)];
        });
        doc.autoTable({ startY: doc.lastAutoTable.finalY+15, head:[['Time','Door','Type','ID','Unloader','Duration','Hour']], body:logsBody });
        doc.save(`wally-report-${now.toISOString().split('T')[0]}.pdf`);
    }

    // --- PPH CALCULATOR ---
    function openPPHModal() {
        const hrs = calculateUnloaderHours(), inp = byId('pph-unloader-hours-input');
        inp.value = hrs>0?hrs.toFixed(2):''; byId('pph-volume-input').value=''; byId('pph-result').innerText='0';
        byId('pph-modal').style.display='flex';
        setTimeout(()=>hrs>0?byId('pph-volume-input').focus():inp.focus(), 100);
    }
    function resetPPH() {
        const hrs = calculateUnloaderHours(), inp = byId('pph-unloader-hours-input');
        inp.value = hrs>0?hrs.toFixed(2):''; byId('pph-volume-input').value=''; byId('pph-result').innerText='0';
        hrs===0?inp.focus():byId('pph-volume-input').focus();
    }
    function calculateUnloaderHours() {
        const now = Date.now(); let t = 0;
        staffing.forEach(s => { if(s.role==='Unloader') t += (s.accumulated||0) + ((s.status==='active'&&s.start)?(now-s.start):0); });
        return t/3600000;
    }
    function calculatePPH() {
        const v = parseFloat(byId('pph-volume-input').value)||0, h = parseFloat(byId('pph-unloader-hours-input').value)||0;
        byId('pph-result').innerText = h===0 ? '0' : Math.round(v/h).toLocaleString();
    }
    function setEditType(t) { 
        byId('edit-opt-wally').classList.toggle('selected', t==='Wally'); 
        byId('edit-opt-cpu').classList.toggle('selected', t==='CPU'); 
        byId('edit-log-modal').dataset.type = t; 
        const c = byId('edit-log-options-container');
        if(c) c.style.display = (t === 'CPU') ? 'block' : 'none';
    }

    init();
</script>
</body>
</html>
