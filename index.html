<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WallyTracker">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Wally Dashboard</title>

    <style>
        :root {
            --primary: #000000;
            --bg: #ffffff;
            --card-bg: #f5f5f5;
            --text-main: #000000;
            --text-sub: #757575;
            --safe-top: max(env(safe-area-inset-top), 47px);
            --safe-bottom: env(safe-area-inset-bottom);
            --tab-height: 80px;
            --bay-green: #4cd964;
            --bay-purple: #bf5af2;
            --bay-orange: #ff9500;
            --bay-red: #ff3b30;
        }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            -webkit-font-smoothing: antialiased;
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: calc(var(--safe-top) + 40px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 0 20px;
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 20px);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content.active { display: block; }

        /* --- BUTTONS & ACTIONS --- */
        .top-actions {
            display: flex;
            gap: 12px;
            padding: 10px 0 20px 0;
            justify-content: center;
        }

        .action-btn {
            background: #000;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center; gap: 8px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.96); }

        /* --- HEADER --- */
        .dashboard-header {
            background: #f2f2f7;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            margin-bottom: 30px;
            margin-top: 10px;
        }

        .header-bar {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            margin: 20px 0 20px 0;
        }
        .header-bar h1 { font-size: 24px; font-weight: 800; margin: 0; }

        .header-right { position: absolute; right: 0; display: flex; gap: 10px; }

        .filter-icon-btn, .export-icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; transition: background 0.1s;
        }
        .filter-icon-btn { border: 2px solid #000; background: transparent; color: #000; }
        .export-icon-btn { border: none; background: #f2f2f7; color: #000; }

        .app-title { font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
        .app-subtitle { font-size: 15px; color: var(--text-sub); margin-top: 4px; font-style: italic; }
        .app-version { font-size: 12px; color: #bbb; margin-top: 4px; font-weight: 600; }

        .section-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: #000; text-align: center; }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card {
            background: var(--card-bg); border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 90px; cursor: pointer; transition: transform 0.1s;
        }
        .stat-card:active { transform: scale(0.98); background: #ebebeb; }
        .stat-label { font-size: 13px; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 32px; font-weight: 800; color: #000; line-height: 1; }

        /* --- BAYS GRID --- */
        .bays-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 40px; min-height: 60px; }
        .empty-state-text { color: var(--text-sub); font-size: 16px; font-weight: 500; text-align: center; width: 100%; padding: 20px 0; }

        .bay-circle {
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 800; color: #000;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative; box-sizing: border-box;
        }
        .bay-circle:active { transform: scale(0.92); }
        .bay-circle.status-ok { border: 4px solid #34c759; }
        .bay-circle.status-warn { border: 4px solid #ff9500; }
        .bay-circle.status-crit { border: 4px solid #ff3b30; }

        .bay-9 { background-color: var(--bay-green); }
        .bay-10 { background-color: var(--bay-purple); }
        .bay-11 { background-color: var(--bay-orange); }
        .bay-12 { background-color: var(--bay-purple); }
        .bay-13 { background-color: var(--bay-orange); }
        .bay-14 { background-color: var(--bay-orange); }
        .bay-15 { background-color: var(--bay-orange); }
        .bay-16 { background-color: var(--bay-orange); }

        .type-badge { position: absolute; bottom: -2px; right: -2px; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: white; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.15); background: #000; }

        /* --- STAFFING --- */
        .staffing-header-card { background: #000; color: #fff; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .staffing-header-title { font-size: 14px; opacity: 0.8; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .staffing-header-val { font-size: 32px; font-weight: 800; }
        .dop-container { margin-bottom: 20px; background: #fff; border: 1px solid #e5e5ea; border-radius: 16px; padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; }
        .dop-row { display: flex; justify-content: space-between; align-items: center; }
        .dop-label { font-size: 14px; font-weight: 700; color: #000; }
        .dop-select { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; }
        .dop-status { font-size: 13px; font-weight: 700; text-align: center; padding: 8px; border-radius: 8px; }
        
        .dop-ok { background: #dcfce7; color: #166534; }
        .dop-under { background: #ffedd5; color: #9a3412; }
        .dop-over { background: #fee2e2; color: #991b1b; }

        .staff-section-title { font-size: 18px; font-weight: 800; margin: 25px 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .staff-count-badge { background: #e5e5ea; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px; }
        .staff-card { background: white; border: 1px solid #e5e5ea; border-radius: 18px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .staff-name { font-size: 17px; font-weight: 700; color: #000; }
        .staff-hours { font-size: 16px; font-weight: 800; color: #000; font-variant-numeric: tabular-nums; }
        .role-select { width: 100%; padding: 8px; background: #f2f2f7; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: #000; margin-top: 4px; outline: none; }
        .staff-checkbox-list { max-height: 250px; overflow-y: auto; border: 1px solid #e5e5ea; border-radius: 12px; background: #f9f9f9; padding: 5px; }
        .staff-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid #e5e5ea; }
        .staff-check-label { display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; font-size: 16px; font-weight: 500; }
        .staff-other-input { background: #fff; border: 1px solid #000; padding: 8px; border-radius: 8px; font-size: 13px; width: 100px; color: #000; margin-left: 5px; display: none; }

        /* --- NAV --- */
        .tab-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; background: white; border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: center; height: 70px; z-index: 1000; padding-bottom: 0; }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 11px; font-weight: 600; width: 60px; cursor: pointer; gap: 4px; position: relative; }
        .tab-btn i { font-size: 26px; }
        .tab-btn.active { color: #000; }
        .tab-badge { position: absolute; top: -4px; right: 0; background: #ff3b30; color: white; font-size: 10px; font-weight: 800; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid white; }
        .tab-badge.zero { display: none; }

        .save-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .save-toast.visible { opacity: 1; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; border-top-left-radius: 28px; border-top-right-radius: 28px; padding: 30px; padding-bottom: max(40px, var(--safe-bottom)); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-input { width: 100%; padding: 18px; background: #f2f2f7; border: none; border-radius: 16px; font-size: 18px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .btn-primary { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 17px; font-weight: 800; background: #000; color: white; margin-top: 10px; cursor: pointer; }
        .btn-cancel { background: transparent; color: var(--text-sub); width: 100%; padding: 15px; border: none; font-size: 16px; font-weight: 600; margin-top: 5px; cursor: pointer; }
        
        .icon-btn { background: #f2f2f7; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #000; font-size: 20px; }
        .log-card { background: white; border: 1px solid #e5e5ea; border-radius: 20px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px; }
        .log-door-pill { background: #000; color: #fff; font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 8px; }
        .log-title { font-size: 20px; font-weight: 900; color: #000; }
        .log-duration { font-size: 24px; font-weight: 900; color: #000; }
    </style>
</head>
<body>

<input type="file" id="restore-file-input" accept=".json" onchange="restoreData(this)" style="display:none">

<div id="save-toast" class="save-toast"><i class="ph ph-check-circle"></i> <span>Saved</span></div>

<div class="app-container">
    <div id="tab-dashboard" class="tab-content active">
        <div class="top-actions">
            <button class="action-btn" onclick="openStartSortFlow()"><i class="ph ph-play-circle"></i> Start Sort</button>
            <button class="action-btn" onclick="openArrivalModal()"><i class="ph ph-truck"></i> Onboard</button>
        </div>

        <div class="dashboard-header">
            <h1 class="app-title">Wally Dashboard</h1>
            <div class="app-subtitle">by Fitz Joseph</div>
            <div class="app-version">Version 3.54</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" onclick="switchTab('logs')"><div class="stat-label">Wallies</div><div class="stat-value" id="stat-total-wally">0</div></div>
            <div class="stat-card" onclick="switchTab('logs')"><div class="stat-label">CPUs</div><div class="stat-value" id="stat-total-cpu">0</div></div>
            <div class="stat-card" onclick="switchTab('logs')"><div class="stat-label">This Hour</div><div class="stat-value" id="stat-hour-wally">0</div></div>
            <div class="stat-card" onclick="switchTab('logs')"><div class="stat-label">Last Hour</div><div class="stat-value" id="stat-last-wally">0</div></div>
        </div>

        <div class="section-title">Active Trailers</div>
        <div id="active-trailers-grid" class="bays-grid"></div>
        <div class="section-title">Open Bays</div>
        <div id="open-bays-grid" class="bays-grid"></div>
        <div style="height: 100px;"></div>
    </div>

    <div id="tab-staffing" class="tab-content">
        <div class="header-bar">
            <h1>Staffing</h1>
            <div class="header-right"><button class="icon-btn" onclick="openAddStaffModal()"><i class="ph ph-plus"></i></button></div>
        </div>

        <div class="dop-container">
            <div class="dop-row">
                 <span class="dop-label">Operating Plan</span>
                 <select id="dop-select" class="dop-select" onchange="saveDOP(this.value)">
                    <option value="5-2">5-2</option><option value="6-2">6-2</option><option value="7-2">7-2</option><option value="8-2">8-2</option>
                </select>
            </div>
            <div id="dop-status-bar" class="dop-status">Checking...</div>
        </div>

        <div class="staffing-header-card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><div class="staffing-header-title">Active Staff</div><div class="staffing-header-val" id="staff-active-count">0</div></div>
                <div style="text-align:right;"><div class="staffing-header-title">Unloader Hours</div><div class="staffing-header-val" id="staff-total-hours">0.0</div></div>
            </div>
        </div>

        <div id="staff-list-active"></div>
        <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">Loaned Out <span class="staff-count-badge" id="badge-loaned">0</span></div>
        <div id="staff-list-loaned"></div>
        <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">Off Clock <span class="staff-count-badge" id="badge-off-clock">0</span></div>
        <div id="staff-list-cut"></div>
    </div>

    <div id="tab-logs" class="tab-content">
        <div class="header-bar"><h1>Logs</h1></div>
        <div id="logs-list"></div>
    </div>
    
    <div id="tab-tools" class="tab-content"><div class="header-bar"><h1>Tools</h1></div><button class="btn-primary" onclick="openPPHModal()">PPH Calculator</button></div>
    <div id="tab-settings" class="tab-content"><div class="header-bar"><h1>Settings</h1></div><button class="btn-primary" onclick="resetData()">Factory Reset</button></div>
</div>

<nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard', this)"><i class="ph ph-chart-pie-slice"></i><span>Home</span></button>
    <button class="tab-btn" onclick="switchTab('staffing', this)"><i class="ph ph-users"></i><span>Staffing</span><span class="tab-badge" id="badge-staffing">0</span></button>
    <button class="tab-btn" onclick="switchTab('logs', this)"><i class="ph ph-list-dashes"></i><span>Logs</span></button>
    <button class="tab-btn" onclick="switchTab('tools', this)"><i class="ph ph-toolbox"></i><span>Tools</span></button>
    <button class="tab-btn" onclick="switchTab('settings', this)"><i class="ph ph-gear"></i><span>Settings</span></button>
</nav>

<div class="modal-overlay" id="add-staff-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center;">Clock In Staff <span id="staff-selection-count" style="font-size:14px; color:#8e8e93; font-weight:500; margin-left:10px;">0 Selected</span></h2>
        <div id="staff-checkbox-list" class="staff-checkbox-list"></div>
        <div style="margin-top:15px; padding-top:10px; border-top: 1px solid #eee;">
            <input type="text" id="staff-custom-name" class="form-input" placeholder="Custom Name">
            <select id="staff-custom-role" class="form-input"><option value="Unloader">Unloader</option><option value="Belt Tender">Belt Tender</option><option value="Bulk Sweep">Bulk Sweep</option></select>
        </div>
        <button class="btn-primary" onclick="confirmAddStaff()">Clock In</button>
        <button class="btn-cancel" onclick="closeModal('add-staff-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="pph-modal">
    <div class="modal-sheet">
        <h2>PPH Calculator</h2>
        <input type="number" id="pph-volume-input" class="form-input" placeholder="Total Volume" oninput="calculatePPH()">
        <div style="text-align:center; padding:20px;"><div style="font-size:14px; color:#757575;">Current PPH</div><div style="font-size:48px; font-weight:900;" id="pph-result">0</div></div>
        <button class="btn-cancel" onclick="closeModal('pph-modal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="input-modal">
    <div class="modal-sheet">
        <h2>Onboard Bay <span id="modal-door-num"></span></h2>
        <input type="text" id="input-arrival-id" class="form-input" placeholder="ID #">
        <button class="btn-primary" onclick="confirmArrival()">Start Unload</button>
        <button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button>
    </div>
</div>

<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script>
    // --- GLOBAL STATE ---
    let doors = {}, historyLog = [], teamNames = [], staffing = [], currentDOP = '5-2', currentDoor = null;
    const DOORS_START = 9, DOORS_END = 16;
    const DEFAULT_TEAM = ["David F", "Lorena R", "Matt R", "Matt S", "Robert W", "Trevon C", "Victor M", "Russell H", "Fonseca J"];

    // --- UTILS ---
    const byId = (id) => document.getElementById(id);
    function showToast() { const t = byId('save-toast'); t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }
    function closeModal(id) { byId(id).style.display = 'none'; }
    function getShiftTimeWindows() {
        const now = new Date(); let start = new Date(now); start.setHours(19, 55, 0, 0);
        if (now < start) start.setDate(start.getDate() - 1);
        return { thisHourStart: start };
    }

    // --- INIT ---
    function init() {
        if(localStorage.getItem('ps9_doors')) doors = JSON.parse(localStorage.getItem('ps9_doors'));
        else for(let i=DOORS_START; i<=DOORS_END; i++) doors[i] = { status: 'empty', start: 0, id: '', type: 'Wally' };
        
        if(localStorage.getItem('ps9_history')) historyLog = JSON.parse(localStorage.getItem('ps9_history'));
        if(localStorage.getItem('ps9_team')) teamNames = JSON.parse(localStorage.getItem('ps9_team')); else teamNames = [...DEFAULT_TEAM];
        if(localStorage.getItem('ps9_staffing')) staffing = JSON.parse(localStorage.getItem('ps9_staffing'));
        if(localStorage.getItem('ps9_dop')) currentDOP = localStorage.getItem('ps9_dop');

        renderDashboard();
        updateStaffingTimers(); // Start DOP Logic immediately
        setInterval(updateStaffingTimers, 5000);
        updateTabBadges();
    }

    // --- LOGIC ---
    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        byId(`tab-${id}`).classList.add('active');
        if(btn) btn.classList.add('active');
        if(id === 'staffing') updateStaffingTimers();
        if(id === 'logs') renderLogs();
    }

    function saveDOP(val) { currentDOP = val; localStorage.setItem('ps9_dop', currentDOP); updateStaffingTimers(); showToast(); }

    function updateStaffSelectionCount() {
        const count = document.querySelectorAll('.staff-checkbox:checked').length;
        byId('staff-selection-count').innerText = `${count} Selected`;
    }

    function openAddStaffModal() {
        const container = byId('staff-checkbox-list'); container.innerHTML = '';
        teamNames.sort().forEach(n => {
            if(!staffing.find(s => s.name === n && s.status !== 'cut')) {
                container.innerHTML += `<div class="staff-item-row"><label class="staff-check-label"><input type="checkbox" value="${n}" class="staff-checkbox" onchange="updateStaffSelectionCount()"> ${n}</label></div>`;
            }
        });
        updateStaffSelectionCount();
        byId('add-staff-modal').style.display = 'flex';
    }

    function confirmAddStaff() {
        const cbs = document.querySelectorAll('.staff-checkbox:checked');
        const customName = byId('staff-custom-name').value.trim();
        cbs.forEach(cb => {
            let role = (cb.value === "Robert W") ? "Belt Tender" : "Unloader";
            staffing.push({ id: Date.now()+Math.random(), name: cb.value, status: 'active', role: role, start: Date.now(), manualOverride: (role==="Belt Tender"), accumulated: 0 });
        });
        if(customName) staffing.push({ id: Date.now()+Math.random(), name: customName, status: 'active', role: byId('staff-custom-role').value, start: Date.now(), manualOverride: true, accumulated: 0 });
        localStorage.setItem('ps9_staffing', JSON.stringify(staffing));
        closeModal('add-staff-modal'); renderStaffingView(); updateStaffingTimers(); updateTabBadges();
    }

    function renderStaffingView() {
        autoAssignRoles();
        const list = byId('staff-list-active'); list.innerHTML = '';
        const active = staffing.filter(s => s.status === 'active' || s.status === 'paused');
        active.forEach(s => {
            const div = document.createElement('div'); div.className = 'staff-card';
            div.innerHTML = `<div class="staff-top-row"><div class="staff-name">${s.name} â€¢ ${s.role}</div><div class="staff-hours" id="hrs-${s.id}">${calculateTotalHours(s).toFixed(2)}h</div><button class="staff-action-btn" onclick="cutStaff(${s.id})">CUT</button></div>`;
            list.appendChild(div);
        });
    }

    function cutStaff(id) {
        const s = staffing.find(x => x.id === id);
        if(s) { s.status = 'cut'; s.accumulated += (Date.now() - s.start); s.start = null; localStorage.setItem('ps9_staffing', JSON.stringify(staffing)); renderStaffingView(); updateStaffingTimers(); updateTabBadges(); }
    }

    function calculateTotalHours(s) {
        let ms = s.accumulated || 0;
        if(s.status === 'active' && s.start) ms += (Date.now() - s.start);
        return ms / 3600000;
    }

    function autoAssignRoles() {
        const active = staffing.filter(s => s.status === 'active' || s.status === 'paused');
        active.sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));
        let belts = active.filter(s => s.manualOverride && s.role === 'Belt Tender').length;
        let sweeps = active.filter(s => s.manualOverride && s.role === 'Bulk Sweep').length;
        active.forEach(s => {
            if(!s.manualOverride) {
                if(belts < 1) { s.role = 'Belt Tender'; belts++; }
                else if(sweeps < 2) { s.role = 'Bulk Sweep'; sweeps++; }
                else s.role = 'Unloader';
            }
        });
    }

    function updateStaffingTimers() {
        autoAssignRoles();
        if(byId('tab-staffing').classList.contains('active')) renderStaffingView();
        
        let activeUHours = 0, onClock = 0;
        staffing.forEach(s => {
            if(s.status === 'active' || s.status === 'paused') {
                onClock++;
                if(s.role === 'Unloader') activeUHours += calculateTotalHours(s);
            }
        });
        byId('staff-active-count').innerText = onClock;
        byId('staff-total-hours').innerText = activeUHours.toFixed(2);

        // DOP STATUS LOGIC
        const [uStr, sStr] = currentDOP.split('-');
        const target = parseInt(uStr) + parseInt(sStr);
        const dopCount = staffing.filter(s => (s.status === 'active' || s.status === 'paused') && s.role !== 'Belt Tender').length;
        const diff = dopCount - target;
        const bar = byId('dop-status-bar');
        
        if (diff === 0) { bar.className = 'dop-status dop-ok'; bar.innerText = 'DOP Met'; }
        else if (diff > 0) { bar.className = 'dop-status dop-over'; bar.innerText = `DOP Over (+${diff})`; }
        else { bar.className = 'dop-status dop-under'; bar.innerText = `DOP Under (-${Math.abs(diff)})`; }
    }

    function renderDashboard() {
        const ag = byId('active-trailers-grid'), og = byId('open-bays-grid');
        ag.innerHTML = ''; og.innerHTML = '';
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            const d = doors[i];
            const div = document.createElement('div'); div.className = `bay-circle bay-${i}`;
            if(d.status === 'active') { div.innerHTML = `${i}<div class="type-badge">${d.type==='Wally'?'W':'C'}</div>`; ag.appendChild(div); }
            else { div.innerText = i; og.appendChild(div); div.onclick = () => openArrivalModal(i); }
        }
    }

    function renderLogs() {
        const list = byId('logs-list'); list.innerHTML = '';
        historyLog.slice(0, 20).forEach(l => {
            list.innerHTML += `<div class="log-card"><div><span class="log-door-pill">Door ${l.door}</span> <span class="log-title">${l.id}</span></div><div class="log-duration">${Math.round((l.end-l.start)/60000)}m</div></div>`;
        });
    }

    function updateTabBadges() {
        const activeCount = Object.values(doors).filter(d => d.status === 'active').length;
        byId('badge-staffing').innerText = staffing.filter(s=>s.status==='active').length;
        byId('badge-staffing').classList.toggle('zero', byId('badge-staffing').innerText === "0");
    }

    function openArrivalModal(i) { currentDoor = i; byId('modal-door-num').innerText = i; byId('input-modal').style.display='flex'; }
    function confirmArrival() { const id = byId('input-arrival-id').value.toUpperCase(); if(!id) return; doors[currentDoor] = { status:'active', id, start:Date.now(), type:'Wally' }; localStorage.setItem('ps9_doors', JSON.stringify(doors)); closeModal('input-modal'); renderDashboard(); }
    function resetData() { if(confirm("Reset all?")) { localStorage.clear(); location.reload(); } }
    function openStartSortFlow() { alert("Shift Started"); }
    function calculatePPH() { const v = byId('pph-volume-input').value; const h = parseFloat(byId('staff-total-hours').innerText); byId('pph-result').innerText = h > 0 ? Math.round(v/h) : 0; }
    function openPPHModal() { byId('pph-modal').style.display = 'flex'; }

    init();
</script>
</body>
</html>
