<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WallyTracker">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Wally Dashboard</title>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #000000;
            --bg: #ffffff;
            --card-bg: #f5f5f5;
            --text-main: #000000;
            --text-sub: #757575;
            --accent-blue: #000000;

            /* Circle Colors */
            --bay-green: #4cd964;
            --bay-purple: #bf5af2;
            --bay-orange: #ff9500;
            --bay-red: #ff3b30;

            /* Safe Area Variables */
            --safe-top: max(env(safe-area-inset-top), 47px);
            --safe-bottom: env(safe-area-inset-bottom);
            --tab-height: 80px;
        }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            -webkit-font-smoothing: antialiased;
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: calc(var(--safe-top) + 40px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 0 20px;
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 20px);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .tab-content.active { display: block; }

        /* --- BUTTONS & ACTIONS --- */
        .top-actions {
            display: flex;
            gap: 12px;
            padding: 10px 0 20px 0;
            justify-content: center;
        }

        .action-btn {
            background: #000;
            color: white;
            border: none;
            border-radius: 50px; /* Streamlined Pill Shape */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-btn i {
            font-size: 18px;
        }

        /* --- HEADER --- */
        .dashboard-header {
            background: #f2f2f7;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            margin-bottom: 30px;
            margin-top: 10px;
        }

        .header-bar {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            margin: 20px 0 20px 0;
        }

        .header-bar h1 {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
        }

        .header-right {
            position: absolute;
            right: 0;
            display: flex;
            gap: 10px;
        }

        .filter-icon-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #000;
            border-radius: 50%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .filter-icon-btn:active {
            background: #f0f0f0;
        }

        .export-icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #f2f2f7;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 20px;
            cursor: pointer;
        }

        .app-title { font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
        .app-subtitle { font-size: 15px; color: var(--text-sub); margin-top: 4px; font-style: italic; }
        .app-version { font-size: 12px; color: #bbb; margin-top: 4px; font-weight: 600; }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 20px;
            color: #000;
            text-align: center;
        }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 90px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .stat-card:active { transform: scale(0.98); background: #ebebeb; }

        .stat-label { font-size: 13px; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 32px; font-weight: 800; color: #000; line-height: 1; }

        /* --- BAYS GRID --- */
        .bays-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 40px;
            min-height: 60px;
        }

        .empty-state-text {
            color: var(--text-sub);
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            width: 100%;
            padding: 20px 0;
        }

        .bay-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: #000;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            box-sizing: border-box; /* Important for border */
        }

        .bay-circle:active { transform: scale(0.92); }

        .bay-circle.unavailable {
            background-color: #8e8e93 !important;
            opacity: 0.5;
            color: #666;
            border: none !important;
        }

        .bay-circle.unavailable .bay-timer {
            color: #666;
        }

        .bay-9 { background-color: var(--bay-green); }
        .bay-10 { background-color: var(--bay-purple); }
        .bay-11 { background-color: var(--bay-orange); }
        .bay-12 { background-color: var(--bay-purple); }
        .bay-13 { background-color: var(--bay-orange); }
        .bay-14 { background-color: var(--bay-orange); }
        .bay-15 { background-color: var(--bay-orange); }
        .bay-16 { background-color: var(--bay-orange); }

        .type-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 900;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .badge-w { background-color: #000; }
        .badge-c { background-color: #000; }

        .bay-timer {
            position: absolute;
            bottom: -5px;
            font-size: 9px;
            font-weight: 700;
            color: #000;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 4px;
            border-radius: 4px;
            min-width: 20px;
            text-align: center;
        }

        /* --- ACTIVE TAB LIST --- */
        .active-tab-list { display: flex; flex-direction: column; gap: 15px; }

        .active-card {
            background: white;
            border: 2px solid #000;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .active-card-info { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        .active-card-header { display: flex; align-items: center; gap: 10px; }
        .active-card-title { font-size: 20px; font-weight: 800; color: #000; }
        .door-pill {
            background: #000; color: white;
            font-size: 12px; font-weight: 700;
            padding: 4px 10px; border-radius: 30px;
        }
        .active-card-details { font-size: 15px; color: var(--text-sub); font-weight: 500; }
        .active-card-time { font-size: 14px; color: #000; font-weight: 700; }

        .active-card-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .icon-btn {
            background: #f2f2f7;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: #000;
            font-size: 20px;
        }

        /* --- STAFFING TAB --- */
        .staffing-header-card {
            background: #000;
            color: #fff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .staffing-header-title { font-size: 14px; opacity: 0.8; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .staffing-header-val { font-size: 32px; font-weight: 800; }

        /* DOP Selector */
        .dop-container {
            margin-bottom: 20px;
            background: #fff;
            border: 1px solid #e5e5ea;
            border-radius: 16px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dop-label { font-size: 14px; font-weight: 700; color: #000; }
        .dop-select {
            background: #f2f2f7; border: none; padding: 8px 12px;
            border-radius: 8px; font-size: 14px; font-weight: 600;
        }

        .staff-section-title { font-size: 18px; font-weight: 800; margin: 25px 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .staff-count-badge { background: #e5e5ea; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px; }

        .staff-card {
            background: white; border: 1px solid #e5e5ea; border-radius: 18px;
            padding: 16px; margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .staff-card.cut { opacity: 0.6; background: #f9f9f9; }

        .staff-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .staff-name { font-size: 17px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 6px; }
        .staff-time { font-size: 13px; color: var(--text-sub); margin-top: 2px; }
        .staff-hours { font-size: 16px; font-weight: 800; color: #000; font-variant-numeric: tabular-nums; }

        .staff-action-btn {
            background: #ffe5e5; color: #ff3b30; border: none;
            padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 700;
            cursor: pointer;
        }

        .staff-delete-btn {
            background: transparent; color: #ff3b30; border: none;
            padding: 4px; font-size: 18px; cursor: pointer;
        }

        .role-select {
            width: 100%; padding: 8px; background: #f2f2f7; border: none;
            border-radius: 8px; font-size: 13px; font-weight: 600; color: #000;
            margin-top: 4px;
        }

        .suggestion-badge {
            font-size: 11px; padding: 2px 6px; border-radius: 4px;
            background: #000; color: #fff; font-weight: 700; margin-left: 6px;
        }

        /* Detailed Breakdowns for Staffing */
        .breakdown-row {
            display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7);
            margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Staff Multi-Select */
        .staff-checkbox-list {
            max-height: 250px; overflow-y: auto; border: 1px solid #e5e5ea;
            border-radius: 12px; background: #f9f9f9;
        }
        .staff-checkbox-item {
            display: flex; align-items: center; padding: 12px 16px;
            border-bottom: 1px solid #e5e5ea; cursor: pointer;
        }
        .staff-checkbox-item:last-child { border-bottom: none; }
        .staff-checkbox-item input { margin-right: 12px; width: 20px; height: 20px; accent-color: #000; }
        .staff-checkbox-item span { font-size: 16px; font-weight: 500; }

        /* --- TOOLS GRID --- */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 10px 0;
        }
        .tool-card {
            background: #fff;
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            aspect-ratio: 1 / 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .tool-card:active { transform: scale(0.96); background: #f9f9f9; }

        .tool-icon-wrapper {
            width: 50px; height: 50px;
            background: #000;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 24px;
            margin-bottom: 12px;
        }

        .tool-title { font-size: 16px; font-weight: 700; color: #000; margin-bottom: 4px; }
        .tool-desc { font-size: 12px; color: var(--text-sub); display: none; }

        /* Add Tool Card Special Style */
        .tool-card.add {
            border: 2px dashed #ccc;
            background: transparent;
            box-shadow: none;
        }
        .tool-card.add .tool-icon-wrapper {
            background: #e5e5ea;
            color: #000;
        }

        /* --- LOGS SECTION --- */
        .stats-collapse-btn {
            width: 100%;
            background: #f2f2f7;
            border: none;
            border-radius: 16px;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 700;
            color: #000;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .stats-content-area {
            background: white;
            border: 1px solid #e5e5ea;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        .stats-table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .stats-table th { text-align: left; color: var(--text-sub); font-weight: 600; padding-bottom: 12px; border-bottom: 1px solid #e5e5ea; }
        .stats-table td { padding: 12px 0; border-bottom: 1px solid #f9f9f9; color: #000; font-weight: 500; }
        .stats-table td:last-child { font-weight: 800; text-align: right; }

        .active-filter-display {
            display: flex; align-items: center; justify-content: space-between;
            background: #000; color: white; padding: 12px 20px;
            border-radius: 16px; margin-bottom: 20px; font-weight: 600;
        }

        .logs-list { display: flex; flex-direction: column; gap: 15px; }

        .log-card {
            background: white; border: 1px solid #e5e5ea; border-radius: 20px;
            padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .log-info { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        .log-door-pill {
            background: #000; color: #fff; font-size: 12px; font-weight: 700;
            padding: 4px 10px; border-radius: 30px; cursor: pointer;
        }
        .log-type-pill {
            font-size: 12px; font-weight: 800; padding: 4px 10px; border-radius: 30px;
            background: #000; color: #fff; margin-left: 6px;
        }
        .log-title { font-size: 18px; font-weight: 800; color: #000; }
        .log-details { font-size: 15px; color: var(--text-sub); }
        .log-timestamp { font-size: 14px; color: #000; font-weight: 700; margin-top: 4px; }
        .log-actions { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }

        .log-action-btn {
            background: #f2f2f7; border: 1px solid #000; border-radius: 12px;
            padding: 8px 14px; font-size: 13px; font-weight: 700;
            color: #000; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }

        /* Search Bar */
        .search-bar {
            width: 100%; padding: 14px;
            border: 1px solid #e5e5ea; border-radius: 12px;
            background: #f9f9f9; font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }

        /* --- BOTTOM NAV --- */
        .tab-bar {
            position: fixed; bottom: 30px; left: 20px; right: 20px;
            background: white; border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            height: 70px; z-index: 1000; padding-bottom: 0;
        }

        .tab-btn {
            background: none; border: none; display: flex; flex-direction: column; align-items: center;
            color: #ccc; font-size: 11px; font-weight: 600; width: 60px; cursor: pointer; gap: 4px;
            position: relative;
        }
        .tab-btn i { font-size: 26px; }
        .tab-btn.active { color: #000; }

        /* Tab Badge Styles */
        .tab-badge {
            position: absolute;
            top: -4px;
            right: 0;
            background: #ff3b30;
            color: white;
            font-size: 10px;
            font-weight: 800;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
        }

        .tab-badge.zero {
            background: #e5e5ea;
            color: #8e8e93;
        }

        .tab-badge.warning {
            background: #ff9500;
        }

        .tab-badge.success {
            background: #34c759;
        }

        /* Auto-Save Toast */
        .save-toast {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
            z-index: 3000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .save-toast.visible { opacity: 1; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .modal-sheet {
            background: white; width: 100%; max-width: 600px;
            border-top-left-radius: 28px; border-top-right-radius: 28px;
            padding: 30px; padding-bottom: max(40px, var(--safe-bottom));
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-input {
            width: 100%; padding: 18px; background: #f2f2f7; border: none;
            border-radius: 16px; font-size: 18px; margin-bottom: 15px;
            box-sizing: border-box; outline: none; appearance: none;
            color: #000; font-weight: 500;
        }

        .type-selector {
            display: flex; background: #f2f2f7; padding: 5px;
            border-radius: 16px; margin-bottom: 25px;
        }

        .type-opt {
            flex: 1; text-align: center; padding: 12px;
            border-radius: 12px; font-weight: 700; font-size: 15px;
            color: var(--text-sub); cursor: pointer;
        }

        .type-opt.selected {
            background: white; color: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-primary {
            width: 100%; padding: 18px; border-radius: 16px;
            border: none; font-size: 17px; font-weight: 800;
            background: #000; color: white; margin-top: 10px; cursor: pointer;
        }

        .btn-danger { background: #ff3b30; }
        .btn-history { background: #f2f2f7; color: #000; margin-top: 10px; }

        .btn-cancel {
            background: transparent; color: var(--text-sub); width: 100%;
            padding: 15px; border: none; font-size: 16px; font-weight: 600;
            margin-top: 5px; cursor: pointer;
        }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid #f2f2f7;
        }
        .detail-label { color: var(--text-sub); font-weight: 600; font-size: 15px; }
        .detail-value { font-weight: 700; color: #000; font-size: 15px; }

        .modal-actions-row { display: flex; gap: 15px; margin-top: 10px; }
        .modal-icon-btn {
            background: #f2f2f7; border: none; width: 56px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; cursor: pointer; color: #000;
        }

        .filter-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;
        }
        .filter-btn {
            background: #f2f2f7; padding: 15px 0; border-radius: 12px;
            text-align: center; font-weight: 700; font-size: 16px; cursor: pointer;
        }
        .filter-btn.active { background: #000; color: white; }

        /* Settings Styles */
        .settings-header {
            font-size: 22px; font-weight: 800; margin: 30px 0 10px 0; color: #000;
        }
        .settings-group {
            background: #fff; border-radius: 16px; overflow: hidden;
            margin-bottom: 20px; border: 1px solid #e5e5ea;
        }
        .settings-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 1px solid #f2f2f7; background: #fff;
        }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { font-size: 16px; font-weight: 600; color: #000; }

        .settings-input-inline {
            background: #f2f2f7; border: none; padding: 8px 12px;
            border-radius: 8px; font-size: 16px; width: 100px; text-align: right;
        }

        .settings-btn-inline {
            background: #000; color: #fff; border: none;
            border-radius: 8px; padding: 6px 12px; font-weight: 600; font-size: 14px;
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 50px; height: 30px; background: #e5e5ea;
            border-radius: 15px; position: relative; cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.checked { background: #000; }
        .toggle-switch::after {
            content: ''; position: absolute; left: 2px; top: 2px;
            width: 26px; height: 26px; background: white;
            border-radius: 50%; transition: left 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .toggle-switch.checked::after { left: 22px; }

        .stepper {
            display: flex; align-items: center; background: #f2f2f7;
            border-radius: 8px; padding: 2px;
        }
        .stepper-btn {
            width: 32px; height: 32px; border: none; background: transparent;
            font-size: 18px; font-weight: 700; cursor: pointer; color: #000;
        }
        .stepper-val {
            font-size: 16px; font-weight: 600; width: 24px; text-align: center;
        }

        .segment-control {
            display: flex; background: #f2f2f7; border-radius: 8px; padding: 2px;
        }
        .segment-opt {
            padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;
            color: #8e8e93; cursor: pointer;
        }
        .segment-opt.selected {
            background: #fff; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .settings-note {
            font-size: 13px; color: #8e8e93; padding: 0 10px; margin-bottom: 20px; line-height: 1.4;
        }

        .saved-accounts-list { padding: 0 20px 20px 20px; }
        .saved-acct-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f2f2f7; font-size: 16px; font-weight: 500;
        }
        .delete-acct-btn { color: #ff3b30; font-size: 20px; cursor: pointer; }

        /* Slider Styles */
        .settings-slider-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-value {
            font-size: 16px;
            font-weight: 700;
            color: #000;
            background: #f2f2f7;
            padding: 4px 10px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
        }

        .slider-wrapper {
            position: relative;
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .slider-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #e5e5ea;
            border-radius: 3px;
            z-index: 1;
        }

        .slider-fill {
            position: absolute;
            height: 6px;
            background: #000;
            border-radius: 3px;
            z-index: 2;
            transition: width 0.1s;
        }

        .slider-thumb {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #000;
            border-radius: 15px;
            z-index: 3;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            touch-action: none;
        }

        .slider-ticks {
            display: flex;
            justify-content: space-between;
            position: absolute;
            width: 100%;
            top: 25px;
            pointer-events: none;
        }

        .slider-tick {
            width: 1px;
            height: 8px;
            background: #ccc;
            position: relative;
        }

        .slider-tick-label {
            position: absolute;
            top: 12px;
            font-size: 11px;
            color: #8e8e93;
            transform: translateX(-50%);
            white-space: nowrap;
            font-weight: 600;
        }

        /* New hidden input for Restore feature */
        #restore-file-input { display: none; }
    </style>
</head>
<body>

<input type="file" id="restore-file-input" accept=".json" onchange="restoreData(this)">

<div id="save-toast" class="save-toast">
    <i class="ph ph-check-circle" style="color:#4cd964; font-size:16px;"></i>
    <span>Saved</span>
</div>

<div class="app-container">

    <div id="tab-dashboard" class="tab-content active">

        <div class="top-actions">
            <button class="action-btn" onclick="openStartSortFlow()">
                <i class="ph ph-play-circle"></i> Start Sort
            </button>
            <button class="action-btn" onclick="openAddUnloaderModal()">
                <i class="ph ph-user-plus"></i> Add Unloader
            </button>
            <button class="action-btn" onclick="openArrivalModal()">
                <i class="ph ph-truck"></i> Onboard
            </button>
        </div>

        <div class="dashboard-header">
            <h1 class="app-title">Wally Dashboard</h1>
            <div class="app-subtitle">by Fitz Joseph</div>
            <div class="app-version">Version 3.29</div>
        </div>

        <div class="section-title">Sort Statistics</div>
        <div class="stats-grid">
            <div class="stat-card" onclick="viewStatLogs('Wally')">
                <div class="stat-label">Total Wallies</div>
                <div class="stat-value" id="stat-total-wally">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('CPU')">
                <div class="stat-label">Total CPUs</div>
                <div class="stat-value" id="stat-total-cpu">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('Hour-0')">
                <div class="stat-label">Wallies This Hour</div>
                <div class="stat-value" id="stat-hour-wally">0</div>
            </div>
            <div class="stat-card" onclick="viewStatLogs('Hour-1')">
                <div class="stat-label">Wallies Last Hour</div>
                <div class="stat-value" id="stat-last-wally">0</div>
            </div>
        </div>

        <div class="section-title">Active Trailers</div>
        <div id="active-trailers-grid" class="bays-grid"></div>

        <div class="section-title">Open Bays</div>
        <div id="open-bays-grid" class="bays-grid"></div>

        <div style="height: 100px;"></div>
    </div>


    <div id="tab-active" class="tab-content">
        <div class="header-bar">
            <h1>Active Details</h1>
        </div>
        <div id="active-tab-list" class="active-tab-list"></div>
    </div>

    <div id="tab-logs" class="tab-content">
        <div class="header-bar">
            <h1>Logs</h1>
            <div class="header-right">
                <button class="filter-icon-btn" onclick="openFilterModal()">
                    <i class="ph ph-faders"></i>
                </button>
                <button class="export-icon-btn" onclick="openExportModal()">
                    <i class="ph ph-export"></i>
                </button>
            </div>
        </div>

        <input type="text" id="log-search" class="search-bar" placeholder="Search by Wally ID or Trailer..." oninput="renderLogs()">

        <button class="stats-collapse-btn" onclick="toggleStats('unloader')">
            Unloader Statistics
            <i class="ph ph-caret-down" id="stats-caret"></i>
        </button>

        <div id="stats-content" class="stats-content-area">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th style="text-align:center">Wally</th>
                        <th style="text-align:center">CPU</th>
                        <th style="text-align:right">Total</th>
                    </tr>
                </thead>
                <tbody id="unloader-stats-body"></tbody>
            </table>
        </div>

        <button class="stats-collapse-btn" onclick="toggleStats('hourly')">
            Hourly Breakdown
            <i class="ph ph-caret-down" id="hourly-caret"></i>
        </button>

        <div id="hourly-content" class="stats-content-area">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Hour</th>
                        <th style="text-align:center">Count</th>
                    </tr>
                </thead>
                <tbody id="hourly-stats-body"></tbody>
            </table>
        </div>

        <div id="active-filter-display" class="active-filter-display" style="display:none;">
            <span>Filtering: <span id="filter-text-display"></span></span>
            <i class="ph ph-x" style="cursor:pointer" onclick="clearLogFilter()"></i>
        </div>

        <div id="logs-list" class="logs-list"></div>
    </div>

    <div id="tab-staffing" class="tab-content">
        <div class="header-bar">
            <h1>Staffing</h1>
            <div class="header-right">
                <button class="action-btn" style="padding: 10px 16px; border-radius:20px; height:40px; font-size:14px;" onclick="openAddStaffModal()">
                    <i class="ph ph-plus"></i> Add
                </button>
            </div>
        </div>

        <div class="dop-container">
            <span class="dop-label">Daily Operating Plan</span>
            <select id="dop-select" class="dop-select" onchange="saveDOP(this.value)">
                <option value="5-2">5-2</option>
                <option value="6-2">6-2</option>
                <option value="7-2">7-2</option>
                <option value="8-2">8-2</option>
            </select>
        </div>

        <div class="staffing-header-card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <div class="staffing-header-title">Active Staff</div>
                    <div class="staffing-header-val" id="staff-active-count">0</div>
                </div>
                <div style="text-align:right;">
                    <div class="staffing-header-title">Unloader Hours</div>
                    <div class="staffing-header-val" id="staff-total-hours">0.0</div>
                </div>
            </div>

            <div class="breakdown-row">
                <span>Belt Hours: <span id="staff-belt-hours">0.0</span></span>
                <span>Sweep Hours: <span id="staff-sweep-hours">0.0</span></span>
            </div>
        </div>

        <div class="staff-section-title">
            On Clock <span class="staff-count-badge" id="badge-on-clock">0</span>
        </div>
        <div id="staff-list-active"></div>

        <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">
            Off Clock <span class="staff-count-badge" id="badge-off-clock">0</span>
        </div>
        <div id="staff-list-cut"></div>
    </div>

    <div id="tab-tools" class="tab-content" style="background:#f2f2f7;">
        <div style="background:white; padding: 20px 20px 10px 20px; border-bottom:1px solid #e5e5ea; margin: -20px -20px 20px -20px;">
             <div class="header-bar" style="margin:0;"><h1>Tools</h1></div>
        </div>

        <div class="tools-grid">
            <div class="tool-card" onclick="openPPHModal()">
                <div class="tool-icon-wrapper"><i class="ph ph-calculator"></i></div>
                <div class="tool-title">PPH Calculator</div>
            </div>

            <div class="tool-card" onclick="alert('Observation Corner coming soon')">
                <div class="tool-icon-wrapper"><i class="ph ph-eye"></i></div>
                <div class="tool-title">Observation</div>
            </div>

             <div class="tool-card add" onclick="alert('More tools soon')">
                <div class="tool-icon-wrapper"><i class="ph ph-plus"></i></div>
                <div class="tool-title">Add Tool</div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content" style="background:#f2f2f7; padding:0;">
        <div style="background:white; padding: 20px 20px 10px 20px; border-bottom:1px solid #e5e5ea;">
            <div class="header-bar" style="margin:0;">
                <h1>Settings</h1>
            </div>
        </div>

        <div style="padding: 20px 20px 120px 20px;">

            <div class="settings-header">Data Management</div>
            <div class="settings-group">
                <div class="settings-row" onclick="backupData('full')" style="cursor:pointer;">
                    <span class="settings-label">Save Full Backup File</span>
                    <i class="ph ph-download-simple" style="color:#000; font-size:20px;"></i>
                </div>
                 <div class="settings-row" onclick="backupData('logs')" style="cursor:pointer;">
                    <span class="settings-label">Backup Logs Only</span>
                    <i class="ph ph-file-text" style="color:#000; font-size:20px;"></i>
                </div>
                <div class="settings-row" onclick="triggerRestore()" style="cursor:pointer;">
                    <span class="settings-label">Restore from Backup</span>
                    <i class="ph ph-upload-simple" style="color:#000; font-size:20px;"></i>
                </div>
            </div>

            <div class="settings-header">Shift Configuration</div>
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-label">Shift Start Time</span>
                    <input type="time" id="setting-shift-start" class="settings-input-inline" onchange="saveShiftStart(this.value)">
                </div>

                <div class="settings-slider-container" style="border-top:1px solid #f2f2f7;">
                    <div class="slider-header">
                        <span class="settings-label">Attribution Window</span>
                        <span class="slider-value" id="attribution-value">5m</span>
                    </div>

                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-fill" id="slider-fill"></div>
                        <div class="slider-thumb" id="slider-thumb"></div>

                        <div class="slider-ticks">
                            <div class="slider-tick" style="left: 0%"><div class="slider-tick-label">0</div></div>
                            <div class="slider-tick" style="left: 50%"><div class="slider-tick-label">5</div></div>
                            <div class="slider-tick" style="left: 100%"><div class="slider-tick-label">10</div></div>
                        </div>
                    </div>

                    <div class="settings-note" style="margin-top:20px; padding:0;">
                        Allow attributing trailers completed up to <span id="attr-note-val" style="font-weight:700; color:#000;">5</span> minutes after the hour to the previous hour.
                    </div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Simulate Window (Test)</span>
                    <div class="toggle-switch" id="switch-sim-window" onclick="toggleSwitch('sim-window')"></div>
                </div>
                 <div class="settings-row">
                    <span class="settings-label">Disable Attribution</span>
                    <div class="toggle-switch" id="switch-dis-window" onclick="toggleSwitch('dis-window')"></div>
                </div>
            </div>

            <div class="settings-header">Saved Accounts</div>
            <div class="settings-group">
                <div class="settings-row">
                    <input type="text" id="new-account-input" class="form-input" style="margin:0; padding:10px; background:#f2f2f7; width:65%;" placeholder="New Account Number" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()">
                    <button class="settings-btn-inline" onclick="addSavedAccount()">Add</button>
                </div>
                <div id="saved-accounts-list" class="saved-accounts-list">
                    <div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div>
                </div>
            </div>

            <div class="settings-header">Demo</div>
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-label">Demo Mode</span>
                    <div class="toggle-switch" id="switch-demo-mode" onclick="toggleSwitch('demo-mode')"></div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Disable hardcoded times</span>
                    <div class="toggle-switch" id="switch-disable-times" onclick="toggleSwitch('disable-times')"></div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Randomize History (Demo)</span>
                    <div class="toggle-switch" id="switch-demo-random" onclick="toggleSwitch('demo-random')"></div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Auto re-onboard (Demo)</span>
                    <div class="toggle-switch" id="switch-demo-replenish" onclick="toggleSwitch('demo-replenish')"></div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Number of Doors</span>
                    <div class="stepper">
                        <button class="stepper-btn" onclick="stepDoor(-1)">âˆ’</button>
                        <span class="stepper-val" id="demo-door-val">2</span>
                        <button class="stepper-btn" onclick="stepDoor(1)">+</button>
                    </div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Mixed Types (Wally + CPU)</span>
                    <div class="toggle-switch" id="switch-mixed-types" onclick="toggleSwitch('mixed-types')"></div>
                </div>

                <div class="settings-row" style="justify-content:center; background:#f9f9f9;">
                    <div class="segment-control">
                        <div class="segment-opt selected" id="seg-wally" onclick="setDemoType('Wally')">Wally</div>
                        <div class="segment-opt" id="seg-cpu" onclick="setDemoType('CPU')">CPU</div>
                    </div>
                </div>

                <div style="padding:15px;">
                     <button class="btn-primary" style="background:#000; color:#fff;" onclick="startDemo()">Auto-Onboard</button>
                </div>
            </div>

            <div class="settings-header">Changelog</div>
            <div class="settings-group">
                <div class="settings-row" onclick="viewChangelog()" style="cursor:pointer;">
                    <span class="settings-label">View Version History</span>
                    <i class="ph ph-caret-right" style="color:#ccc;"></i>
                </div>
            </div>

            <button class="btn-primary" onclick="resetData()" style="background:#ff3b30; margin-bottom:100px;">Reset All Data</button>
        </div>
    </div>

</div>

<nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard', this)" id="tab-btn-dashboard">
        <i class="ph ph-chart-pie-slice"></i>
        <span>Home</span>
    </button>
    <button class="tab-btn" onclick="switchTab('active', this)" id="tab-btn-active">
        <i class="ph ph-truck-trailer"></i>
        <span>Active</span>
        <span class="tab-badge" id="badge-active">0</span>
    </button>
    <button class="tab-btn" onclick="switchTab('logs', this)" id="tab-btn-logs">
        <i class="ph ph-list-dashes"></i>
        <span>Logs</span>
    </button>
    <button class="tab-btn" onclick="switchTab('staffing', this)" id="tab-btn-staffing">
        <i class="ph ph-users"></i>
        <span>Staffing</span>
        <span class="tab-badge" id="badge-staffing">0</span>
    </button>
    <button class="tab-btn" onclick="switchTab('tools', this)" id="tab-btn-tools">
        <i class="ph ph-toolbox"></i>
        <span>Tools</span>
        <span class="tab-badge" id="badge-tools">0</span>
    </button>
    <button class="tab-btn" onclick="switchTab('settings', this)" id="tab-btn-settings">
        <i class="ph ph-gear"></i>
        <span>Settings</span>
        <span class="tab-badge" id="badge-settings">0</span>
    </button>
</nav>

<div class="modal-overlay" id="start-sort-modal-1">
    <div class="modal-sheet">
        <h2 style="text-align:center; margin-bottom:20px;">Start Sort (1/2)</h2>
        <div style="margin-bottom:20px;">
            <label class="settings-label" style="display:block; margin-bottom:10px;">Shift Start Time</label>
            <input type="time" id="start-sort-time" class="form-input" value="19:55">
        </div>
        <button class="btn-primary" onclick="nextSortStep()">Next</button>
        <button class="btn-cancel" onclick="closeModal('start-sort-modal-1')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="start-sort-modal-2">
    <div class="modal-sheet">
        <h2 style="text-align:center; margin-bottom:20px;">Start Sort (2/2)</h2>
        <div style="margin-bottom:20px;">
            <label class="settings-label" style="display:block; margin-bottom:10px;">Daily Operating Plan</label>
            <select id="start-sort-dop" class="form-input">
                <option value="5-2">5-2</option>
                <option value="6-2">6-2</option>
                <option value="7-2">7-2</option>
                <option value="8-2">8-2</option>
            </select>
        </div>
        <button class="btn-primary" onclick="finishStartSort()">Start Shift</button>
        <button class="btn-cancel" onclick="closeModal('start-sort-modal-2')">Back</button>
    </div>
</div>

<div class="modal-overlay" id="changelog-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Changelog</h2>
        <div id="changelog-content" style="max-height:300px; overflow-y:auto; font-size:14px; line-height:1.5; color:#333; white-space: pre-wrap;"></div>
        <button class="btn-cancel" onclick="closeModal('changelog-modal')" style="margin-top:20px;">Close</button>
    </div>
</div>

<div class="modal-overlay" id="pph-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">PPH Calculator</h2>

        <div style="background:#f2f2f7; border-radius:16px; padding:20px; margin-bottom:20px; text-align:center;">
            <div style="font-size:13px; color:#757575; font-weight:700; letter-spacing:0.5px; margin-bottom:5px;">TOTAL UNLOADER HOURS</div>
            <input type="number" id="pph-unloader-hours-input" class="form-input"
                   style="font-size:32px; font-weight:800; color:#000; text-align:center; background:transparent; border:none; width:100%; padding:0; margin:0;"
                   oninput="calculatePPH()" placeholder="0.00">
            <div style="font-size:12px; color:#757575; margin-top:4px;">Excludes Belt Tenders & Sweeps</div>
        </div>

        <div style="margin-bottom:20px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Total Volume</label>
            <input type="number" id="pph-volume-input" class="form-input" placeholder="Enter package count" oninput="calculatePPH()">
        </div>

        <div style="text-align:center; margin-bottom:30px;">
            <div style="font-size:14px; color:var(--text-sub); font-weight:700;">CURRENT PPH</div>
            <div style="font-size:60px; font-weight:900; color:#000; letter-spacing:-2px;" id="pph-result">0</div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="resetPPH()" style="background:#e5e5ea; color:#000; flex:1;">Reset</button>
            <button class="btn-cancel" onclick="closeModal('pph-modal')" style="flex:1; margin-top:0; border: 1px solid #e5e5ea; border-radius:16px; padding:18px;">Close</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="add-staff-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Clock In Staff</h2>
        <div style="margin-bottom:15px;">
             <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Select Employees</label>
             <div id="staff-checkbox-list" class="staff-checkbox-list"></div>
        </div>
        <div style="margin-bottom:15px;">
             <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Start Time Override (Optional)</label>
             <input type="time" id="staff-input-time" class="form-input">
             <div style="font-size:12px; color:#8e8e93; margin-top:4px;">Leave blank for current shift start time</div>
        </div>
        <button class="btn-primary" onclick="confirmAddStaff()">Clock In</button>
        <button class="btn-cancel" onclick="closeModal('add-staff-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="edit-staff-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Staff</h2>
        <input type="hidden" id="edit-staff-id">
        <div style="margin-bottom:15px;">
             <label class="settings-label">Start Time</label>
             <input type="time" id="edit-staff-time" class="form-input">
        </div>
        <button class="btn-primary" onclick="saveStaffEdit()">Save Changes</button>
        <button class="btn-cancel" onclick="closeModal('edit-staff-modal')">Discard</button>
    </div>
</div>

<div class="modal-overlay" id="export-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Export Data</h2>
        <button class="btn-primary" onclick="exportLogsCSV()">Export CSV (Spreadsheet)</button>
        <button class="btn-primary" onclick="exportLogsPDF()" style="margin-top:10px; background:#e5e5ea; color:#000;">Export PDF (Report)</button>
        <button class="btn-cancel" onclick="closeModal('export-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="hour-attribution-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Attribute Completion</h2>
        <p style="text-align:center; color:#757575; margin-bottom:25px; padding: 0 10px;">
            This trailer was completed during the shift transition window (<span id="attribution-window-text">00-05</span>).
        </p>
        <button class="btn-primary" onclick="resolveAttribution('Previous')">Previous Hour</button>
        <button class="btn-primary" onclick="resolveAttribution('Current')" style="background:#f2f2f7; color:#000; margin-top:10px;">Current Hour</button>
    </div>
</div>

<div class="modal-overlay" id="filter-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Filter Logs</h2>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Date</label>
            <input type="date" id="filter-date-input" class="form-input" style="padding:12px;">
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Door</label>
            <div class="filter-grid" id="filter-grid"></div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Unloader</label>
            <select id="filter-unloader-select" class="form-input">
                <option value="All">All Unloaders</option>
            </select>
        </div>

        <button class="btn-primary" onclick="applyFilter()">Apply Filters</button>
        <button class="btn-cancel" onclick="closeModal('filter-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="duplicate-wally-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Duplicate Wally Detected</h2>
        <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px; font-size:14px; line-height:1.5;">
            <p style="margin:0 0 10px 0;">Wally <strong id="dup-wally-id"></strong> was already completed.</p>
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#757575;">Door:</span>
                <strong id="dup-door"></strong>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span style="color:#757575;">Completed:</span>
                <strong id="dup-time"></strong>
            </div>
             <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span style="color:#757575;">Unloader:</span>
                <strong id="dup-unloader"></strong>
            </div>
        </div>
        <button class="btn-primary" onclick="continueWithDuplicate()">Continue Anyway</button>
        <button class="btn-cancel" onclick="closeModal('duplicate-wally-modal')" style="margin-top:10px;">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="input-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Onboard Door <span id="modal-door-num"></span></h2>

        <div id="onboard-form-container">
            <div class="type-selector">
                <div class="type-opt selected" id="opt-wally" onclick="setType('Wally')">Wally</div>
                <div class="type-opt" id="opt-cpu" onclick="setType('CPU')">CPU (53')</div>
            </div>

            <div id="wally-inputs">
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Wally Number</label>
                    <input type="text" id="input-wally-id" class="form-input" placeholder="e.g. 5589" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
            </div>

            <div id="cpu-inputs" style="display:none;">
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Trailer Number</label>
                    <input type="text" id="input-trailer-id" class="form-input" placeholder="e.g. TRL123" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account Number</label>
                    <input type="text" id="input-account-id" class="form-input" placeholder="e.g. ACCT456" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()" list="saved-accounts-datalist">
                    <datalist id="saved-accounts-datalist"></datalist>
                </div>
            </div>

            <div style="margin-bottom:15px;">
                <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Assigned Unloader (Optional)</label>
                <select id="select-unloader" class="form-input" onchange="checkCustomUnloader(this)">
                    <option value="" selected>Unassigned</option>
                </select>
                <input type="text" id="input-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words">
            </div>

            <div style="margin-bottom:15px;">
                <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Start Time</label>
                <input type="time" id="input-onboard-time" class="form-input">
            </div>

            <button class="btn-primary" id="btn-start-unload" onclick="confirmArrival()">Start Unload</button>
        </div>

        <div id="unavailable-msg" style="display:none; text-align:center; padding: 30px 0;">
            <i class="ph ph-prohibit" style="font-size: 48px; color: #8e8e93; margin-bottom: 10px;"></i>
            <div style="font-size: 18px; font-weight: 700; color: #000;">Bay Unavailable</div>
            <div style="font-size: 14px; color: #8e8e93;">This bay is currently marked for maintenance or offline.</div>
        </div>

        <button class="btn-primary btn-history" onclick="viewDoorLogs(currentDoor)">View History</button>

        <button class="btn-primary" id="btn-toggle-availability" onclick="handleAvailabilityToggle()" style="background:white; border:2px solid #e5e5ea; color:#000; margin-top:10px;">Mark Unavailable</button>

        <button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="add-unloader-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Add New Unloader</h2>
        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader Name</label>
            <input type="text" id="input-new-unloader-name" class="form-input" placeholder="e.g. John Doe" autocapitalize="words">
        </div>
        <button class="btn-primary" onclick="confirmAddUnloader()">Add Name</button>
        <button class="btn-cancel" onclick="closeModal('add-unloader-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="active-detail-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 10px 0; font-size:24px; text-align:center;">Active Door <span id="detail-door-num"></span></h2>

        <div style="margin-bottom: 25px;">
            <div class="detail-row">
                <span class="detail-label">Type</span>
                <span class="detail-value" id="detail-type"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ID #</span>
                <span class="detail-value" id="detail-id"></span>
            </div>
            <div class="detail-row" id="row-account" style="display:none;">
                <span class="detail-label">Account #</span>
                <span class="detail-value" id="detail-account"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Unloader</span>
                <span class="detail-value" id="detail-unloader"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Start Time</span>
                <span class="detail-value" id="detail-time"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Duration</span>
                <span class="detail-value" id="detail-duration">0m</span>
            </div>
        </div>

        <button class="btn-primary btn-danger" onclick="confirmCompleteDoor()">Complete Unload</button>

        <div class="modal-actions-row">
            <button class="modal-icon-btn" onclick="openEditActiveModalFromDetail()" style="flex:1"><i class="ph ph-pencil-simple"></i></button>
            <button class="btn-primary btn-history" onclick="viewDoorLogs(detailDoor)" style="flex:3; margin:0;">View History</button>
        </div>
        <button class="btn-cancel" onclick="closeModal('active-detail-modal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="edit-active-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Active Bay</h2>
        <input type="hidden" id="edit-active-original-door">

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Bay Number</label>
            <select id="edit-active-door-select" class="form-input"></select>
        </div>

        <div class="type-selector">
            <div class="type-opt selected" id="active-opt-wally" onclick="setEditActiveType('Wally')">Wally</div>
            <div class="type-opt" id="active-opt-cpu" onclick="setEditActiveType('CPU')">CPU</div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label>
            <input type="text" id="edit-active-id" class="form-input" oninput="this.value = this.value.toUpperCase()">
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account # (CPU only)</label>
            <input type="text" id="edit-active-account" class="form-input" oninput="this.value = this.value.toUpperCase()">
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label>
            <select id="edit-active-unloader" class="form-input" onchange="checkActiveCustomUnloader(this)"></select>
            <input type="text" id="edit-active-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words">
        </div>

        <button class="btn-primary" onclick="saveActiveEdit()">Save Changes</button>
        <button class="btn-cancel" onclick="closeModal('edit-active-modal')">Discard</button>
    </div>
</div>

<div class="modal-overlay" id="edit-log-modal">
    <div class="modal-sheet">
        <h2 style="margin: 0 0 20px 0; font-size:24px; text-align:center;">Edit Log Entry</h2>
        <input type="hidden" id="edit-log-index">

        <div class="type-selector">
            <div class="type-opt selected" id="edit-opt-wally" onclick="setEditType('Wally')">Wally</div>
            <div class="type-opt" id="edit-opt-cpu" onclick="setEditType('CPU')">CPU (53')</div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label>
            <input type="text" id="edit-input-id" class="form-input" oninput="this.value = this.value.toUpperCase()">
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label>
            <select id="edit-select-unloader" class="form-input"></select>
        </div>

        <button class="btn-primary" onclick="confirmLogEdit()">Save Changes</button>
        <button class="btn-cancel" onclick="closeModal('edit-log-modal')">Discard</button>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let demoActive = false;
    let duplicateWallyFlag = false;
    let pendingWallyDuplicate = null;
    let currentDoor = null;
    let currentType = 'Wally';
    let detailDoor = null;
    let currentLogFilter = 'All';
    let activeLogFilter = { door: 'All', unloader: 'All', type: 'All', timeRange: 'All', search: '', date: 'All' };
    let statsVisible = false;
    let hourlyVisible = false;
    let lastSortStartTime = null;
    let isFirstOnboard = false;

    // --- CONFIG ---
    const APP_VERSION = '3.29';
    const DOORS_START = 9;
    const DOORS_END = 16;
    const DEFAULT_TEAM = ["David F", "Lorena R", "Matt R", "Matt S", "Robert W", "Trevon C", "Victor M", "Russell H", "Fonseca J"];

    // --- PHASE 1: DOM HELPERS / CACHES ---
    const dom = Object.create(null);
    let teamNamesSorted = [];

    const byId = (id) => document.getElementById(id);

    function dateKeyFromTs(ts) {
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function refreshTeamNamesSorted() {
        teamNamesSorted = [...teamNames].sort((a, b) => a.localeCompare(b));
    }

    function cacheDom() {
        dom.logsList = byId('logs-list');
        dom.logSearch = byId('log-search');
        dom.filterDisplay = byId('active-filter-display');
        dom.filterText = byId('filter-text-display');

        dom.openBaysGrid = byId('open-bays-grid');
        dom.activeTrailersGrid = byId('active-trailers-grid');

        dom.unloaderStatsBody = byId('unloader-stats-body');
        dom.hourlyStatsBody = byId('hourly-stats-body');
    }

    // --- CHANGELOG ---
    const CHANGELOG = `
v3.29:
- Hour labels standardized to "1st hour, 2nd hour, 3rd hour, 4th hour, 5th hour" (and beyond).
- Staffing: Belt Tender role now asks for confirmation before switching to a different employee (max 1 on-clock).
- Staffing: Role limit enforcement now ignores cut employees for Belt Tender / Bulk Sweep calculations.

v3.27:
- New streamlined action buttons (compact pills).
- Color-coded status rings for active bays (Green < 45m, Red > 60m).

v3.26:
- Dynamic search in Logs (filters as you type).

v3.25:
- Added Date Filter to Logs (review previous days).

v3.24:
- Added "Backup Logs Only" (JSON) feature.
- Added visual "Saved âœ“" confirmation toast.
- Clarified Backup/Restore options.

v3.23:
- Added Data Backup & Restore (JSON Export/Import) in Settings.

v3.22:
- Fixed bay door availability: Removed long-press.
- Added explicit "Mark Unavailable/Available" button to Onboard menu.
- Smoother transitions for marking bays unavailable (no alerts).

v3.21:
- Verified and Confirmed: "Reset All Data" safely preserves saved Account Numbers.

v3.20:
- Simplified Share Text to "Door X done".
- Filtered Hourly Breakdown to exclude CPUs (Wally Only).
- Added historical changelog data.

v3.19:
- Added search bar to logs (search by ID or Trailer).
- Added filter by Unloader to logs.
- Enhanced duplicate alerts with details (Time, Door, Who).
- Added Changelog view in Settings.

v3.18:
- Removed automatic role switching. Manual role assignment is now strictly respected.
- Fixed hour transfer logic. Hours now follow employee to their new role.

v3.17:
- Fixed staffing ranking to exclude "Cut" employees.
- Verified time calculations are rounded correctly.

v3.16:
- Added "Start Sort" wizard to set shift start time and DOP easily.
- First trailer added after "Start Sort" syncs to shift start time.
- Added ability to edit Start Time during onboarding.
    `;

    // --- STATE ---
    let doors = {};
    let historyLog = [];
    let teamNames = [];
    let savedAccounts = [];
    let staffing = [];
    let currentDOP = '5-2';

    // Config State
    let config = {
        replenish: false,
        randomHistory: false,
        doorCount: 2,
        mixedTypes: false,
        demoType: 'Wally',
        disableTimes: false,
        simulateWindow: false,
        disableWindow: false
    };

    // Attribution window configuration (0-10 minutes after hour)
    let attributionConfig = {
        minutes: 5,
        enabled: true
    };

    // Staging for Attribution
    let pendingCompletion = null;

    // Staging for Start Sort Wizard
    let tempSortStartTime = "";

    // --- HELPER FUNCTIONS ---
    function getHourText(hour) {
        if (hour === 1) return "1st hour";
        if (hour === 2) return "2nd hour";
        if (hour === 3) return "3rd hour";
        if (hour === 4) return "4th hour";
        if (hour === 5) return "5th hour";
        if (hour === 6) return "6th hour";
        if (hour === 7) return "7th hour";
        if (hour === 8) return "8th hour";
        if (hour === 9) return "9th hour";
        if (hour === 10) return "10th hour";
        if (hour === 11) return "11th hour";
        if (hour === 12) return "12th hour";
        return `${hour}th hour`;
    }

    // --- INIT ---
    function init() {
        console.log(`Wally Dashboard v${APP_VERSION} initialized`);

        cacheDom();

        // Load saved accounts first
        const sAccts = localStorage.getItem('ps9_accounts');
        if (sAccts) savedAccounts = JSON.parse(sAccts);

        // Load attribution config
        initAttributionSettings();

        // Load other data
        const sDoors = localStorage.getItem('ps9_doors');
        const sHistory = localStorage.getItem('ps9_history');
        const sTeam = localStorage.getItem('ps9_team');
        const sStaff = localStorage.getItem('ps9_staffing');
        const sDop = localStorage.getItem('ps9_dop');
        const shiftStart = localStorage.getItem('ps9_shift_start') || "19:55";

        // Load sort-specific state
        lastSortStartTime = localStorage.getItem('ps9_last_sort_start');
        const firstOnboardState = localStorage.getItem('ps9_is_first_onboard');
        isFirstOnboard = firstOnboardState === 'true';

        if (sDoors) doors = JSON.parse(sDoors);
        else {
            for(let i=DOORS_START; i<=DOORS_END; i++) {
                doors[i] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: null };
            }
        }

        if (sHistory) historyLog = JSON.parse(sHistory);

        // Backfill derived fields for older logs (no UI/behavior change)
        if (Array.isArray(historyLog)) {
            historyLog.forEach(l => {
                if (!l.dateKey) l.dateKey = dateKeyFromTs(l.end);
                if (!l.completionHour) l.completionHour = getCompletionHour(l.end - (l.statOffset || 0));
            });
        }

        if (sTeam) teamNames = JSON.parse(sTeam); else teamNames = [...DEFAULT_TEAM];
        refreshTeamNamesSorted();

        if (sStaff) staffing = JSON.parse(sStaff);
        if (sDop) currentDOP = sDop;

        // Initialize role for existing staff if not set
        staffing.forEach(s => {
            if (!s.role) s.role = 'Unloader';
            if (!s.accumulated) s.accumulated = 0;
        });

        // Init settings inputs
        const startInput = byId('setting-shift-start');
        if(startInput) startInput.value = shiftStart;

        const dopSelect = byId('dop-select');
        if(dopSelect) dopSelect.value = currentDOP;

        renderSavedAccounts();
        updateAccountDatalist();
        populateUnloaderSelect();
        renderDashboard();

        // Initialize UI after everything is loaded
        setTimeout(() => {
            updateAttributionUI();
            setupAttributionSlider();
        }, 100);

        // Staffing Loop (1s)
        setInterval(updateStaffingTimers, 1000);
        // Update tab badges every 2 seconds
        setInterval(updateTabBadges, 2000);
        // Initial badge update
        updateTabBadges();
    }

    // --- RESET DATA ---
    function resetData() {
        if(confirm("Reset all data? This will preserve saved account numbers.")) {
            const savedAccountsBackup = [...savedAccounts];
            localStorage.clear();
            if (savedAccountsBackup.length > 0) {
                localStorage.setItem('ps9_accounts', JSON.stringify(savedAccountsBackup));
            }
            localStorage.setItem('ps9_shift_start', "19:55");
            location.reload();
        }
    }

    // --- DATA BACKUP & RESTORE ---
    function backupData(mode) {
        const data = {};

        if (mode === 'logs') {
             data['ps9_history'] = localStorage.getItem('ps9_history');
        } else {
             for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('ps9_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
        }

        const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wally-${mode}-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showSaveToast();
    }

    function triggerRestore() {
        byId('restore-file-input').click();
    }

    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(!data || Object.keys(data).length === 0) throw new Error("Empty or invalid file");

                if(confirm("This will overwrite current data with the backup. Continue?")) {
                    Object.keys(data).forEach(k => {
                        localStorage.setItem(k, data[k]);
                    });

                    alert("Data restored successfully!");
                    location.reload();
                }
            } catch(err) {
                alert("Error restoring data: " + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    function showSaveToast() {
        const t = byId('save-toast');
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2000);
    }

    // --- CHANGELOG ---
    function viewChangelog() {
        byId('changelog-content').textContent = CHANGELOG;
        byId('changelog-modal').style.display = 'flex';
    }

    // --- START SORT WIZARD FLOW ---
    function openStartSortFlow() {
        byId('start-sort-time').value = localStorage.getItem('ps9_shift_start') || "19:55";
        byId('start-sort-modal-1').style.display = 'flex';
    }

    function nextSortStep() {
        const t = byId('start-sort-time').value;
        if(!t) return alert("Please select a time");
        tempSortStartTime = t;

        byId('start-sort-dop').value = currentDOP;

        closeModal('start-sort-modal-1');
        byId('start-sort-modal-2').style.display = 'flex';
    }

    function finishStartSort() {
        const d = byId('start-sort-dop').value;

        saveShiftStart(tempSortStartTime);
        saveDOP(d);

        lastSortStartTime = tempSortStartTime;
        localStorage.setItem('ps9_last_sort_start', lastSortStartTime);

        isFirstOnboard = true;
        localStorage.setItem('ps9_is_first_onboard', 'true');

        const settingsInput = byId('setting-shift-start');
        if(settingsInput) settingsInput.value = tempSortStartTime;

        const dopDropdown = byId('dop-select');
        if(dopDropdown) dopDropdown.value = d;

        closeModal('start-sort-modal-2');

        showSaveToast();

        renderDashboard();
    }

    // --- ATTRIBUTION WINDOW FUNCTIONS ---
    function initAttributionSettings() {
        const saved = localStorage.getItem('ps9_attribution_config_v2');
        if (saved) {
            attributionConfig = JSON.parse(saved);
        }
        updateAttributionUI();
    }

    function updateAttributionUI() {
        const valueEl = byId('attribution-value');
        const noteVal = byId('attr-note-val');
        const fillEl = byId('slider-fill');
        const thumbEl = byId('slider-thumb');

        if (!valueEl || !fillEl || !thumbEl) return;

        const val = attributionConfig.minutes;
        const percentage = (val / 10) * 100;

        valueEl.textContent = val + "m";
        if(noteVal) noteVal.textContent = val;
        fillEl.style.width = `${percentage}%`;
        thumbEl.style.left = `${percentage}%`;
    }

    function saveAttributionSetting() {
        localStorage.setItem('ps9_attribution_config_v2', JSON.stringify(attributionConfig));
        showSaveToast();
    }

    function resetAttributionSetting() {
        attributionConfig.minutes = 5;
        updateAttributionUI();
        saveAttributionSetting();
    }

    // PHASE 1: Throttled persistence during drag (UI remains live)
    function setupAttributionSlider() {
        const sliderTrack = document.querySelector('.slider-track');
        const sliderThumb = byId('slider-thumb');
        if (!sliderTrack || !sliderThumb) return;

        let isDragging = false;
        let saveTimer = null;

        function scheduleSave() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveAttributionSetting();
            }, 200);
        }

        function updateSlider(clientX, shouldPersist = false) {
            const rect = sliderTrack.getBoundingClientRect();
            let percentage = ((clientX - rect.left) / rect.width) * 100;
            percentage = Math.max(0, Math.min(100, percentage));

            const minuteValue = Math.round((percentage / 100) * 10);
            if (minuteValue === attributionConfig.minutes) return;

            attributionConfig.minutes = minuteValue;
            updateAttributionUI();

            if (shouldPersist) saveAttributionSetting();
            else scheduleSave();
        }

        sliderThumb.addEventListener('mousedown', (e) => {
            isDragging = true;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSlider(e.clientX, false);
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            saveAttributionSetting();
        });

        sliderThumb.addEventListener('touchstart', (e) => {
            isDragging = true;
            e.preventDefault();
        });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            updateSlider(e.touches[0].clientX, false);
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            saveAttributionSetting();
        });

        sliderTrack.addEventListener('click', (e) => {
            updateSlider(e.clientX, true);
        });
    }

    // --- TAB BADGE FUNCTIONALITY ---
    function updateTabBadges() {
        let activeTrailersCount = 0;
        for(let i = DOORS_START; i <= DOORS_END; i++) {
            if(doors[i].status === 'active') activeTrailersCount++;
        }

        updateBadge('active', activeTrailersCount, 'activeTrailers');

        let activeStaffCount = staffing.filter(s => s.status === 'active' || s.status === 'paused').length;
        updateBadge('staffing', activeStaffCount, 'activeStaff');

        updateBadge('tools', 0, 'default');

        let settingsBadgeCount = demoActive ? 1 : 0;
        updateBadge('settings', settingsBadgeCount, 'demo');
    }

    function updateBadge(tabId, count, type) {
        const badge = byId(`badge-${tabId}`);
        if (!badge) return;

        if (tabId === 'logs') {
            badge.style.display = 'none';
            return;
        }

        if (count === 0) {
            badge.textContent = '0';
            badge.classList.add('zero');
            badge.classList.remove('warning', 'success');
            badge.style.display = 'none';
        } else {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.remove('zero');

            if (type === 'activeTrailers') {
                if (count >= 6) badge.classList.add('warning');
                else if (count >= 3) badge.classList.add('success');
                else badge.classList.remove('warning', 'success');
            } else if (type === 'activeStaff') {
                if (count >= 8) badge.classList.add('warning');
                else if (count >= 4) badge.classList.add('success');
                else badge.classList.remove('warning', 'success');
            } else if (type === 'demo') {
                badge.classList.add('warning');
            } else {
                badge.classList.remove('warning', 'success');
            }

            badge.style.display = 'flex';
        }
    }

    // --- STAFFING LOGIC ---
    function saveDOP(val) {
        currentDOP = val;
        localStorage.setItem('ps9_dop', currentDOP);
        showSaveToast();
    }

    function openAddStaffModal() {
        const container = byId('staff-checkbox-list');
        container.innerHTML = '';

        // PHASE 1: Use pre-sorted names (no repeated sort)
        teamNamesSorted.forEach(n => {
            const isActive = staffing.find(s => s.name === n && (s.status === 'active' || s.status === 'paused'));
            if(!isActive) {
                const item = document.createElement('label');
                item.className = 'staff-checkbox-item';
                item.innerHTML = `<input type="checkbox" value="${n}" class="staff-checkbox"><span>${n}</span>`;
                container.appendChild(item);
            }
        });

        byId('staff-input-time').value = '';
        byId('add-staff-modal').style.display = 'flex';
    }

    function confirmAddStaff() {
        const checkboxes = document.querySelectorAll('.staff-checkbox:checked');
        const timeInput = byId('staff-input-time').value;

        if(checkboxes.length === 0) return alert("Select at least one employee");

        let startTime;
        if(timeInput) {
            const now = new Date();
            const [h, m] = timeInput.split(':').map(Number);
            const d = new Date(now);
            d.setHours(h, m, 0, 0);
            if(d > now) d.setDate(d.getDate() - 1);
            startTime = d.getTime();
        } else {
            const { shiftStart } = getShiftTimeWindows();
            startTime = shiftStart.getTime();
        }

        checkboxes.forEach(cb => {
            staffing.push({
                id: Date.now() + Math.random(),
                name: cb.value,
                start: startTime,
                end: null,
                status: 'active',
                role: 'Unloader',
                accumulated: 0
            });
        });

        saveData();
        closeModal('add-staff-modal');
        renderStaffingView();
        updateTabBadges();
        showSaveToast();
    }

    function cutStaff(id) {
        const s = staffing.find(x => x.id === id);
        if(s) {
            s.status = 'cut';
            s.end = Date.now();
            if (s.start !== null) {
                s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
            }
            s.start = null;

            if(s.role === 'Belt Tender' || s.role === 'Bulk Sweep') {
                s.role = 'Unloader';
            }

            saveData();
            renderStaffingView();
            updateTabBadges();
            showSaveToast();
        }
    }

    function removeStaff(id) {
        if(confirm("Delete this employee record? This cannot be undone.")) {
            staffing = staffing.filter(s => s.id !== id);
            saveData();
            renderStaffingView();
            updateTabBadges();
        }
    }

    function openEditStaffModal(id) {
        const s = staffing.find(x => x.id === id);
        if(!s) return;
        byId('edit-staff-id').value = id;

        const date = new Date(s.start || Date.now());
        const h = date.getHours().toString().padStart(2,'0');
        const m = date.getMinutes().toString().padStart(2,'0');
        byId('edit-staff-time').value = `${h}:${m}`;

        byId('edit-staff-modal').style.display = 'flex';
    }

    function saveStaffEdit() {
        const id = parseFloat(byId('edit-staff-id').value);
        const timeInput = byId('edit-staff-time').value;
        const s = staffing.find(x => x.id === id);

        if(s && timeInput) {
            const [h, m] = timeInput.split(':').map(Number);
            const originalDate = new Date(s.start || Date.now());
            const newDate = new Date(originalDate);
            newDate.setHours(h, m);

            const diff = newDate.getTime() - originalDate.getTime();
            if(diff < -12 * 3600000) newDate.setDate(newDate.getDate() + 1);
            if(diff > 12 * 3600000) newDate.setDate(newDate.getDate() - 1);

            s.start = newDate.getTime();
            saveData();
            renderStaffingView();
            closeModal('edit-staff-modal');
            showSaveToast();
        }
    }

    function saveStaffRole(id, newRole, selectEl = null) {
        const s = staffing.find(x => x.id === id);
        if(!s) return;

        const oldRole = s.role;
        const now = Date.now();
        let limitChanged = false;

        if(oldRole === newRole) return;

        if (newRole === 'Belt Tender') {
            const currentBT = staffing.find(other =>
                other.id !== s.id &&
                other.role === 'Belt Tender' &&
                other.status !== 'cut'
            );

            if (currentBT) {
                const ok = confirm(`Belt Tender is currently assigned to ${currentBT.name}. Switch Belt Tender to ${s.name}?`);
                if (!ok) {
                    if (selectEl) selectEl.value = oldRole;
                    return;
                }
            }
        }

        if (newRole === 'Belt Tender') {
            staffing.forEach(other => {
                if (other.id !== s.id && other.role === 'Belt Tender' && other.status !== 'cut') {
                    if (other.status === 'active' && other.start) {
                        const ms = now - other.start;
                        other.accumulated = (other.accumulated || 0) + ms;
                        other.start = now;
                    }
                    other.role = 'Unloader';
                    limitChanged = true;
                }
            });
        }

        if (newRole === 'Bulk Sweep') {
            const sweeps = staffing.filter(other =>
                other.id !== s.id &&
                other.role === 'Bulk Sweep' &&
                other.status !== 'cut'
            );

            if (sweeps.length >= 2) {
                sweeps.sort((a,b) => calculateTotalHours(a) - calculateTotalHours(b));
                const toDemote = sweeps[0];

                if (toDemote.status === 'active' && toDemote.start) {
                    const ms = now - toDemote.start;
                    toDemote.accumulated = (toDemote.accumulated || 0) + ms;
                    toDemote.start = now;
                }
                toDemote.role = 'Unloader';
                limitChanged = true;
            }
        }

        if(s.status === 'active' && s.start) {
            const currentSessionMs = now - s.start;
            s.accumulated = (s.accumulated || 0) + currentSessionMs;
            s.start = now;
            s.role = newRole;

            saveData();
            renderStaffingView();
            showSaveToast();
            if(limitChanged) alert("Role limits enforced: Previous holder(s) moved to Unloader.");
            return;
        }

        if(s.status === 'paused') {
            s.role = newRole;
            saveData();
            renderStaffingView();
            showSaveToast();
            if(limitChanged) alert("Role limits enforced.");
            return;
        }

        s.role = newRole;
        saveData();
        renderStaffingView();
        showSaveToast();
        if(limitChanged) alert("Role limits enforced.");
    }

    function pauseStaff(id) {
        const s = staffing.find(x => x.id === id);
        if (s && s.status === 'active') {
            s.status = 'paused';
            s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
            s.start = null;
            saveData();
            renderStaffingView();
            updateTabBadges();
        }
    }

    function resumeStaff(id) {
        const s = staffing.find(x => x.id === id);
        if (s && s.status === 'paused') {
            s.status = 'active';
            s.start = Date.now();
            saveData();
            renderStaffingView();
            updateTabBadges();
        }
    }

    function calculateTotalHours(s) {
        const now = Date.now();
        let totalMs = (s.accumulated || 0);
        if (s.status === 'active' && s.start) {
            totalMs += (now - s.start);
        }
        const totalMinutes = Math.round(totalMs / 60000);
        return totalMinutes / 60;
    }

    function getTopThreeStaff() {
        const activeOnly = staffing.filter(s => s.status !== 'cut');
        const withHours = activeOnly.map(s => ({ ...s, totalHours: calculateTotalHours(s) }));
        withHours.sort((a, b) => b.totalHours - a.totalHours);
        return withHours.slice(0, 3);
    }

    function renderStaffingView() {
        const activeList = byId('staff-list-active');
        const cutList = byId('staff-list-cut');
        activeList.innerHTML = '';
        cutList.innerHTML = '';

        const topThree = getTopThreeStaff();
        const topThreeIds = topThree.map(s => s.id);

        const activeStaff = staffing.filter(s => s.status === 'active' || s.status === 'paused');
        activeStaff.sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));

        activeStaff.forEach(s => {
             let suggestionBadge = '';
             if (topThreeIds.includes(s.id)) {
                 const position = topThreeIds.indexOf(s.id);
                 if (position === 0) suggestionBadge = 'ðŸ‘‘';
                 else if (position === 1 || position === 2) suggestionBadge = 'ðŸ§¹';
             }

             const isPaused = s.status === 'paused';
             const pauseBtnIcon = isPaused ? 'ph-play' : 'ph-pause';
             const pauseBtnAction = isPaused ? `resumeStaff(${s.id})` : `pauseStaff(${s.id})`;
             const pauseStyle = 'background:#e5e5ea; color:#000;';
             const cardStyle = isPaused ? 'opacity:0.7; border:1px dashed #ccc;' : '';
             const badgeText = isPaused ? '<span style="background:#ffcc00; color:#000; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:700; margin-left:5px;">PAUSED</span>' : '';

             const timeStr = isPaused ? 'Paused' : 'Started: ' + new Date(s.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
             const totalHours = calculateTotalHours(s);

             let roleColor = '#000';
             if (s.role === 'Belt Tender') roleColor = '#ff9500';
             if (s.role === 'Bulk Sweep') roleColor = '#34c759';

             const div = document.createElement('div');
             div.className = 'staff-card';
             if(isPaused) div.style.cssText = cardStyle;

             div.innerHTML = `
                <div style="width:100%">
                    <div class="staff-top-row">
                        <div class="staff-name">${s.name} <span style="margin-left:5px; font-size:18px;">${suggestionBadge}</span> ${badgeText}</div>
                        <div style="display:flex; gap:8px;">
                            <button class="icon-btn" onclick="${pauseBtnAction}" style="width:32px; height:32px; font-size:16px; ${pauseStyle}"><i class="ph ${pauseBtnIcon}"></i></button>
                            <button class="icon-btn" onclick="openEditStaffModal(${s.id})" style="width:32px; height:32px; font-size:16px;"><i class="ph ph-pencil-simple"></i></button>
                            <button class="staff-action-btn" onclick="cutStaff(${s.id})">CUT</button>
                            <button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30;"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                    <div class="staff-time">${timeStr} â€¢ ${s.role}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                        <div class="staff-hours" id="staff-hours-${s.id}" style="color:${roleColor}">${totalHours.toFixed(2)}h</div>
                        <div style="width:50%">
                            <select class="role-select" onchange="saveStaffRole(${s.id}, this.value, this)">
                                <option value="Unloader" ${s.role === 'Unloader' ? 'selected' : ''}>Unloader</option>
                                <option value="Belt Tender" ${s.role === 'Belt Tender' ? 'selected' : ''}>Belt Tender</option>
                                <option value="Bulk Sweep" ${s.role === 'Bulk Sweep' ? 'selected' : ''}>Bulk Sweep</option>
                            </select>
                        </div>
                    </div>
                </div>
             `;
             activeList.appendChild(div);
        });

        const cutStaffList = staffing.filter(s => s.status === 'cut');
        cutStaffList.sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));

        cutStaffList.forEach(s => {
             const hrs = calculateTotalHours(s);

             let suggestionBadge = '';
             if (topThreeIds.includes(s.id)) {
                 const position = topThreeIds.indexOf(s.id);
                 if (position === 0) suggestionBadge = 'ðŸ‘‘';
                 else if (position === 1 || position === 2) suggestionBadge = 'ðŸ§¹';
             }

             const div = document.createElement('div');
             div.className = 'staff-card cut';
             div.innerHTML = `
                <div>
                    <div class="staff-name">${s.name} <span style="margin-left:5px; font-size:18px;">${suggestionBadge}</span> â€¢ ${s.role}</div>
                    <div class="staff-time">Ended: ${new Date(s.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="staff-hours">${hrs.toFixed(2)}h</div>
                    <button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30; background:transparent;"><i class="ph ph-trash"></i></button>
                </div>
             `;
             cutList.appendChild(div);
        });

        byId('badge-on-clock').innerText = activeStaff.length;
        byId('badge-off-clock').innerText = cutStaffList.length;
        updateStaffingTimers();
    }

    function updateStaffingTimers() {
        if(!byId('tab-staffing').classList.contains('active')) return;

        let onClockCount = 0;
        let totalUnloaderHours = 0;
        let beltHours = 0;
        let sweepHours = 0;

        staffing.forEach(s => {
            let hrs = 0;

            if(s.status === 'active' || s.status === 'paused') {
                onClockCount++;
                hrs = calculateTotalHours(s);
                const el = byId(`staff-hours-${s.id}`);
                if(el) el.innerText = hrs.toFixed(2) + 'h';
            } else if(s.status === 'cut') {
                hrs = calculateTotalHours(s);
            }

            if (s.role === 'Unloader') totalUnloaderHours += hrs;
            else if (s.role === 'Belt Tender') beltHours += hrs;
            else if (s.role === 'Bulk Sweep') sweepHours += hrs;
        });

        byId('staff-active-count').innerText = onClockCount;
        byId('staff-total-hours').innerText = totalUnloaderHours.toFixed(2);
        byId('staff-belt-hours').innerText = beltHours.toFixed(2);
        byId('staff-sweep-hours').innerText = sweepHours.toFixed(2);
    }

    // --- SAVED ACCOUNTS LOGIC ---
    function addSavedAccount() {
        const input = byId('new-account-input');
        const val = input.value.trim().toUpperCase();
        if(val && !savedAccounts.includes(val)) {
            savedAccounts.push(val);
            localStorage.setItem('ps9_accounts', JSON.stringify(savedAccounts));
            renderSavedAccounts();
            updateAccountDatalist();
            input.value = '';
        }
    }

    function removeAccount(acct) {
        savedAccounts = savedAccounts.filter(a => a !== acct);
        localStorage.setItem('ps9_accounts', JSON.stringify(savedAccounts));
        renderSavedAccounts();
        updateAccountDatalist();
    }

    function renderSavedAccounts() {
        const list = byId('saved-accounts-list');
        if(!list) return;
        list.innerHTML = '';
        if(savedAccounts.length === 0) {
            list.innerHTML = '<div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div>';
            return;
        }
        savedAccounts.forEach(acct => {
            const div = document.createElement('div');
            div.className = 'saved-acct-item';
            div.innerHTML = `
                <span>${acct}</span>
                <i class="ph ph-minus-circle delete-acct-btn" onclick="removeAccount('${acct}')"></i>
            `;
            list.appendChild(div);
        });
    }

    function updateAccountDatalist() {
        const dl = byId('saved-accounts-datalist');
        if (!dl) return;
        dl.innerHTML = '';
        savedAccounts.forEach(acct => {
            const opt = document.createElement('option');
            opt.value = acct;
            dl.appendChild(opt);
        });
    }

    // --- SETTINGS LOGIC ---
    function toggleSwitch(id) {
        const el = byId('switch-' + id);
        el.classList.toggle('checked');
        const checked = el.classList.contains('checked');

        if(id === 'demo-mode') {
            demoActive = checked;
            updateTabBadges();
        }
        if(id === 'demo-replenish') config.replenish = checked;
        if(id === 'demo-random') config.randomHistory = checked;
        if(id === 'mixed-types') config.mixedTypes = checked;
        if(id === 'disable-times') config.disableTimes = checked;
        if(id === 'sim-window') config.simulateWindow = checked;
        if(id === 'dis-window') {
            config.disableWindow = checked;
            attributionConfig.enabled = !checked;
        }

        renderDashboard();
    }

    function stepDoor(delta) {
        let val = parseInt(byId('demo-door-val').innerText);
        val += delta;
        if(val < 1) val = 1; if(val > 8) val = 8;
        byId('demo-door-val').innerText = val;
        config.doorCount = val;
    }

    function setDemoType(type) {
        config.demoType = type;
        byId('seg-wally').classList.toggle('selected', type === 'Wally');
        byId('seg-cpu').classList.toggle('selected', type === 'CPU');
    }

    function startDemo() {
        const count = config.doorCount;
        demoActive = true;
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(doors[i].status === 'empty' && (i - DOORS_START) < count) {
                randomArrival(i);
            }
        }
        alert("Demo Started: " + count + " doors filled.");
        switchTab('dashboard');
        updateTabBadges();
    }

    function randomArrival(doorNum) {
        let type = config.demoType;
        if(config.mixedTypes) type = Math.random() > 0.5 ? 'Wally' : 'CPU';
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        const unloader = teamNames[Math.floor(Math.random() * teamNames.length)];
        let account = "";
        if(type === 'CPU') account = savedAccounts.length > 0 ? savedAccounts[Math.floor(Math.random() * savedAccounts.length)] : "ACC" + Math.floor(100 + Math.random() * 900);
        doors[doorNum] = { status: 'active', start: Date.now(), id: id.toUpperCase(), account: account.toUpperCase(), type: type, unloader: unloader, unavailable: false, lastCompletionTime: null };
        renderDashboard();
        updateTabBadges();
    }

    // --- SHIFT & TIME ---
    function getShiftStartTime() {
        return localStorage.getItem('ps9_shift_start') || "19:55";
    }

    function saveShiftStart(val) {
        localStorage.setItem('ps9_shift_start', val);
        renderDashboard();
    }

    function getShiftTimeWindows() {
        if (config.disableTimes) {
             const now = new Date();
             const thisHourStart = new Date(now); thisHourStart.setMinutes(0,0,0);
             const thisHourEnd = new Date(thisHourStart.getTime() + 3600000);
             const lastHourStart = new Date(thisHourStart.getTime() - 3600000);
             const lastHourEnd = thisHourStart;
             return { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd, shiftStart: new Date(now.setHours(20,0,0,0)) };
        }

        const startStr = getShiftStartTime();
        const [h, m] = startStr.split(':').map(Number);
        const now = new Date();
        let start = new Date(now);
        start.setHours(h, m, 0, 0);
        if (now < start) start.setDate(start.getDate() - 1);

        const diffMs = now - start;
        const hoursElapsed = Math.floor(diffMs / (60 * 60 * 1000));

        const thisHourStart = new Date(start.getTime() + (hoursElapsed * 3600000));
        const thisHourEnd = new Date(thisHourStart.getTime() + 3600000);

        const lastHourStart = new Date(thisHourStart.getTime() - 3600000);
        const lastHourEnd = thisHourStart;

        return { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd, shiftStart: start };
    }

    // --- HOUR CALCULATION FOR LOGS ---
    function getCompletionHour(completionTime) {
        const { shiftStart } = getShiftTimeWindows();
        const shiftStartTime = shiftStart.getTime();
        const hoursSinceShiftStart = Math.floor((completionTime - shiftStartTime) / 3600000);
        return hoursSinceShiftStart + 1;
    }

    // --- LOGIC ---
    // PHASE 1: Use pre-sorted names and avoid mutating sorts
    function populateUnloaderSelect() {
        const ids = ['select-unloader', 'edit-select-unloader', 'edit-active-unloader', 'filter-unloader-select'];

        ids.forEach(id => {
            const el = byId(id);
            if(!el) return;

            const isFilter = id === 'filter-unloader-select';
            el.innerHTML = isFilter ? '<option value="All">All Unloaders</option>' : '<option value="" selected>Unassigned</option>';

            teamNamesSorted.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name;
                el.appendChild(opt);
            });

            if(!isFilter) {
                const cust = document.createElement('option');
                cust.value = "Custom"; cust.innerText = "Custom / Other";
                el.appendChild(cust);
            }
        });
    }

    function openAddUnloaderModal() {
        byId('input-new-unloader-name').value='';
        byId('add-unloader-modal').style.display='flex';
    }

    function confirmAddUnloader() {
        const input = byId('input-new-unloader-name');
        if(input) input.blur();

        const val=input.value.trim();
        if(val){
            const capitalized = val.toLowerCase().split(' ').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');

            if(!teamNames.includes(capitalized)){
                teamNames.push(capitalized);
                refreshTeamNamesSorted();
                localStorage.setItem('ps9_team',JSON.stringify(teamNames));
                populateUnloaderSelect();
            }
            closeModal('add-unloader-modal');
        }
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
        byId(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
        if(btn) btn.classList.add('active');
        else if(tabId) {
             const icons=document.querySelectorAll('.tab-btn');
             if(tabId==='dashboard') icons[0].classList.add('active');
             if(tabId==='active') icons[1].classList.add('active');
             if(tabId==='logs') icons[2].classList.add('active');
             if(tabId==='staffing') icons[3].classList.add('active');
             if(tabId==='tools') icons[4].classList.add('active');
             if(tabId==='settings') icons[5].classList.add('active');
        }
        if(tabId==='dashboard') renderDashboard();
        if(tabId==='active') renderActiveTab();
        if(tabId==='logs') renderLogs();
        if(tabId==='staffing') renderStaffingView();
    }

    function closeModal(id) {
        const modal = byId(id);
        if(modal) modal.style.display='none';
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
    }

    // --- DUPLICATE WALLY CHECK ---
    function checkDuplicateWally(wallyId) {
        const { shiftStart } = getShiftTimeWindows();
        const shiftStartTime = shiftStart.getTime();
        const now = Date.now();

        return historyLog.find(log =>
            log.type === 'Wally' &&
            log.id === wallyId &&
            log.end >= shiftStartTime &&
            log.end <= now
        );
    }

    function continueWithDuplicate() {
        closeModal('duplicate-wally-modal');
        if (pendingWallyDuplicate) {
            const { doorNum, wallyId, unloader, startTime } = pendingWallyDuplicate;
            doors[doorNum] = {
                status: 'active',
                start: startTime,
                id: wallyId,
                account: "",
                type: 'Wally',
                unloader: unloader || "Unassigned",
                isDuplicate: true,
                unavailable: false,
                lastCompletionTime: null
            };

            if (isFirstOnboard) {
                isFirstOnboard = false;
                localStorage.setItem('ps9_is_first_onboard', 'false');
            }

            saveData();
            closeModal('input-modal');
            renderDashboard();
            updateTabBadges();
            showSaveToast();
            pendingWallyDuplicate = null;
        }
    }

    // --- COMPLETION LOGIC WITH CONFIGURABLE ATTRIBUTION WINDOW ---
    function confirmCompleteDoor() {
        if(!detailDoor) return;
        completeDoor(detailDoor);
    }

    function completeDoor(doorNum) {
        const now = new Date();
        const mins = now.getMinutes();

        const { shiftStart } = getShiftTimeWindows();
        const isPastFirstHour = (now - shiftStart) > 3600000;

        const windowLimit = attributionConfig.minutes;
        const inWindow = mins <= windowLimit;

        const shouldCheckAttribution = !config.disableWindow && isPastFirstHour && attributionConfig.enabled && windowLimit > 0 && (inWindow || config.simulateWindow);

        if (shouldCheckAttribution) {
            const paddedLimit = windowLimit.toString().padStart(2, '0');
            byId('attribution-window-text').textContent = `00-${paddedLimit}`;
            pendingCompletion = { doorNum, time: now.getTime() };
            byId('hour-attribution-modal').style.display = 'flex';
        } else {
            finalizeCompletion(doorNum, now.getTime(), 0);
        }
    }

    function resolveAttribution(choice) {
        closeModal('hour-attribution-modal');
        if (!pendingCompletion) return;

        let offset = 0;
        if (choice === 'Previous') {
            const d = new Date(pendingCompletion.time);
            const mins = d.getMinutes();
            offset = (mins + 1) * 60000;
        }

        finalizeCompletion(pendingCompletion.doorNum, pendingCompletion.time, offset);
        pendingCompletion = null;
    }

    function finalizeCompletion(doorNum, actualEndTime, statOffset) {
        const d = doors[doorNum];
        let end = actualEndTime;
        let start = d.start;

        const durationMinutes = Math.round((end - start) / 60000);

        if (config.randomHistory && demoActive) {
             const { shiftStart } = getShiftTimeWindows();
             const earliest = shiftStart.getTime();
             end = Math.floor(Math.random() * (Date.now() - earliest) + earliest);
             start = end - (Math.floor(Math.random() * 30 + 15) * 60000);
             statOffset = 0;
        }

        if (d.type === 'CPU' && d.account && d.account.trim() !== "") {
            const accountUpper = d.account.trim().toUpperCase();
            if(!savedAccounts.includes(accountUpper)) {
                savedAccounts.push(accountUpper);
                localStorage.setItem('ps9_accounts', JSON.stringify(savedAccounts));
                updateAccountDatalist();
                renderSavedAccounts();
            }
        }

        const completionHour = getCompletionHour(end - statOffset);

        historyLog.unshift({
            door: doorNum,
            id: d.id,
            account: d.account || "",
            type: d.type,
            unloader: d.unloader,
            start: start,
            end: end,
            dateKey: dateKeyFromTs(end),   // PHASE 1: store once for fast filtering
            duration: end - start,
            durationMinutes: durationMinutes,
            statOffset: statOffset,
            logId: Date.now() + Math.random().toString(36).substring(2, 9),
            duplicate: d.isDuplicate || false,
            completionHour: completionHour
        });

        if (d.type === 'Wally' && navigator.share && !demoActive) {
             navigator.share({
                 text: `Door ${doorNum} done`
             }).then(() => {
                 closeModal('active-detail-modal');
             }).catch(err => console.log(err));
        } else {
            closeModal('active-detail-modal');
        }

        doors[doorNum] = {
            status: 'empty',
            start: 0,
            id: '',
            type: '',
            unloader: '',
            unavailable: false,
            lastCompletionTime: end
        };

        saveData();
        renderDashboard();
        renderActiveTab();
        updateTabBadges();
        showSaveToast();

        if (demoActive && config.replenish) {
            setTimeout(() => { if (doors[doorNum].status === 'empty') randomArrival(doorNum); }, 7000);
        }
    }

    // --- STATS UPDATE ---
    function updateStats() {
        const { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd } = getShiftTimeWindows();

        let totalWally = 0, totalCPU = 0, hourWally = 0, lastHourWally = 0;

        historyLog.forEach(log => {
            const effectiveTime = log.end - (log.statOffset || 0);

            if (log.type === 'Wally') {
                totalWally++;
                if (effectiveTime >= thisHourStart.getTime() && effectiveTime < thisHourEnd.getTime()) {
                    hourWally++;
                } else if (effectiveTime >= lastHourStart.getTime() && effectiveTime < lastHourEnd.getTime()) {
                    lastHourWally++;
                }
            } else if (log.type === 'CPU') {
                totalCPU++;
            }
        });

        byId('stat-total-wally').innerText = totalWally;
        byId('stat-total-cpu').innerText = totalCPU;
        byId('stat-hour-wally').innerText = hourWally;
        byId('stat-last-wally').innerText = lastHourWally;
    }

    function renderDashboard() {
        updateStats();
        const openBaysGrid = dom.openBaysGrid || byId('open-bays-grid');
        const activeTrailersGrid = dom.activeTrailersGrid || byId('active-trailers-grid');
        openBaysGrid.innerHTML = ''; activeTrailersGrid.innerHTML = '';
        let hasOpen = false, hasActive = false;

        for(let i=DOORS_START; i<=DOORS_END; i++) {
            const d = doors[i];
            if (d.status === 'active') {
                hasActive = true;
                const btn = document.createElement('div');
                btn.className = `bay-circle bay-${i} ${d.unavailable ? 'unavailable' : ''}`;
                btn.setAttribute('data-door', i);
                btn.innerHTML = `${i}`;
                const badge = document.createElement('div');
                badge.className = d.type === 'Wally' ? 'type-badge badge-w' : 'type-badge badge-c';
                badge.innerText = d.type === 'Wally' ? 'W' : 'C';
                btn.appendChild(badge);

                if (d.start > 0) {
                     const duration = (Date.now() - d.start) / 60000;
                     let borderColor = '#34c759';
                     if (duration > 60) borderColor = '#ff3b30';
                     else if (duration > 45) borderColor = '#ff9500';

                     btn.style.border = `4px solid ${borderColor}`;
                }

                btn.onclick = () => openActiveDetails(i);
                activeTrailersGrid.appendChild(btn);
            } else {
                hasOpen = true;
                const btn = document.createElement('div');
                btn.className = `bay-circle bay-${i} ${d.unavailable ? 'unavailable' : ''}`;
                btn.setAttribute('data-door', i);
                btn.innerText = i;

                if (d.lastCompletionTime && d.status === 'empty' && !d.unavailable) {
                    const idleTimeMs = Date.now() - d.lastCompletionTime;
                    const idleMinutes = Math.floor(idleTimeMs / 60000);
                    const timer = document.createElement('div');
                    timer.className = 'bay-timer';
                    timer.textContent = `${idleMinutes}m`;
                    btn.appendChild(timer);
                }

                btn.onclick = () => { openArrivalModal(i); };

                openBaysGrid.appendChild(btn);
            }
        }

        if(!hasOpen) openBaysGrid.innerHTML = '<div class="empty-state-text">All bays full.</div>';
        if(!hasActive) activeTrailersGrid.innerHTML = '<div class="empty-state-text">No active trailers.</div>';
    }

    function renderActiveTab() {
        const list = byId('active-tab-list');
        list.innerHTML = '';
        let hasActive = false;
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(doors[i].status === 'active') {
                hasActive = true;
                const d = doors[i];
                const startTime = new Date(d.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const acctInfo = d.account ? ` | Acct: ${d.account}` : '';
                list.innerHTML += `<div class="active-card"><div class="active-card-info"><div class="active-card-header"><span class="door-pill">Door ${i}</span><span class="active-card-title">${d.type} ${d.id}</span></div><div class="active-card-details">${d.unloader}${acctInfo}</div><div class="active-card-time">Started: ${startTime}</div></div><div class="active-card-actions"><button class="icon-btn" onclick="openEditActiveModal(${i})"><i class="ph ph-pencil-simple"></i></button><button class="btn-primary" style="width:auto; padding:10px 16px; margin:0;" onclick="completeDoor(${i})">Finish</button></div></div>`;
            }
        }
        if(!hasActive) list.innerHTML = '<div style="text-align:center; color:#999; margin-top:40px;">No active trailers</div>';
    }

    function openActiveDetails(doorNum) {
        detailDoor = doorNum;
        const d = doors[doorNum];
        byId('detail-door-num').innerText = doorNum;
        byId('detail-type').innerText = d.type;
        byId('detail-id').innerText = d.id;
        byId('detail-unloader').innerText = d.unloader || "Unassigned";
        byId('detail-time').innerText = new Date(d.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        const durationMs = Date.now() - d.start;
        const durationMinutes = Math.floor(durationMs / 60000);
        byId('detail-duration').innerText = `${durationMinutes}m`;

        const acctRow = byId('row-account');
        if (d.account) {
            acctRow.style.display = 'flex';
            byId('detail-account').innerText = d.account;
        } else {
            acctRow.style.display = 'none';
        }
        byId('active-detail-modal').style.display = 'flex';
    }

    function openEditActiveModalFromDetail() {
        closeModal('active-detail-modal');
        openEditActiveModal(detailDoor);
    }

    function openEditActiveModal(doorNum) {
        const d = doors[doorNum];
        byId('edit-active-original-door').value = doorNum;
        byId('edit-active-id').value = d.id;
        byId('edit-active-account').value = d.account || "";

        const unloaderSelect = byId('edit-active-unloader');
        unloaderSelect.value = d.unloader || "";
        if(unloaderSelect.selectedIndex === -1) {
             unloaderSelect.value = 'Custom';
             checkActiveCustomUnloader(unloaderSelect);
             byId('edit-active-custom-unloader').value = d.unloader;
        } else {
             checkActiveCustomUnloader(unloaderSelect);
        }

        setEditActiveType(d.type);

        const sel = byId('edit-active-door-select');
        sel.innerHTML = '';
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            if(i===doorNum || doors[i].status==='empty') {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `Bay ${i}`;
                if(i===doorNum) opt.selected=true;
                sel.appendChild(opt);
            }
        }
        byId('edit-active-modal').style.display = 'flex';
    }

    function setEditActiveType(t) {
        byId('active-opt-wally').classList.toggle('selected', t === 'Wally');
        byId('active-opt-cpu').classList.toggle('selected', t === 'CPU');
        byId('edit-active-modal').dataset.type = t;
    }

    function checkActiveCustomUnloader(select) {
         const input = byId('edit-active-custom-unloader');
         input.style.display = select.value === 'Custom' ? 'block' : 'none';
    }

    function saveActiveEdit() {
        const orig = parseInt(byId('edit-active-original-door').value);
        const dest = parseInt(byId('edit-active-door-select').value);

        let unl = byId('edit-active-unloader').value;
        if(unl === 'Custom') unl = byId('edit-active-custom-unloader').value.trim();
        if (!unl) unl = "Unassigned";

        if (unl !== "Unassigned" && unl === byId('edit-active-custom-unloader').value.trim()) {
            unl = unl.toLowerCase().split(' ').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        const data = {
            status: 'active',
            start: doors[orig].start,
            id: byId('edit-active-id').value.trim().toUpperCase(),
            account: byId('edit-active-account').value.trim().toUpperCase(),
            type: byId('edit-active-modal').dataset.type,
            unloader: unl,
            unavailable: false,
            lastCompletionTime: doors[orig].lastCompletionTime
        };

        if(dest !== orig) {
            doors[dest] = data;
            doors[orig] = {status:'empty', start:0, id:'', type:'', unloader:'', unavailable: false, lastCompletionTime: doors[orig].lastCompletionTime};
        } else {
            doors[orig] = data;
        }

        saveData();
        closeModal('edit-active-modal');
        renderActiveTab();
        renderDashboard();
        updateTabBadges();
        showSaveToast();
    }

    function checkCustomUnloader(select) {
        const input = byId('input-custom-unloader');
        input.style.display = select.value === 'Custom' ? 'block' : 'none';
    }

    function confirmArrival() {
        const idVal = currentType === 'Wally' ? byId('input-wally-id').value : byId('input-trailer-id').value;
        const accVal = currentType === 'CPU' ? byId('input-account-id').value : "";
        const sel = byId('select-unloader');
        let unl = sel.value;

        if(unl === 'Custom') {
            unl = byId('input-custom-unloader').value;
            if (unl) {
                unl = unl.toLowerCase().split(' ').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }
        }

        if(!idVal) return alert("Missing Wally/Trailer ID");

        const formattedId = idVal.toUpperCase();
        const formattedAccount = accVal.toUpperCase();

        if (currentType === 'Wally') {
            const dup = checkDuplicateWally(formattedId);
            if (dup) {
                pendingWallyDuplicate = {
                    doorNum: currentDoor,
                    wallyId: formattedId,
                    unloader: unl || "Unassigned",
                    startTime: Date.now()
                };

                byId('dup-wally-id').textContent = formattedId;
                byId('dup-door').textContent = `Door ${dup.door}`;
                byId('dup-time').textContent = new Date(dup.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                byId('dup-unloader').textContent = dup.unloader;

                byId('duplicate-wally-modal').style.display = 'flex';
                return;
            }
        }

        let startTime = Date.now();
        const customTimeInput = byId('input-onboard-time').value;

        if (customTimeInput) {
            const now = new Date();
            const [h, m] = customTimeInput.split(':').map(Number);
            const d = new Date(now);
            d.setHours(h, m, 0, 0);
            if (d > now) d.setDate(d.getDate() - 1);
            startTime = d.getTime();
        }

        doors[currentDoor] = {
            status: 'active',
            start: startTime,
            id: formattedId,
            account: formattedAccount,
            type: currentType,
            unloader: unl || "Unassigned",
            isDuplicate: false,
            unavailable: false,
            lastCompletionTime: null
        };

        if (isFirstOnboard) {
            isFirstOnboard = false;
            localStorage.setItem('ps9_is_first_onboard', 'false');
        }

        saveData();
        closeModal('input-modal');
        renderDashboard();
        updateTabBadges();
        showSaveToast();
    }

    function openArrivalModal(specificDoor = null) {
        if (specificDoor) {
            currentDoor = specificDoor;
        } else {
            for(let i=DOORS_START; i<=DOORS_END; i++) {
                if(doors[i].status === 'empty' && !doors[i].unavailable) {
                    currentDoor = i;
                    break;
                }
            }
        }

        if (!specificDoor && (!currentDoor || doors[currentDoor].status !== 'empty' || doors[currentDoor].unavailable)) {
             currentDoor = null;
             for(let i=DOORS_START; i<=DOORS_END; i++) {
                if(doors[i].status === 'empty' && !doors[i].unavailable) {
                    currentDoor = i;
                    break;
                }
            }
        }

        if(!currentDoor) return alert("No bays available!");

        byId('modal-door-num').innerText = currentDoor;

        const wId = byId('input-wally-id');
        if(wId) wId.value = '';
        const tId = byId('input-trailer-id');
        if(tId) tId.value = '';
        const aId = byId('input-account-id');
        if(aId) aId.value = '';

        const sel = byId('select-unloader');
        if(sel) sel.value = "";

        const cust = byId('input-custom-unloader');
        if(cust) {
            cust.style.display = 'none';
            cust.value = '';
        }

        const timeInput = byId('input-onboard-time');

        if (isFirstOnboard && lastSortStartTime) {
            timeInput.value = lastSortStartTime;
        } else {
            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            timeInput.value = `${h}:${m}`;
        }

        const formContainer = byId('onboard-form-container');
        const unavailableMsg = byId('unavailable-msg');
        const toggleBtn = byId('btn-toggle-availability');

        if (doors[currentDoor].unavailable) {
            formContainer.style.display = 'none';
            unavailableMsg.style.display = 'block';
            toggleBtn.innerText = "Mark Available";
            toggleBtn.style.background = "#34c759";
            toggleBtn.style.color = "white";
            toggleBtn.style.border = "none";
        } else {
            formContainer.style.display = 'block';
            unavailableMsg.style.display = 'none';
            toggleBtn.innerText = "Mark Unavailable";
            toggleBtn.style.background = "white";
            toggleBtn.style.color = "#ff3b30";
            toggleBtn.style.border = "2px solid #e5e5ea";
        }

        setType('Wally');
        byId('input-modal').style.display = 'flex';

        if (!doors[currentDoor].unavailable) {
            setTimeout(() => {
                const focusInput = byId('input-wally-id');
                if(focusInput && focusInput.offsetParent !== null) focusInput.focus();
            }, 100);
        }
    }

    // --- DOOR UNAVAILABLE LOGIC ---
    function toggleDoorAvailability(doorNum) {
        const door = doors[doorNum];

        if (door.status === 'active') {
            alert("Cannot mark an active bay as unavailable. Complete the trailer first.");
            return;
        }

        door.unavailable = !door.unavailable;
        saveData();
        renderDashboard();
        showSaveToast();
    }

    function handleAvailabilityToggle() {
        toggleDoorAvailability(currentDoor);
        closeModal('input-modal');
    }

    function setType(t) {
        currentType = t;
        const optWally = byId('opt-wally');
        const optCpu = byId('opt-cpu');
        const wallyInputs = byId('wally-inputs');
        const cpuInputs = byId('cpu-inputs');

        if(optWally) optWally.classList.toggle('selected', t === 'Wally');
        if(optCpu) optCpu.classList.toggle('selected', t === 'CPU');

        if (t === 'Wally') {
            if(wallyInputs) wallyInputs.style.display = 'block';
            if(cpuInputs) cpuInputs.style.display = 'none';
        } else {
            if(wallyInputs) wallyInputs.style.display = 'none';
            if(cpuInputs) cpuInputs.style.display = 'block';
        }
    }

    function viewStatLogs(type) {
        closeModal('input-modal');
        closeModal('active-detail-modal');

        activeLogFilter = { door: 'All', type: 'All', timeRange: 'All', unloader: 'All', search: '', date: 'All' };

        if (type === 'Wally') {
            activeLogFilter.type = 'Wally';
        } else if (type === 'CPU') {
            activeLogFilter.type = 'CPU';
        } else if (type === 'Hour-0') {
            activeLogFilter.timeRange = 'ThisHour';
            activeLogFilter.type = 'Wally';
        } else if (type === 'Hour-1') {
            activeLogFilter.timeRange = 'LastHour';
            activeLogFilter.type = 'Wally';
        }

        switchTab('logs');
    }

    function viewDoorLogs(doorNum) {
        closeModal('input-modal');
        closeModal('active-detail-modal');
        setLogFilter(doorNum);
        switchTab('logs');
    }

    function openFilterModal() {
        const g = byId('filter-grid');
        g.innerHTML = `<div class="filter-btn ${currentLogFilter==='All'?'active':''}" onclick="setLogFilter('All')">All</div>`;
        for(let i=DOORS_START; i<=DOORS_END; i++) {
             g.innerHTML += `<div class="filter-btn ${currentLogFilter==i?'active':''}" onclick="setLogFilter(${i})">Door ${i}</div>`;
        }

        const sel = byId('filter-unloader-select');
        if(sel) sel.value = activeLogFilter.unloader;

        const dateInput = byId('filter-date-input');
        if(activeLogFilter.date !== 'All') dateInput.value = activeLogFilter.date;
        else dateInput.value = '';

        byId('filter-modal').style.display='flex';
    }

    function applyFilter() {
        const sel = byId('filter-unloader-select');
        activeLogFilter.unloader = sel ? sel.value : 'All';

        const dateInput = byId('filter-date-input');
        activeLogFilter.date = dateInput && dateInput.value ? dateInput.value : 'All';

        closeModal('filter-modal');
        renderLogs();
    }

    function clearLogFilter() {
        currentLogFilter = 'All';
        activeLogFilter = { door: 'All', unloader: 'All', type: 'All', timeRange: 'All', search: '', date: 'All' };
        byId('log-search').value = '';
        renderLogs();
    }

    function setLogFilter(v) {
        currentLogFilter = v;
        activeLogFilter.door = v;
        renderLogs();
    }

    function toggleStats(section) {
        const c = byId(section === 'unloader' ? 'stats-content' : 'hourly-content');
        const i = byId(section === 'unloader' ? 'stats-caret' : 'hourly-caret');
        const show = c.style.display !== 'block';
        c.style.display = show ? 'block' : 'none';
        i.className = show ? 'ph ph-caret-up' : 'ph ph-caret-down';
        if(show) {
            if(section==='unloader') calculateAndRenderStats();
            else calculateAndRenderHourlyStats();
        }
    }

    function calculateAndRenderStats() {
         const stats = {};
         historyLog.forEach(l => {
             const n = l.unloader; if(!stats[n]) stats[n]={w:0,c:0,t:0};
             if(l.type==='Wally') stats[n].w++; else stats[n].c++; stats[n].t++;
         });
         const tbody = dom.unloaderStatsBody || byId('unloader-stats-body'); tbody.innerHTML='';
         Object.entries(stats).sort((a,b)=>b[1].t-a[1].t).forEach(([n,d]) => {
             tbody.innerHTML += `<tr><td>${n}</td><td style="text-align:center">${d.w}</td><td style="text-align:center">${d.c}</td><td style="text-align:right">${d.t}</td></tr>`;
         });
    }

    function calculateAndRenderHourlyStats() {
        const { shiftStart } = getShiftTimeWindows();
        const hourly = {};
        historyLog.forEach(l => {
            const effTime = l.end - (l.statOffset || 0);
            const idx = Math.floor((effTime - shiftStart.getTime())/3600000) + 1;
            if(!hourly[idx]) hourly[idx]=0; hourly[idx]++;
        });
        const tbody = dom.hourlyStatsBody || byId('hourly-stats-body'); tbody.innerHTML='';
        Object.keys(hourly).sort((a,b)=>a-b).forEach(h => {
             tbody.innerHTML += `<tr><td>${getHourText(parseInt(h,10))}</td><td style="text-align:center">${hourly[h]}</td></tr>`;
        });
    }

    // PHASE 1: Fragment-based DOM render (no UI changes)
    function renderLogs() {
        const list = dom.logsList || byId('logs-list');
        const filterDisplay = dom.filterDisplay || byId('active-filter-display');
        const filterText = dom.filterText || byId('filter-text-display');

        if (!list) return;

        const searchInput = dom.logSearch || byId('log-search');
        if (searchInput) activeLogFilter.search = searchInput.value.trim().toUpperCase();

        const now = Date.now();
        list.innerHTML = '';

        const isFiltering =
            activeLogFilter.door !== 'All' ||
            activeLogFilter.type !== 'All' ||
            activeLogFilter.timeRange !== 'All' ||
            activeLogFilter.unloader !== 'All' ||
            activeLogFilter.search !== '' ||
            activeLogFilter.date !== 'All';

        if (filterDisplay && filterText) {
            if (isFiltering) {
                filterDisplay.style.display = 'flex';
                const parts = [];
                if (activeLogFilter.date !== 'All') parts.push(`Date: ${activeLogFilter.date}`);
                if (activeLogFilter.door !== 'All') parts.push(`Door ${activeLogFilter.door}`);
                if (activeLogFilter.unloader !== 'All') parts.push(`${activeLogFilter.unloader}`);
                if (activeLogFilter.search !== '') parts.push(`"${activeLogFilter.search}"`);
                if (activeLogFilter.type !== 'All') parts.push(`${activeLogFilter.type}`);
                if (activeLogFilter.timeRange === 'ThisHour') parts.push(`This Hour`);
                if (activeLogFilter.timeRange === 'LastHour') parts.push(`Last Hour`);
                filterText.innerText = parts.join(' + ');
            } else {
                filterDisplay.style.display = 'none';
            }
        }

        const { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd } = getShiftTimeWindows();

        let filtered = historyLog.map((l, i) => ({ l, i }));

        filtered = filtered.filter(({ l }) => {
            if (!l.dateKey) l.dateKey = dateKeyFromTs(l.end);

            if (activeLogFilter.date !== 'All' && l.dateKey !== activeLogFilter.date) return false;
            if (activeLogFilter.door !== 'All' && l.door != activeLogFilter.door) return false;
            if (activeLogFilter.unloader !== 'All' && l.unloader !== activeLogFilter.unloader) return false;
            if (activeLogFilter.type !== 'All' && l.type !== activeLogFilter.type) return false;

            if (activeLogFilter.search !== '') {
                const term = activeLogFilter.search;
                const idMatch = (l.id || '').includes(term);
                const acctMatch = (l.account || '').includes(term);
                const doorMatch = String(l.door) === term;
                if (!idMatch && !acctMatch && !doorMatch) return false;
            }

            if (activeLogFilter.timeRange !== 'All') {
                const endTime = l.end - (l.statOffset || 0);
                if (activeLogFilter.timeRange === 'ThisHour') {
                    if (endTime < thisHourStart.getTime() || endTime >= thisHourEnd.getTime()) return false;
                } else if (activeLogFilter.timeRange === 'LastHour') {
                    if (endTime < lastHourStart.getTime() || endTime >= lastHourEnd.getTime()) return false;
                }
            }

            return true;
        });

        if (filtered.length === 0) {
            const empty = document.createElement('div');
            empty.style.cssText = 'text-align:center; color:#999; margin-top:20px;';
            empty.textContent = 'No logs found.';
            list.appendChild(empty);
            return;
        }

        const frag = document.createDocumentFragment();

        filtered.forEach(({ l, i }) => {
            if (!l.completionHour) l.completionHour = getCompletionHour(l.end - (l.statOffset || 0));

            const revertable = (now - l.end) < 120000;
            const durationMinutes = l.durationMinutes || Math.round((l.duration || 0) / 60000);

            const startDate = new Date(l.start);
            const endDate = new Date(l.end);
            const startTimeStr = startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTimeStr = endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const card = document.createElement('div');
            card.className = 'log-card';

            const info = document.createElement('div');
            info.className = 'log-info';

            const header = document.createElement('div');
            header.className = 'active-card-header';

            const doorPill = document.createElement('span');
            doorPill.className = 'log-door-pill';
            doorPill.textContent = `Door ${l.door}`;
            doorPill.addEventListener('click', () => viewDoorLogs(l.door));

            const typePill = document.createElement('span');
            typePill.className = 'log-type-pill';
            typePill.style.cssText = 'background:#000; color:#fff';
            typePill.textContent = l.type;

            header.appendChild(doorPill);
            header.appendChild(typePill);

            if (l.duplicate) {
                const dup = document.createElement('span');
                dup.className = 'log-type-pill';
                dup.style.cssText = 'background:#ff3b30; color:#fff; margin-left:6px;';
                dup.textContent = 'DUP';
                header.appendChild(dup);
            }

            const hourBadge = document.createElement('span');
            hourBadge.className = 'log-type-pill';
            hourBadge.style.cssText = 'background:#000; color:#fff; margin-left:6px;';
            hourBadge.textContent = getHourText(l.completionHour);
            header.appendChild(hourBadge);

            const title = document.createElement('div');
            title.className = 'log-title';
            title.appendChild(document.createTextNode(l.id || ''));

            if (l.account) {
                const acctSpan = document.createElement('span');
                acctSpan.style.cssText = 'color:#8e8e93; font-weight:400';
                acctSpan.textContent = ` (${l.account})`;
                title.appendChild(acctSpan);
            }

            const details = document.createElement('div');
            details.className = 'log-details';
            details.style.cssText = 'display:flex; justify-content:space-between; margin-top:4px;';

            const who = document.createElement('span');
            who.textContent = `ðŸ‘¤ ${l.unloader}`;

            const dur = document.createElement('span');
            dur.style.cssText = 'font-weight:700; color:#000;';
            dur.appendChild(document.createTextNode('Duration: '));

            const durStrong = document.createElement('span');
            durStrong.style.cssText = 'font-weight:800; color:#000;';
            durStrong.textContent = `${durationMinutes}m`;
            dur.appendChild(durStrong);

            details.appendChild(who);
            details.appendChild(dur);

            const ts = document.createElement('div');
            ts.className = 'log-timestamp';
            ts.style.cssText = 'margin-top:6px; color:#555;';
            ts.textContent = `${startTimeStr} - ${endTimeStr}`;

            info.appendChild(header);
            info.appendChild(title);
            info.appendChild(details);
            info.appendChild(ts);

            const actions = document.createElement('div');
            actions.className = 'log-actions';

            if (revertable) {
                const revertBtn = document.createElement('button');
                revertBtn.className = 'log-action-btn log-revert-btn';
                revertBtn.style.cssText = 'color:#000; border:1px solid #000;';
                revertBtn.innerHTML = `<i class="ph ph-arrow-u-up-left"></i> Revert`;
                revertBtn.addEventListener('click', () => revertLog(i));
                actions.appendChild(revertBtn);
            }

            const editBtn = document.createElement('button');
            editBtn.className = 'log-action-btn';
            editBtn.style.cssText = 'color:#000; border:1px solid #000;';
            editBtn.innerHTML = `<i class="ph ph-pencil-simple"></i> Edit`;
            editBtn.addEventListener('click', () => openEditLogModal(i));
            actions.appendChild(editBtn);

            card.appendChild(info);
            card.appendChild(actions);

            frag.appendChild(card);
        });

        list.appendChild(frag);

        if(statsVisible) calculateAndRenderStats();
        if(hourlyVisible) calculateAndRenderHourlyStats();
    }

    function revertLog(index) {
        const log = historyLog[index];
        if(!log) return;
        if(Date.now() - log.end > 120000 && !demoActive) return alert("Time expired");
        if(doors[log.door].status !== 'empty') return alert("Door occupied");

        doors[log.door] = {
            status: 'active',
            start: log.start,
            id: log.id,
            account: log.account,
            type: log.type,
            unloader: log.unloader,
            unavailable: false,
            lastCompletionTime: null
        };
        historyLog.splice(index, 1);
        saveData();
        renderDashboard();
        renderLogs();
        updateTabBadges();
    }

    function openEditLogModal(i) {
        const l = historyLog[i];
        byId('edit-log-index').value = i;
        byId('edit-input-id').value = l.id;

        const sel = byId('edit-select-unloader');
        sel.innerHTML='<option value="">Unassigned</option>';

        // PHASE 1: Use pre-sorted names (no mutation)
        teamNamesSorted.forEach(n => {
            const o=document.createElement('option');
            o.value=n;
            o.innerText=n;
            sel.appendChild(o);
        });
        sel.value = l.unloader;

        byId('edit-opt-wally').classList.toggle('selected', l.type === 'Wally');
        byId('edit-opt-cpu').classList.toggle('selected', l.type === 'CPU');
        byId('edit-log-modal').dataset.type = l.type;

        byId('edit-log-modal').style.display='flex';
    }

    function confirmLogEdit() {
        const idx = parseInt(byId('edit-log-index').value);
        const newId = byId('edit-input-id').value.toUpperCase();
        const newUnloader = byId('edit-select-unloader').value;

        historyLog[idx].id = newId;
        historyLog[idx].unloader = newUnloader;
        historyLog[idx].type = byId('edit-log-modal').dataset.type;
        historyLog[idx].completionHour = getCompletionHour(historyLog[idx].end - (historyLog[idx].statOffset || 0));
        if (!historyLog[idx].dateKey) historyLog[idx].dateKey = dateKeyFromTs(historyLog[idx].end);

        saveData();
        closeModal('edit-log-modal');
        renderLogs();
    }

    function openExportModal() {
        byId('export-modal').style.display = 'flex';
    }

    function exportLogsCSV() {
        closeModal('export-modal');
        let csv = "Type,ID,Account,Door,Unloader,Duration(mins),StartTime,EndTime,StartHour,EndHour,Duplicate,Hour\n";
        historyLog.forEach(l => {
             csv += `${l.type},${l.id},${l.account||''},${l.door},${l.unloader},${Math.round(l.duration/60000)},${new Date(l.start).toLocaleString()},${new Date(l.end).toLocaleString()},${new Date(l.start).getHours()},${new Date(l.end).getHours()},${l.duplicate ? 'Yes' : 'No'},${l.completionHour}\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='wally-logs.csv'; a.click();
    }

    function exportLogsPDF() {
        closeModal('export-modal');
        try {
            if (!window.jspdf) throw new Error("PDF library not loaded");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            doc.setFontSize(18);
            doc.text(`PS9 Wally Tracker Report - ${dateString}`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Generated: ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`, 14, 30);

            const stats = {};
            historyLog.forEach(l => {
                 const n = l.unloader; if(!stats[n]) stats[n]={w:0,c:0,t:0};
                 if(l.type==='Wally') stats[n].w++; else stats[n].c++; stats[n].t++;
            });
            const statsBody = Object.entries(stats).sort((a,b)=>b[1].t-a[1].t).map(([n,d]) => [n, d.w, d.c, d.t]);

            doc.text("Unloader Statistics", 14, 45);
            doc.autoTable({
                startY: 50,
                head: [['Name', 'Wally', 'CPU', 'Total']],
                body: statsBody,
                theme: 'striped'
            });

            const { shiftStart } = getShiftTimeWindows();
            const hourly = {};
            historyLog.forEach(l => {
                if (l.type !== 'Wally') return;
                const effTime = l.end - (l.statOffset || 0);
                const idx = Math.floor((effTime - shiftStart.getTime())/3600000) + 1;
                if(!hourly[idx]) hourly[idx]=0; hourly[idx]++;
            });
            const hourlyBody = Object.keys(hourly).sort((a,b)=>a-b).map(h => [getHourText(parseInt(h,10)), hourly[h]]);

            let finalY = doc.lastAutoTable.finalY + 15;
            doc.text("Hourly Breakdown (Wallies Only)", 14, finalY);
            doc.autoTable({
                startY: finalY + 5,
                head: [['Hour', 'Count']],
                body: hourlyBody,
                theme: 'striped'
            });

            finalY = doc.lastAutoTable.finalY + 15;
            doc.text("Detailed Logs", 14, finalY);

            const logsBody = historyLog.map(l => [
                new Date(l.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                l.door,
                l.type + (l.duplicate ? ' (DUP)' : ''),
                l.id,
                l.unloader,
                Math.round(l.duration/60000) + "m",
                getHourText(l.completionHour)
            ]);

            doc.autoTable({
                startY: finalY + 5,
                head: [['Time', 'Door', 'Type', 'ID', 'Unloader', 'Duration', 'Hour']],
                body: logsBody,
                theme: 'striped'
            });

            doc.save(`wally-report-${now.toISOString().split('T')[0]}.pdf`);
        } catch (e) {
            alert("Error generating PDF. Please ensure internet connection is active to load PDF libraries.");
            console.error(e);
        }
    }

    function saveData() {
        localStorage.setItem('ps9_doors', JSON.stringify(doors));
        localStorage.setItem('ps9_history', JSON.stringify(historyLog));
        localStorage.setItem('ps9_team', JSON.stringify(teamNames));
        localStorage.setItem('ps9_accounts', JSON.stringify(savedAccounts));
        localStorage.setItem('ps9_staffing', JSON.stringify(staffing));
        localStorage.setItem('ps9_dop', currentDOP);
    }

    // --- PPH CALCULATOR FUNCTIONS ---
    function openPPHModal() {
        const hours = calculateUnloaderHours();
        const input = byId('pph-unloader-hours-input');
        input.value = hours > 0 ? hours.toFixed(2) : '';

        byId('pph-volume-input').value = '';
        byId('pph-result').innerText = '0';
        byId('pph-modal').style.display = 'flex';

        if (hours > 0) {
            setTimeout(() => byId('pph-volume-input').focus(), 100);
        } else {
            setTimeout(() => input.focus(), 100);
        }
    }

    function resetPPH() {
        const hours = calculateUnloaderHours();
        const input = byId('pph-unloader-hours-input');
        input.value = hours > 0 ? hours.toFixed(2) : '';

        byId('pph-volume-input').value = '';
        byId('pph-result').innerText = '0';

        if (hours === 0) input.focus();
        else byId('pph-volume-input').focus();
    }

    function calculateUnloaderHours() {
        const now = Date.now();
        let totalMs = 0;

        staffing.forEach(s => {
            if (s.role === 'Unloader') {
                let ms = (s.accumulated || 0);
                if (s.status === 'active' && s.start) {
                    ms += (now - s.start);
                }
                totalMs += ms;
            }
        });

        return totalMs / 3600000;
    }

    function calculatePPH() {
        const vol = parseFloat(byId('pph-volume-input').value) || 0;
        const hours = parseFloat(byId('pph-unloader-hours-input').value) || 0;

        if (hours === 0) {
            byId('pph-result').innerText = "0";
            return;
        }

        const pph = Math.round(vol / hours);
        byId('pph-result').innerText = pph.toLocaleString();
    }

    function setEditType(t) {
        byId('edit-opt-wally').classList.toggle('selected', t === 'Wally');
        byId('edit-opt-cpu').classList.toggle('selected', t === 'CPU');
        byId('edit-log-modal').dataset.type = t;
    }

    init();
</script>
</body>
</html>