<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WallyTracker">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Wally Dashboard</title>

    <style>
        :root {
            --primary: #000000;
            --bg: #ffffff;
            --card-bg: #f9f9f9;
            --text-main: #000000;
            --text-sub: #8e8e93;
            --safe-top: max(env(safe-area-inset-top), 20px);
            --safe-bottom: env(safe-area-inset-bottom);
            --tab-height: 65px;
            
            --bay-green: #4cd964;
            --bay-purple: #bf5af2;
            --bay-orange: #ff9500;
            --bay-red: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- MAIN VIEWPORT --- */
        .app-content-view {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: calc(var(--safe-top) + 10px);
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        .tab-content { display: none; padding: 0 16px; animation: fadeIn 0.2s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- TAB BAR --- */
        .tab-bar {
            height: calc(var(--tab-height) + var(--safe-bottom));
            background: white;
            border-top: 1px solid #e5e5ea;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 10px;
            flex-shrink: 0;
            z-index: 1000;
        }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 10px; font-weight: 600; width: 60px; cursor: pointer; gap: 4px; position: relative; }
        .tab-btn i { font-size: 24px; }
        .tab-btn.active { color: #000; }
        .tab-badge { position: absolute; top: -2px; right: 10px; background: #ff3b30; color: white; font-size: 9px; font-weight: 800; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 3px; border: 2px solid white; }
        .tab-badge.zero { display: none; }

        /* --- DASHBOARD ELEMENTS --- */
        .dash-header { text-align: center; margin-bottom: 12px; }
        .dash-title { font-size: 20px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
        .dash-version { font-size: 10px; color: #ccc; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

        .today-card {
            background: #fff; border: 1px solid #e5e5ea; border-radius: 16px; padding: 12px;
            margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .today-title { font-size: 13px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        
        .focus-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .focus-item:last-child { border-bottom: none; }
        .focus-check { width: 20px; height: 20px; border-radius: 5px; border: 2px solid #e5e5ea; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; font-size: 12px; }
        .focus-item.done .focus-check { background: #000; border-color: #000; }
        .focus-label { font-size: 11px; font-weight: 800; color: #8e8e93; text-transform: uppercase; min-width: 85px; }
        .focus-name { font-size: 14px; font-weight: 600; color: #000; flex: 1; }
        .focus-item.done .focus-name { color: #ccc; text-decoration: line-through; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .action-card { background: #f2f2f7; border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; border: 1px solid transparent; }
        .action-card.primary { background: #000; color: white; }
        .action-card.danger { background: #ffe5e5; color: #ff3b30; }
        .action-label { font-size: 12px; font-weight: 700; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-card { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 8px 12px; display: flex; flex-direction: column; justify-content: center; }
        .stat-label { font-size: 9px; color: #8e8e93; font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: 900; color: #000; line-height: 1.1; }

        .bays-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .bay-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; position: relative; }
        .bay-circle.status-ok { border: 3px solid #34c759; }
        .bay-circle.status-warn { border: 3px solid #ff9500; }
        .bay-circle.status-crit { border: 3px solid #ff3b30; }

        /* --- STAFFING --- */
        .staff-card { background: white; border: 1px solid #e5e5ea; border-radius: 14px; padding: 12px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 6px; }
        .staff-name { font-size: 15px; font-weight: 700; }
        .staff-hours { font-size: 14px; font-weight: 800; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 25px; padding-bottom: max(30px, var(--safe-bottom)); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-input { width: 100%; padding: 14px; background: #f2f2f7; border: none; border-radius: 12px; font-size: 16px; margin-bottom: 12px; }
        
        .planner-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f2f2f7; }
        .planner-label { font-size: 12px; font-weight: 800; color: #8e8e93; text-transform: uppercase; }
        .planner-select-row { display: flex; gap: 10px; }
        .planner-select { flex: 1; padding: 12px; border-radius: 10px; border: none; background: #f2f2f7; font-weight: 600; }
        .planner-custom { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ccc; display: none; }

        .checklist-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; cursor: pointer; }
        .checklist-box { width: 22px; height: 22px; border: 2px solid #e5e5ea; border-radius: 6px; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: white; }
        .checklist-item.checked .checklist-box { background: #000; border-color: #000; }

        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tool-card { background: #fff; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid #e5e5ea; }
        .tool-icon-wrapper { width: 44px; height: 44px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 10px; }
        .tool-title { font-size: 14px; font-weight: 700; }
    </style>
</head>
<body>

<div id="save-toast" class="save-toast"><i class="ph ph-check-circle"></i> <span>Saved</span></div>

<div class="app-container">
    <div class="app-content-view">
        
        <div id="tab-dashboard" class="tab-content active">
            <div class="dash-header">
                <h1 class="dash-title">Wally Dashboard</h1>
                <div class="dash-version">by Fitz Joseph â€¢ Version 3.58</div>
            </div>

            <div class="today-card">
                <div class="today-title"><i class="ph ph-calendar-check"></i> Today</div>
                <div id="dashboard-today-list" class="focus-list">
                    <div class="today-empty">Set assignments in Tools</div>
                </div>
            </div>

            <div class="action-grid">
                <div class="action-card primary" onclick="openStartSortFlow()">
                    <i class="ph ph-play-circle"></i><span class="action-label">Start Sort</span>
                </div>
                <div class="action-card danger" onclick="openEndSortFlow()">
                    <i class="ph ph-stop-circle"></i><span class="action-label">End Sort</span>
                </div>
            </div>

            <div class="section-header">Shift Stats</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="switchTab('logs')">
                    <div class="stat-label">Wallies</div>
                    <div class="stat-value" id="stat-total-wally">0</div>
                </div>
                <div class="stat-card" onclick="switchTab('logs')">
                    <div class="stat-label">CPUs</div>
                    <div class="stat-value" id="stat-total-cpu">0</div>
                </div>
                <div class="stat-card" onclick="switchTab('logs')">
                    <div class="stat-label">This Hour</div>
                    <div class="stat-value" id="stat-hour-wally">0</div>
                </div>
                <div class="stat-card" onclick="switchTab('logs')">
                    <div class="stat-label">Last Hour</div>
                    <div class="stat-value" id="stat-last-wally">0</div>
                </div>
            </div>

            <div class="section-header">Doors</div>
            <div id="active-trailers-grid" class="bays-grid"></div>
            <div id="open-bays-grid" class="bays-grid"></div>
        </div>

        <div id="tab-active" class="tab-content">
            <div class="header-bar"><h1>Active Details</h1></div>
            <div id="active-tab-list"></div>
        </div>

        <div id="tab-logs" class="tab-content">
            <div class="header-bar">
                <h1>Logs</h1>
                <div class="header-right">
                    <button class="export-icon-btn" onclick="openExportModal()"><i class="ph ph-export"></i></button>
                </div>
            </div>
            <input type="text" id="log-search" class="form-input" placeholder="Search Wally ID or Trailer...">
            <div id="logs-list"></div>
        </div>

        <div id="tab-staffing" class="tab-content">
            <div class="header-bar">
                <h1>Staffing</h1>
                <div class="header-right">
                    <button class="action-btn" style="height:32px; padding:0 12px;" onclick="openAddStaffModal()"><i class="ph ph-plus"></i></button>
                </div>
            </div>
            <div class="dop-container">
                <div class="dop-row">
                    <span class="dop-label">DOP Plan</span>
                    <select id="dop-select" class="dop-select" onchange="saveDOP(this.value)">
                        <option value="5-2">5-2</option><option value="6-2">6-2</option><option value="7-2">7-2</option><option value="8-2">8-2</option>
                    </select>
                </div>
                <div id="dop-status-bar" class="dop-status">Checking...</div>
            </div>
            <div id="staff-list-active"></div>
            <div id="staff-list-loaned"></div>
        </div>

        <div id="tab-tools" class="tab-content">
            <div class="header-bar"><h1>Tools</h1></div>
            <div class="tools-grid">
                <div class="tool-card" onclick="openTodayPlanner()">
                    <div class="tool-icon-wrapper"><i class="ph ph-calendar-plus"></i></div>
                    <div class="tool-title">Today's Planner</div>
                </div>
                <div class="tool-card" onclick="openPPHModal()">
                    <div class="tool-icon-wrapper"><i class="ph ph-calculator"></i></div>
                    <div class="tool-title">PPH Calc</div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="header-bar"><h1>Settings</h1></div>
            <div class="settings-header">Management</div>
            <div class="settings-group">
                <div class="settings-row" onclick="backupData('full')"><span>Backup Full Data</span><i class="ph ph-download-simple"></i></div>
                <div class="settings-row" onclick="resetData()"><span style="color:#ff3b30">Factory Reset</span></div>
            </div>
        </div>

    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('dashboard', this)"><i class="ph ph-squares-four"></i><span>Home</span></button>
        <button class="tab-btn" onclick="switchTab('active', this)"><i class="ph ph-truck-trailer"></i><span>Active</span><span class="tab-badge" id="badge-active">0</span></button>
        <button class="tab-btn" onclick="switchTab('logs', this)"><i class="ph ph-list-dashes"></i><span>Logs</span></button>
        <button class="tab-btn" onclick="switchTab('staffing', this)"><i class="ph ph-users"></i><span>Staffing</span><span class="tab-badge" id="badge-staffing">0</span></button>
        <button class="tab-btn" onclick="switchTab('tools', this)"><i class="ph ph-toolbox"></i><span>Tools</span></button>
        <button class="tab-btn" onclick="switchTab('settings', this)"><i class="ph ph-gear"></i><span>Settings</span></button>
    </nav>
</div>

<div class="modal-overlay" id="today-planner-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center; margin-bottom:20px;">Today's Planner</h2>
        
        <div id="planner-items-container">
            <div class="planner-row">
                <div class="planner-label">SWM Assignment</div>
                <div class="planner-select-row">
                    <select id="plan-swm-select" class="planner-select" onchange="checkPlannerCustom('SWM')"></select>
                    <input type="text" id="plan-swm-custom" class="planner-custom" placeholder="Name">
                </div>
            </div>
            <div class="planner-row">
                <div class="planner-label">OJS Assignment</div>
                <div class="planner-select-row">
                    <select id="plan-ojs-select" class="planner-select" onchange="checkPlannerCustom('OJS')"></select>
                    <input type="text" id="plan-ojs-custom" class="planner-custom" placeholder="Name">
                </div>
            </div>
            <div class="planner-row">
                <div class="planner-label">Observation Assignment</div>
                <div class="planner-select-row">
                    <select id="plan-obs-select" class="planner-select" onchange="checkPlannerCustom('OBS')"></select>
                    <input type="text" id="plan-obs-custom" class="planner-custom" placeholder="Name">
                </div>
            </div>
            <div class="planner-row">
                <div class="planner-label">Compliance Assignment</div>
                <div class="planner-select-row">
                    <select id="plan-comp-select" class="planner-select" onchange="checkPlannerCustom('Compliance')"></select>
                    <input type="text" id="plan-comp-custom" class="planner-custom" placeholder="Name">
                </div>
            </div>
        </div>

        <button class="btn-primary" onclick="saveTodayPlanner()">Save Planner</button>
        <button class="btn-cancel" onclick="closeModal('today-planner-modal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="post-sort-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center; margin-bottom:20px;">Post-Sort Checklist</h2>
        <div id="post-sort-list"></div>
        <button class="btn-primary" onclick="closeModal('post-sort-modal')">Finish & Close</button>
    </div>
</div>

<div class="modal-overlay" id="input-modal">
    <div class="modal-sheet">
        <h2 style="margin-bottom:15px;">Onboard Bay <span id="modal-door-num"></span></h2>
        <div class="type-selector">
            <div class="type-opt selected" id="opt-wally" onclick="setArrivalType('Wally')">Wally</div>
            <div class="type-opt" id="opt-cpu" onclick="setArrivalType('CPU')">CPU</div>
        </div>
        <input type="text" id="input-arrival-id" class="form-input" placeholder="ID / Trailer #">
        <select id="select-arrival-unloader" class="form-input"></select>
        <button class="btn-primary" onclick="confirmArrival()">Start Unload</button>
        <button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="active-detail-modal">
    <div class="modal-sheet">
        <h2>Active Bay <span id="detail-door-num"></span></h2>
        <div id="detail-content" style="margin-bottom:20px; font-size:14px;"></div>
        <button class="btn-primary" style="background:#ff3b30;" onclick="completeDoor()">Complete Unload</button>
        <button class="btn-cancel" onclick="closeModal('active-detail-modal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="add-staff-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center;">Clock In Staff</h2>
        <div id="staff-checkbox-list" style="margin: 15px 0;"></div>
        <button class="btn-primary" onclick="confirmAddStaff()">Clock In</button>
        <button class="btn-cancel" onclick="closeModal('add-staff-modal')">Cancel</button>
    </div>
</div>

<script>
    // --- STATE ---
    let doors = {}, historyLog = [], teamNames = [], staffing = [], currentDOP = '5-2';
    let todayPlanner = { date: '', SWM: { name: '', done: false }, OJS: { name: '', done: false }, OBS: { name: '', done: false }, Compliance: { name: '', done: false } };
    
    const DOORS_START = 9, DOORS_END = 16;
    const DEFAULT_TEAM = ["David F", "Lorena R", "Matt R", "Matt S", "Robert W", "Trevon C", "Victor M", "Russell H", "Fonseca J"];

    // --- UTILS ---
    const byId = (id) => document.getElementById(id);
    function showToast() { const t = byId('save-toast'); t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'), 2000); }
    function closeModal(id) { byId(id).style.display = 'none'; }
    function getShiftTimeWindows() {
        const now = new Date(); let start = new Date(now); start.setHours(19, 55, 0, 0);
        if (now < start) start.setDate(start.getDate() - 1);
        const hoursElapsed = Math.floor((now - start) / 3600000);
        const thisHourStart = new Date(start.getTime() + (hoursElapsed * 3600000));
        return { thisHourStart, thisHourEnd: new Date(thisHourStart.getTime() + 3600000), lastHourStart: new Date(thisHourStart.getTime() - 3600000), lastHourEnd: thisHourStart, shiftStart: start };
    }

    // --- INIT ---
    function init() {
        if(localStorage.getItem('ps9_doors')) doors = JSON.parse(localStorage.getItem('ps9_doors'));
        else for(let i=DOORS_START; i<=DOORS_END; i++) doors[i] = { status: 'empty', start: 0, assignments: [] };
        
        if(localStorage.getItem('ps9_history')) historyLog = JSON.parse(localStorage.getItem('ps9_history'));
        if(localStorage.getItem('ps9_team')) teamNames = JSON.parse(localStorage.getItem('ps9_team')); else teamNames = [...DEFAULT_TEAM];
        if(localStorage.getItem('ps9_staffing')) staffing = JSON.parse(localStorage.getItem('ps9_staffing'));
        if(localStorage.getItem('ps9_dop')) currentDOP = localStorage.getItem('ps9_dop');

        loadPlanner();
        renderDashboard();
        updateTabBadges();
    }

    // --- PLANNER LOGIC ---
    function loadPlanner() {
        const saved = localStorage.getItem('ps9_today_planner');
        const todayStr = new Date().toDateString();
        if(saved) {
            todayPlanner = JSON.parse(saved);
            if(todayPlanner.date !== todayStr) resetPlanner(todayStr);
        } else resetPlanner(todayStr);
        renderPlannerUI();
    }

    function resetPlanner(date) {
        todayPlanner = { date, SWM: { name: '', done: false }, OJS: { name: '', done: false }, OBS: { name: '', done: false }, Compliance: { name: '', done: false } };
        localStorage.setItem('ps9_today_planner', JSON.stringify(todayPlanner));
    }

    function openTodayPlanner() {
        const categories = ['SWM', 'OJS', 'OBS', 'Compliance'];
        categories.forEach(cat => {
            const sel = byId(`plan-${cat.toLowerCase().substring(0,3)}-select`) || byId(`plan-${cat.toLowerCase()}-select`);
            sel.innerHTML = '<option value="">Unassigned</option>';
            teamNames.sort().forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
            sel.innerHTML += '<option value="Custom">Custom Name</option>';
            
            const currentName = todayPlanner[cat].name;
            if(currentName && !teamNames.includes(currentName)) {
                sel.value = "Custom";
                const inp = sel.nextElementSibling;
                inp.style.display = 'block'; inp.value = currentName;
            } else {
                sel.value = currentName;
            }
        });
        byId('today-planner-modal').style.display = 'flex';
    }

    function checkPlannerCustom(cat) {
        const prefix = cat === 'Compliance' ? 'comp' : cat.toLowerCase();
        const sel = byId(`plan-${prefix}-select`);
        const inp = sel.nextElementSibling;
        inp.style.display = (sel.value === 'Custom') ? 'block' : 'none';
    }

    function saveTodayPlanner() {
        const cats = ['SWM', 'OJS', 'OBS', 'Compliance'];
        cats.forEach(cat => {
            const prefix = cat === 'Compliance' ? 'comp' : cat.toLowerCase();
            const sel = byId(`plan-${prefix}-select`);
            const inp = sel.nextElementSibling;
            todayPlanner[cat].name = (sel.value === 'Custom') ? inp.value.trim() : sel.value;
        });
        localStorage.setItem('ps9_today_planner', JSON.stringify(todayPlanner));
        renderPlannerUI();
        closeModal('today-planner-modal');
        showToast();
    }

    function renderPlannerUI() {
        const list = byId('dashboard-today-list');
        list.innerHTML = '';
        const cats = ['Observation', 'OJS', 'SWM', 'Compliance'];
        let count = 0;

        cats.forEach(cat => {
            const key = cat === 'Observation' ? 'OBS' : cat;
            const data = todayPlanner[key];
            if(data.name) {
                count++;
                const div = document.createElement('div');
                div.className = `focus-item ${data.done ? 'done' : ''}`;
                div.innerHTML = `
                    <div class="focus-check" onclick="toggleTask('${key}')"><i class="ph ph-check"></i></div>
                    <div class="focus-content">
                        <div class="focus-label">${cat}</div>
                        <div class="focus-name">${data.name}</div>
                    </div>
                `;
                list.appendChild(div);
            }
        });

        if(count === 0) list.innerHTML = '<div class="today-empty">Set assignments in Tools</div>';
    }

    function toggleTask(key) {
        todayPlanner[key].done = !todayPlanner[key].done;
        localStorage.setItem('ps9_today_planner', JSON.stringify(todayPlanner));
        renderPlannerUI();
    }

    // --- END SORT ---
    function openEndSortFlow() {
        const totalW = byId('stat-total-wally').innerText;
        const totalC = byId('stat-total-cpu').innerText;
        const summary = `Sort Summary - ${new Date().toLocaleDateString()}\nTotal Wallies: ${totalW}\nTotal CPUs: ${totalC}\nGenerated by WallyTracker`;
        
        if(navigator.share) {
            navigator.share({ text: summary }).then(()=>openPostSortChecklist());
        } else {
            alert(summary);
            openPostSortChecklist();
        }
    }

    function openPostSortChecklist() {
        const list = byId('post-sort-list');
        const items = ["Check Slide", "Check Payroll", "Walk Wall", "Enter Obs/OJS/SWM", "Return Scanner", "Sign Walk-off", "Return Gear", "Add Numbers on Board"];
        list.innerHTML = '';
        items.forEach(i => {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.onclick = function() { this.classList.toggle('checked'); };
            div.innerHTML = `<div class="checklist-box"><i class="ph ph-check"></i></div><div class="checklist-label">${i}</div>`;
            list.appendChild(div);
        });
        byId('post-sort-modal').style.display = 'flex';
    }

    // --- SYSTEM LOGIC ---
    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        byId(`tab-${id}`).classList.add('active');
        if(btn) btn.classList.add('active');
        if(id==='dashboard') renderDashboard();
        if(id==='staffing') renderStaffing();
        if(id==='logs') renderLogs();
    }

    function renderDashboard() {
        const { thisHourStart, thisHourEnd, lastHourStart, lastHourEnd } = getShiftTimeWindows();
        let tw=0, tc=0, hw=0, lhw=0;
        historyLog.forEach(l => {
            const t = l.end - (l.statOffset || 0);
            if(l.type === 'Wally') { tw++; if(t >= thisHourStart.getTime()) hw++; else if(t >= lastHourStart.getTime()) lhw++; }
            else tc++;
        });
        byId('stat-total-wally').innerText = tw; byId('stat-total-cpu').innerText = tc;
        byId('stat-hour-wally').innerText = hw; byId('stat-last-wally').innerText = lhw;

        const ag = byId('active-trailers-grid'), og = byId('open-bays-grid');
        ag.innerHTML = ''; og.innerHTML = '';
        for(let i=DOORS_START; i<=DOORS_END; i++) {
            const d = doors[i];
            const div = document.createElement('div');
            div.className = `bay-circle bay-${i} ${d.unavailable?'unavailable':''}`;
            if(d.status==='active') {
                div.innerHTML = `${i}<div class="type-badge">${d.type==='Wally'?'W':'C'}</div>`;
                const mins = (Date.now()-d.start)/60000;
                div.classList.add(mins > 60 ? 'status-crit' : (mins > 45 ? 'status-warn' : 'status-ok'));
                ag.appendChild(div);
                div.onclick = () => openActiveDetails(i);
            } else {
                div.innerText = i;
                og.appendChild(div);
                div.onclick = () => openArrivalModal(i);
            }
        }
    }

    function updateTabBadges() {
        const activeCount = Object.values(doors).filter(d => d.status === 'active').length;
        const staffCount = staffing.filter(s => s.status === 'active' || s.status === 'paused').length;
        byId('badge-active').innerText = activeCount; byId('badge-active').classList.toggle('zero', activeCount === 0);
        byId('badge-staffing').innerText = staffCount; byId('badge-staffing').classList.toggle('zero', staffCount === 0);
    }

    // --- (Remaining logic for modals and logs remains consistent with previous version) ---
    function openArrivalModal(i) {
        currentDoor = i;
        byId('modal-door-num').innerText = i;
        const sel = byId('select-arrival-unloader');
        sel.innerHTML = '<option value="">Unassigned</option>';
        staffing.filter(s=>s.status==='active').forEach(s => sel.innerHTML += `<option value="${s.name}">${s.name}</option>`);
        byId('input-arrival-id').value = '';
        byId('input-modal').style.display = 'flex';
    }
    
    function setArrivalType(t) {
        currentType = t;
        byId('opt-wally').classList.toggle('selected', t==='Wally');
        byId('opt-cpu').classList.toggle('selected', t==='CPU');
    }

    function confirmArrival() {
        const id = byId('input-arrival-id').value.toUpperCase();
        if(!id) return alert("ID Required");
        doors[currentDoor] = { status:'active', start:Date.now(), id, type:currentType, unloader:byId('select-arrival-unloader').value };
        localStorage.setItem('ps9_doors', JSON.stringify(doors));
        closeModal('input-modal'); renderDashboard(); updateTabBadges();
    }

    function openActiveDetails(i) {
        detailDoor = i;
        const d = doors[i];
        byId('detail-door-num').innerText = i;
        byId('detail-content').innerHTML = `Type: ${d.type}<br>ID: ${d.id}<br>Unloader: ${d.unloader || 'None'}<br>Started: ${new Date(d.start).toLocaleTimeString()}`;
        byId('active-detail-modal').style.display = 'flex';
    }

    function completeDoor() {
        const d = doors[detailDoor];
        historyLog.unshift({ door: detailDoor, id: d.id, type: d.type, unloader: d.unloader || 'Unknown', end: Date.now(), start: d.start });
        localStorage.setItem('ps9_history', JSON.stringify(historyLog));
        doors[detailDoor] = { status: 'empty', start: 0, assignments: [] };
        localStorage.setItem('ps9_doors', JSON.stringify(doors));
        closeModal('active-detail-modal'); renderDashboard(); updateTabBadges(); showToast();
    }

    function renderStaffing() {
        const list = byId('staff-list-active');
        list.innerHTML = '';
        staffing.forEach(s => {
            if(s.status !== 'cut') {
                const div = document.createElement('div');
                div.className = 'staff-card';
                div.innerHTML = `<div class="staff-top-row"><div class="staff-name">${s.name}</div><div class="staff-hours">${s.role}</div></div>`;
                list.appendChild(div);
            }
        });
    }

    function renderLogs() {
        const list = byId('logs-list');
        list.innerHTML = '';
        historyLog.forEach(l => {
            const div = document.createElement('div');
            div.className = 'log-card';
            div.innerHTML = `<div class="log-info"><div class="log-header-row"><span class="log-door-pill">Door ${l.door}</span><span class="log-title">${l.id}</span></div><div class="log-footer-row"><span>${l.unloader}</span></div></div><div class="log-right-col"><div class="log-duration">${Math.round((l.end-l.start)/60000)}m</div></div>`;
            list.appendChild(div);
        });
    }

    function openAddStaffModal() {
        const container = byId('staff-checkbox-list');
        container.innerHTML = '';
        teamNames.sort().forEach(n => {
            if(!staffing.find(s=>s.name===n && s.status!=='cut')) {
                container.innerHTML += `<div class="staff-item-row"><label class="staff-check-label"><input type="checkbox" value="${n}" class="staff-checkbox"> ${n}</label></div>`;
            }
        });
        byId('add-staff-modal').style.display = 'flex';
    }

    function confirmAddStaff() {
        const cbs = document.querySelectorAll('.staff-checkbox:checked');
        cbs.forEach(cb => staffing.push({ name: cb.value, status: 'active', role: 'Unloader', start: Date.now() }));
        localStorage.setItem('ps9_staffing', JSON.stringify(staffing));
        closeModal('add-staff-modal'); renderStaffing(); updateTabBadges();
    }

    function resetData() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }
    function backupData() { alert("Data backup ready in console (JSON)"); console.log(JSON.stringify(localStorage)); }

    init();
</script>
</body>
</html>
